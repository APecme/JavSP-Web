<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>JavSP-Web 控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/xterm.css" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #020617; color: #e5e7eb; }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; height: 100vh; }
    .sidebar { background: #020617; border-right: 1px solid #1f2937; padding: 16px 14px; display: flex; flex-direction: column; gap: 16px; position: sticky; top: 0; align-self: start; height: 100vh; overflow-y: auto; }
    .brand { font-weight: 600; font-size: 18px; }
    .version { font-size: 11px; color: #6b7280; margin-top: 2px; }
    .nav { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }
    .nav-btn { border-radius: 999px; padding: 7px 10px; border: none; background: transparent; color: #9ca3af; text-align: left; font-size: 13px; cursor: pointer; }
    .nav-btn.active { background: linear-gradient(135deg,#3b82f6,#6366f1); color: #f9fafb; }
    .nav-btn:hover { background: #111827; color: #e5e7eb; }
    .nav-section-title { font-size: 11px; color: #6b7280; margin-top: 12px; margin-bottom: 4px; }
    .bottom { margin-top: auto; font-size: 12px; color: #6b7280; display: flex; flex-direction: column; gap: 8px; }
    .link { color: #9ca3af; text-decoration: none; }
    .link:hover { color: #e5e7eb; }
    .project-links { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
    .project-links a { font-size: 11px; }
    .logout-btn { border-radius: 999px; border: 1px solid #374151; padding: 6px 10px; background: transparent; color: #e5e7eb; font-size: 12px; cursor: pointer; align-self: flex-start; }
    .logout-btn:hover { background: #111827; }

    .content { padding: 18px 20px; background: radial-gradient(circle at top left, rgba(59,130,246,.15), transparent 55%), #020617; height: 100vh; overflow-y: auto; }
    .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .content-title { font-size: 20px; font-weight: 600; }
    .content-subtitle { font-size: 12px; color: #9ca3af; margin-top: 4px; }
    .pill { padding: 3px 8px; border-radius: 999px; border: 1px solid #374151; font-size: 10px; color: #9ca3af; }

    .panel { border-radius: 14px; border: 1px solid #1f2937; background: rgba(15,23,42,0.95); padding: 16px 16px 18px; margin-top: 10px; }
    .panel-title { font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    .panel-desc { font-size: 12px; color: #9ca3af; margin-bottom: 12px; }
    .placeholder { font-size: 12px; color: #6b7280; }

    .tabs { display: flex; gap: 6px; margin-top: 10px; margin-bottom: 8px; font-size: 12px; }
    .tab-pill { padding: 4px 10px; border-radius: 999px; border: 1px solid #374151; cursor: pointer; color: #9ca3af; background: transparent; }
    .tab-pill.active { background: #111827; color: #e5e7eb; }

    .grid-two { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 14px; margin-top: 10px; }
    .field { min-width: 0; }
    .field label { display: block; font-size: 12px; margin-bottom: 4px; color: #d1d5db; }
    .field input, .field select, .field textarea { width: 100%; padding: 7px 9px; border-radius: 8px; border: 1px solid #374151; background: #020617; color: #e5e7eb; font-size: 13px; }
    .field input:focus, .field select:focus, .field textarea:focus { outline: 2px solid #3b82f6; outline-offset: 0; border-color: #3b82f6; }

    .field.checkbox-inline { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
    .field.checkbox-inline label { margin-bottom: 0; }
    .field.checkbox-inline input[type="checkbox"] {
      flex: 0 0 auto;
      appearance: none;
      -webkit-appearance: none;
      width: 34px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      position: relative;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .field.checkbox-inline input[type="checkbox"]::before {
      content: '';
      position: absolute;
      top: 1px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #9ca3af;
      transition: transform 0.15s ease, background 0.15s ease;
    }
    .field.checkbox-inline input[type="checkbox"]:checked {
      background: #22c55e;
      border-color: #22c55e;
    }
    .field.checkbox-inline input[type="checkbox"]:checked::before {
      transform: translateX(14px);
      background: #f9fafb;
    }
    .field.checkbox-inline input[type="checkbox"]:focus-visible {
      outline: 2px solid #22c55e;
      outline-offset: 2px;
    }

    .field.inline-edit { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .field.inline-edit label { margin-bottom: 0; }
    .ghost-btn { border-radius: 999px; border: 1px solid #374151; padding: 4px 9px; background: transparent; color: #9ca3af; font-size: 11px; cursor: pointer; white-space: nowrap; }
    .ghost-btn:hover { background: #111827; color: #e5e7eb; }

    .rules-group { margin-top: 14px; margin-bottom: 4px; padding: 10px 12px 12px; border-radius: 12px; border: 1px solid #111827; background: radial-gradient(circle at top left,#020617,#020617); box-shadow: 0 1px 0 rgba(15,23,42,0.8); }
    .rules-group-title { font-size: 13px; font-weight: 600; color: #e5e7eb; margin-bottom: 6px; display:flex; align-items:center; gap:6px; }
    .rules-group-title::before { content:''; display:inline-block; width:3px; height:14px; border-radius:999px; background:#22c55e; }
    .accordion { margin-top: 4px; }
    .accordion-item { border-radius: 8px; background: #020617; border: 1px solid #111827; margin-top: 4px; overflow: hidden; }
    .accordion-header { width: 100%; text-align: left; background: #020617; border: none; padding: 8px 8px; color: #e5e7eb; font-size: 13px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .accordion-header:hover { background: #030712; }
    .accordion-header span { pointer-events: none; }
    .accordion-arrow { font-size: 11px; color: #6b7280; transition: transform 0.15s ease; }
    .accordion-header[aria-expanded="true"] .accordion-arrow { transform: rotate(90deg); }
    .accordion-body { padding: 6px 8px 10px; background: #020617; }

    .rules-layout { display:flex; gap:14px; margin-top:10px; }
    .rules-sidebar { width: 170px; flex-shrink:0; display:flex; flex-direction:column; gap:6px; }
    .rules-main { flex:1; min-width:0; }
    .rules-tab-btn { width: 100%; text-align:left; border-radius:999px; border:1px solid #111827; padding:6px 10px; font-size:13px; color:#9ca3af; background:#020617; display:flex; align-items:center; gap:8px; cursor:pointer; }
    .rules-tab-btn span { flex:1; }
    .rules-tab-btn.active { background:linear-gradient(135deg,#22c55e,#16a34a); border-color:transparent; color:#f9fafb; }
    .rules-tab-btn.active .rules-tab-dot { background:#f9fafb; }
    .rules-tab-dot { width:6px; height:6px; border-radius:999px; background:#4b5563; }
    .rules-tab-desc { font-size:11px; color:#6b7280; margin-top:2px; }
    .rules-card { border-radius:12px; border:1px solid #111827; background:#020617; padding:10px 12px 12px; box-shadow:0 1px 0 rgba(15,23,42,0.8); margin-bottom:10px; }
    .rules-card-title { font-size:13px; font-weight:600; color:#e5e7eb; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .rules-card-title::before { content:''; display:inline-block; width:3px; height:14px; border-radius:999px; background:#22c55e; }
    .rules-tab-panel { display:none; }
    .rules-tab-panel.active { display:block; }

    /* chips 输入组件 */
    .chips-container { border-radius:8px; border:1px solid #374151; background:#020617; padding:6px 8px 8px; }
    .chips-list { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
    .chip { display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; background:rgba(59,130,246,0.12); color:#bfdbfe; font-size:11px; border:1px solid rgba(59,130,246,0.4); }
    .chip-remove { margin-left:4px; cursor:pointer; border:none; background:transparent; color:#93c5fd; font-size:11px; }
    .chip-remove:hover { color:#eff6ff; }
    .chips-input { width:100%; border-radius:6px; border:none; background:transparent; padding:4px 2px 0; color:#e5e7eb; font-size:12px; outline:none; }
    .chips-hint { font-size:11px; color:#6b7280; margin-top:2px; }

    .primary-btn { border-radius: 999px; border: none; padding: 7px 12px; background: linear-gradient(135deg,#22c55e,#16a34a); color: #f9fafb; font-size: 13px; cursor: pointer; }
    .primary-btn:disabled { opacity: .6; cursor: default; }

    .table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 4px; }
    .table th, .table td { padding: 6px 8px; border-bottom: 1px solid #111827; text-align: left; }
    .badge { border-radius: 999px; padding: 2px 7px; font-size: 10px; border: 1px solid #374151; color: #9ca3af; }
    .status-running { border-color: #22c55e; color: #bbf7d0; }
    .status-failed { border-color: #ef4444; color: #fecaca; }

    .error { color: #fca5a5; font-size: 12px; margin-top: 6px; }

    .log-panel { margin-top: 12px; border-radius: 10px; border: 1px solid #1f2937; background: #020617; padding: 8px 10px 10px; }
    .log-header { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #9ca3af; margin-bottom: 4px; }
    .log-body { margin: 0; max-height: 720px; overflow-y: auto; padding: 6px 8px; background: #020617; border-radius: 6px; font-size: 11px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; line-height: 1.4; }

    @media (max-width: 800px) {
      .layout { grid-template-columns: 1fr; height: auto; min-height: 100vh; }
      .sidebar { display: none; }
      .content { padding: 12px; width: 100%; }
      .content-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .bottom { display: flex; }
      .grid-two { grid-template-columns: 1fr; }
      .rules-layout { flex-direction: column; }
      .rules-sidebar { width: 100%; }
      .table { font-size: 11px; }
      .table th, .table td { padding: 4px 6px; }
      .panel { padding: 12px; }
      .panel-title { font-size: 13px; }
      .panel-desc { font-size: 11px; }
      .field label { font-size: 11px; }
      .field input, .field select, .field textarea { font-size: 12px; padding: 6px 8px; }
      .primary-btn { font-size: 12px; padding: 6px 10px; }
      .ghost-btn { font-size: 10px; padding: 2px 6px; }
      .log-panel { padding: 8px; }
      .log-body { font-size: 10px; max-height: 400px; }
      .log-task-group { margin-bottom: 6px; }
      .log-task-header { padding: 8px 10px; flex-wrap: wrap; gap: 4px; }
      .log-task-body { padding: 6px 10px; }
      /* 移动端筛选控件 */
      #history-filter-status, #history-filter-path, #history-filter-profile {
        font-size: 11px;
        padding: 4px 6px;
      }
      #history-pagination {
        font-size: 11px;
      }
    }
    
    /* 移动端顶部抽屉 */
    .mobile-drawer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      z-index: 1001;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }
    .mobile-drawer.open {
      transform: translateY(0);
    }
    @media (max-width: 800px) {
      .mobile-drawer { display: block; }
      .content { margin-top: 0; }
    }
    
    /* 移动端菜单按钮 */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 1002;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 8px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 18px;
    }
    @media (max-width: 800px) {
      .mobile-menu-btn { display: block; }
      .content { padding-top: 60px; }
    }
    
    /* 移动端遮罩层 */
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    @media (max-width: 800px) {
      .mobile-overlay.show { display: block; }
    }
    
    /* 分页样式 */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .pagination-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination-btn:hover:not(:disabled) {
      background: #111827;
    }
    .pagination-info {
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileDrawer()">☰</button>
  <div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileDrawer()"></div>
  <div class="mobile-drawer" id="mobile-drawer">
    <div style="padding: 16px 14px;">
      <div class="brand" style="margin-bottom: 16px;">JavSP-web</div>
      <div class="version" id="mobile-version" style="font-size: 11px; color: #6b7280; margin-bottom: 16px;">版本加载中...</div>
      <div class="nav-section-title">任务</div>
      <div class="nav">
        <button class="nav-btn" data-view="manual" onclick="toggleMobileDrawer();switchView('manual')">手动刮削</button>
        <button class="nav-btn" data-view="watch" onclick="toggleMobileDrawer();switchView('watch')">监控刮削</button>
        <button class="nav-btn" data-view="schedule" onclick="toggleMobileDrawer();switchView('schedule')">定时刮削</button>
      </div>
      <div class="nav-section-title" style="margin-top: 16px;">系统</div>
      <div class="nav">
        <button class="nav-btn" data-view="rules" onclick="toggleMobileDrawer();switchView('rules')">全局规则</button>
        <button class="nav-btn" data-view="history" onclick="toggleMobileDrawer();switchView('history')">刮削历史</button>
        <button class="nav-btn" data-view="cookiecloud" onclick="toggleMobileDrawer();switchView('cookiecloud')">CookieCloud</button>
        <button class="nav-btn" data-view="account" onclick="toggleMobileDrawer();switchView('account')">账号与安全</button>
      </div>
      <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #1f2937;">
        <button class="logout-btn" id="mobile-logout-btn" style="width: 100%;">退出登录</button>
      </div>
    </div>
  </div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div>
        <div class="brand">JavSP-web</div>
        <div class="version" id="version">版本加载中...</div>
        <div class="nav-section-title">任务</div>
        <div class="nav">
          <button class="nav-btn active" data-view="manual">手动刮削</button>
          <button class="nav-btn" data-view="watch">监控刮削</button>
          <button class="nav-btn" data-view="schedule">定时刮削</button>
        </div>
        <div class="nav-section-title">系统</div>
        <div class="nav">
          <button class="nav-btn" data-view="rules">全局规则</button>
          <button class="nav-btn" data-view="history">刮削历史</button>
          <button class="nav-btn" data-view="cookiecloud">CookieCloud</button>
          <button class="nav-btn" data-view="account">账号与安全</button>
        </div>
      </div>
      <div class="bottom">
        <button class="logout-btn" id="logout-btn">退出登录</button>
        <div class="project-links">
          <a class="link" href="https://github.com/Yuukiy/JavSP" target="_blank" rel="noreferrer">原项目：JavSP</a>
          <a class="link" href="https://github.com/APecme/JavSP-Web" target="_blank" rel="noreferrer">本项目：JavSP-Web</a>
        </div>
      </div>
    </aside>
    <main class="content">
      <header class="content-header">
        <div>
          <div class="content-title" id="content-title">手动刮削</div>
          <div class="content-subtitle" id="content-subtitle">从 /video 选择具体影片文件，按顺序触发手动刮削任务。</div>
        </div>
        <div class="pill" id="user-pill">未登录</div>
      </header>

      <section id="view-manual" class="panel">
        <div class="panel-title">手动刮削</div>
        <div class="panel-desc">从 /video 开始浏览，选择具体影片文件后按顺序触发手动刮削任务。</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <div class="field" style="width:25%;">
            <label for="manual-profile">任务规则预设</label>
            <select id="manual-profile">
              <option value="default">使用当前全局规则</option>
            </select>
          </div>
          <button class="primary-btn" id="manual-rules-edit-btn" style="margin-top:24px;font-size:11px;display:none;">编辑规则</button>
          <button class="primary-btn" id="manual-rules-btn" style="margin-top:24px;font-size:11px;">添加自定义规则</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px;">
          <span>当前路径：</span>
          <code id="videode-path" style="padding:2px 6px;border-radius:999px;border:1px solid #374151;background:#020617;font-size:11px;">/video</code>
          <button type="button" class="ghost-btn" id="videode-up">上一级</button>
          <button type="button" class="ghost-btn" id="videode-refresh">刷新</button>
        </div>

        <div class="log-panel" style="margin-top:10px;">
          <div class="log-header">
            <span>文件列表</span>
            <span id="videode-hint">从 /video 开始浏览，可勾选多个文件。</span>
          </div>
          <table class="table" id="videode-table" style="font-size:11px;margin-bottom:6px;">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="videode-select-all" /></th>
                <th>名称</th>
                <th style="width:80px;">类型</th>
                <th style="width:120px;">大小</th>
                <th style="width:80px;">操作</th>
              </tr>
            </thead>
            <tbody id="videode-tbody"></tbody>
          </table>
          <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
            <button class="primary-btn" id="videode-run">开始刮削</button>
            <span class="placeholder" id="videode-run-hint">将依次调用 /api/tasks/manual，每个文件一个任务。</span>
          </div>
        </div>

        <!-- 表头影片任务状态表已废弃，仅隐藏表格，保留任务日志面板与终端 -->
        <div class="log-panel" style="margin-top:10px;">
          <div class="log-header">
            <span>任务日志</span>
            <div style="display:flex;align-items:center;gap:6px;">
              <span id="manual-log-status">尚未创建任务</span>
            </div>
          </div>
          <div id="manual-progress" style="font-size:11px;color:#9ca3af;margin:2px 0 4px;display:none;">
            <div id="manual-progress-movie"></div>
            <div id="manual-progress-step"></div>
          </div>
          <table class="table" id="manual-task-table" style="font-size:11px;margin-bottom:6px;display:none;">
            <thead>
              <tr>
                <th style="width:80px;">影片</th>
                <th style="width:120px;">步骤</th>
                <th style="width:60px;">状态</th>
                <th>最新日志</th>
              </tr>
            </thead>
            <tbody id="manual-task-tbody"></tbody>
          </table>
          <div id="manual-log-container" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </section>

      <section id="view-watch" class="panel" style="display:none;">
        <div class="panel-title">监控刮削</div>
        <div class="panel-desc">配置需要长期监控的目录，当发现新文件时自动创建刮削任务。</div>
        <p class="placeholder">界面骨架：后续将展示监控任务列表、创建和编辑对话框。</p>
      </section>

      <section id="view-schedule" class="panel" style="display:none;">
        <div class="panel-title">定时刮削</div>
        <div class="panel-desc">按计划定期触发刮削任务，例如每天凌晨整理指定目录。</div>
        <p class="placeholder">界面骨架：后续将展示定时任务列表和新建计划表单。</p>
      </section>

      <section id="view-rules" class="panel" style="display:none;">
        <div class="panel-title">全局规则</div>
        <div class="panel-desc">配置常用全局规则（其余高级选项请直接编辑 config.yml）。</div>
        <div class="rules-layout">
          <div class="rules-sidebar">
            <button type="button" class="rules-tab-btn active" data-rules-tab="scanner">
              <div class="rules-tab-dot"></div>
              <span>扫描设置</span>
            </button>
            <button type="button" class="rules-tab-btn" data-rules-tab="network">
              <div class="rules-tab-dot"></div>
              <span>网络设置</span>
            </button>
            <button type="button" class="rules-tab-btn" data-rules-tab="crawler">
              <div class="rules-tab-dot"></div>
              <span>爬虫设置</span>
            </button>
            <button type="button" class="rules-tab-btn" data-rules-tab="summarizer">
              <div class="rules-tab-dot"></div>
              <span>整理与元数据</span>
            </button>
            <button type="button" class="rules-tab-btn" data-rules-tab="translator">
              <div class="rules-tab-dot"></div>
              <span>翻译设置</span>
            </button>
          </div>

          <div class="rules-main">
            <div class="rules-tab-panel active" data-rules-panel="scanner">
              <div class="rules-card">
                <div class="rules-card-title">扫描行为</div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-scanner-skip-nfo">跳过 NFO 目录（skip_nfo_dir）</label>
                    <input type="checkbox" id="rules-scanner-skip-nfo" />
                  </div>
                </div>
              </div>
              <div class="rules-card">
                <div class="rules-card-title">扫描设置</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-scanner-minimum-size">忽略小于指定大小的文件</label>
                    <input id="rules-scanner-minimum-size" placeholder="单位 MiB，只输入数字" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label>番号正则忽略模式（ignored_id_pattern）</label>
                    <div class="chips-container" data-chips="scanner-ignored-id">
                      <div class="chips-list" id="chips-scanner-ignored-id"></div>
                      <input class="chips-input" id="chips-input-scanner-ignored-id" placeholder="输入并按回车添加..." />
                      <div class="chips-hint">按回车键添加新项，示例：(144|240|360|480|720|1080)[Pp]</div>
                    </div>
                  </div>
                  <div class="field">
                    <label>忽略的文件夹（ignored_folder_name_pattern）</label>
                    <div class="chips-container" data-chips="scanner-ignored-folders">
                      <div class="chips-list" id="chips-scanner-ignored-folders"></div>
                      <input class="chips-input" id="chips-input-scanner-ignored-folders" placeholder="输入并按回车添加..." />
                      <div class="chips-hint">示例：^\., ^#recycle$</div>
                    </div>
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label>视频文件后缀（filename_extensions）</label>
                    <div class="chips-container" data-chips="scanner-extensions">
                      <div class="chips-list" id="chips-scanner-extensions"></div>
                      <input class="chips-input" id="chips-input-scanner-extensions" placeholder="输入并按回车添加，例如 .mp4" />
                      <div class="chips-hint">按回车键添加新项，例如 .mp4、.mkv</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="rules-tab-panel" data-rules-panel="network">
              <div class="rules-card">
                <div class="rules-card-title">网络设置</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-network-proxy">代理服务器地址</label>
                    <input id="rules-network-proxy" placeholder="例如 http://127.0.0.1:1080，留空表示不使用代理" />
                  </div>
                  <div class="field">
                    <label for="rules-network-retry">网络重试次数</label>
                    <input id="rules-network-retry" type="number" min="0" placeholder="例如 3" />
                  </div>
                  <div class="field">
                    <label for="rules-network-timeout">网络超时时间（timeout）</label>
                    <input id="rules-network-timeout" placeholder="例如 PT10S" />
                  </div>
                </div>
              </div>
              <div class="rules-card">
                <div class="rules-card-title">免代理站点</div>
                <div class="grid-two">
                  <div class="field">
                    <label>各站点免代理地址</label>
                    <button class="primary-btn" id="rules-proxyfree-open" type="button">编辑各站点免代理</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="rules-tab-panel" data-rules-panel="crawler">
              <div class="rules-card">
                <div class="rules-card-title">爬虫设置</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-crawler-required-keys">必需字段</label>
                    <input id="rules-crawler-required-keys" placeholder="逗号分隔，例如 cover,title" />
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-crawler-hardworking">更努力爬取</label>
                    <input type="checkbox" id="rules-crawler-hardworking" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-crawler-respect-id">使用网页番号作为最终番号</label>
                    <input type="checkbox" id="rules-crawler-respect-id" />
                  </div>
                  <div class="field">
                    <label for="rules-crawler-use-javdb-cover">是否使用 JavDB 封面</label>
                    <select id="rules-crawler-use-javdb-cover">
                      <option value="fallback">fallback</option>
                      <option value="yes">yes</option>
                      <option value="no">no</option>
                    </select>
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-crawler-normalize-actress">统一女优艺名</label>
                    <input type="checkbox" id="rules-crawler-normalize-actress" />
                  </div>
                  <div class="field">
                    <label for="rules-crawler-fc2fan-path">本地 FC2Fan 路径（fc2fan_local_path）</label>
                    <input id="rules-crawler-fc2fan-path" placeholder="留空则不使用本地 FC2Fan" />
                  </div>
                  <div class="field">
                    <label for="rules-crawler-sleep-after">抓取后等待时间（sleep_after_scraping）</label>
                    <input id="rules-crawler-sleep-after" placeholder="例如 PT1S" />
                  </div>
                </div>
              </div>
              <div class="rules-card">
                <div class="rules-card-title">爬虫源优先级（selection）</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-crawler-selection-normal">normal 源列表</label>
                    <div class="chips-container" data-chips="crawler-selection-normal">
                      <div class="chips-list" id="chips-crawler-selection-normal"></div>
                      <input class="chips-input" id="chips-input-crawler-selection-normal" placeholder="输入并按回车添加，例如 javdb" />
                      <div class="chips-hint">示例：airav, javdb, javlib ...</div>
                    </div>
                  </div>
                  <div class="field">
                    <label for="rules-crawler-selection-fc2">fc2 源列表</label>
                    <div class="chips-container" data-chips="crawler-selection-fc2">
                      <div class="chips-list" id="chips-crawler-selection-fc2"></div>
                      <input class="chips-input" id="chips-input-crawler-selection-fc2" placeholder="输入并按回车添加，例如 fc2" />
                      <div class="chips-hint">示例：fc2, avsox ...</div>
                    </div>
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-crawler-selection-cid">cid 源列表</label>
                    <div class="chips-container" data-chips="crawler-selection-cid">
                      <div class="chips-list" id="chips-crawler-selection-cid"></div>
                      <input class="chips-input" id="chips-input-crawler-selection-cid" placeholder="输入并按回车添加，例如 fanza" />
                      <div class="chips-hint">示例：fanza ...</div>
                    </div>
                  </div>
                  <div class="field">
                    <label for="rules-crawler-selection-getchu">getchu 源列表</label>
                    <div class="chips-container" data-chips="crawler-selection-getchu">
                      <div class="chips-list" id="chips-crawler-selection-getchu"></div>
                      <input class="chips-input" id="chips-input-crawler-selection-getchu" placeholder="输入并按回车添加，例如 dl_getchu" />
                      <div class="chips-hint">示例：dl_getchu ...</div>
                    </div>
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-crawler-selection-gyutto">gyutto 源列表</label>
                    <div class="chips-container" data-chips="crawler-selection-gyutto">
                      <div class="chips-list" id="chips-crawler-selection-gyutto"></div>
                      <input class="chips-input" id="chips-input-crawler-selection-gyutto" placeholder="输入并按回车添加，例如 gyutto" />
                      <div class="chips-hint">示例：gyutto ...</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="rules-tab-panel" data-rules-panel="summarizer">
              <div class="rules-card">
                <div class="rules-card-title">命名规则变量说明</div>
                <p class="rules-tab-desc">点击变量名可复制，变量可用于整理输出路径和文件名模板，例如 <code>$actress/[$num] $title</code>。</p>
                <table class="table">
                  <thead>
                    <tr>
                      <th style="width: 120px;">变量</th>
                      <th>含义</th>
                      <th style="width: 140px;">默认值*</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$num">$num</button></td>
                      <td>影片番号（优先 DVD ID，cid 模式下为 cid）</td>
                      <td></td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$title">$title</button></td>
                      <td>影片标题</td>
                      <td><code>null_for_title</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$rawtitle">$rawtitle</button></td>
                      <td>原始标题（始终为翻译前的标题）</td>
                      <td>与 <code>$title</code> 一致</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$actress">$actress</button></td>
                      <td>女优（多名以英文逗号 <code>,</code> 分隔）</td>
                      <td><code>null_for_actress</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$censor">$censor</button></td>
                      <td>有码 / 无码 / 不确定（具体文本在配置中自定义）</td>
                      <td></td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$score">$score</button></td>
                      <td>影片评分（10 分制，如 7.81）</td>
                      <td>0</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$serial">$serial</button></td>
                      <td>系列名</td>
                      <td><code>null_for_serial</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$label">$label</button></td>
                      <td>番号系列（如 ABC-123 中的 ABC）</td>
                      <td>---</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$director">$director</button></td>
                      <td>导演</td>
                      <td><code>null_for_director</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$producer">$producer</button></td>
                      <td>制作商</td>
                      <td><code>null_for_producer</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$publisher">$publisher</button></td>
                      <td>发行商</td>
                      <td><code>null_for_publisher</code> 所设置的值</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$date">$date</button></td>
                      <td>发行日期（YYYY-MM-DD）</td>
                      <td>0000-00-00</td>
                    </tr>
                    <tr>
                      <td><button type="button" class="copy-var" data-var="$year">$year</button></td>
                      <td>发行年份</td>
                      <td>0000</td>
                    </tr>
                  </tbody>
                </table>
                <p class="rules-tab-desc" style="margin-top:6px;">如果变量名后紧跟数字、英文或下划线，请使用花括号，例如 <code>${actress}_2024</code>。</p>
              </div>

              <div class="rules-card">
                <div class="rules-card-title">整理与路径</div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-summarizer-move-files">整理时移动文件</label>
                    <input type="checkbox" id="rules-summarizer-move-files" />
                  </div>
                  <div class="field">
                    <label for="rules-path-output">整理输出路径模板</label>
                    <input id="rules-path-output" placeholder="/video/#整理完成/{actress}/[{num}] {title}" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-path-basename">文件名模板</label>
                    <input id="rules-path-basename" placeholder="{num}" />
                  </div>
                  <div class="field">
                    <label for="rules-path-length-max">允许的最长路径</label>
                    <input id="rules-path-length-max" type="number" min="10" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-path-length-by-byte">按字节计算路径长度</label>
                    <input type="checkbox" id="rules-path-length-by-byte" />
                  </div>
                  <div class="field">
                    <label for="rules-path-max-actress">路径中 {actress} 最多人数</label>
                    <input id="rules-path-max-actress" type="number" min="1" />
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-path-hard-link">使用硬链接整理文件</label>
                    <input type="checkbox" id="rules-path-hard-link" />
                  </div>
                </div>
              </div>

              <div class="rules-card">
                <div class="rules-card-title">标题与默认值</div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-title-remove-actor">删除标题尾部可能存在的女优名</label>
                    <input type="checkbox" id="rules-title-remove-actor" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-default-title">默认标题</label>
                    <input id="rules-default-title" placeholder="#未知标题" />
                  </div>
                  <div class="field">
                    <label for="rules-default-actress">默认女优</label>
                    <input id="rules-default-actress" placeholder="#未知女优" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-default-series">默认系列</label>
                    <input id="rules-default-series" placeholder="#未知系列" />
                  </div>
                  <div class="field">
                    <label for="rules-default-director">默认导演</label>
                    <input id="rules-default-director" placeholder="#未知导演" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-default-producer">默认制作商</label>
                    <input id="rules-default-producer" placeholder="#未知制作商" />
                  </div>
                  <div class="field">
                    <label for="rules-default-publisher">默认发行商</label>
                    <input id="rules-default-publisher" placeholder="#未知发行商" />
                  </div>
                </div>
              </div>

              <div class="rules-card">
                <div class="rules-card-title">NFO 与分类标签</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-nfo-basename">NFO 文件名</label>
                    <input id="rules-nfo-basename" placeholder="movie" />
                  </div>
                  <div class="field">
                    <label for="rules-nfo-title">NFO 标题模板</label>
                    <input id="rules-nfo-title" placeholder="{num} {title}" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field inline-edit">
                    <label>自定义分类/标签字段</label>
                    <button class="ghost-btn" id="rules-nfo-open" type="button">编辑...</button>
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-censor-texts">有码/无码/不确定 文本</label>
                    <input id="rules-censor-texts" placeholder="用逗号分隔，例如: 无码,有码,打码情况未知" />
                  </div>
                </div>
              </div>

              <div class="rules-card">
                <div class="rules-card-title">封面与剧照</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-cover-basename">封面文件名</label>
                    <input id="rules-cover-basename" placeholder="poster" />
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-cover-highres">下载高清封面</label>
                    <input type="checkbox" id="rules-cover-highres" />
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-cover-add-label">封面添加标签</label>
                    <input type="checkbox" id="rules-cover-add-label" />
                  </div>
                </div>
                <div class="grid-two">
                  <div class="field checkbox-inline">
                    <label for="rules-extra-fanarts-enabled">下载剧照</label>
                    <input type="checkbox" id="rules-extra-fanarts-enabled" />
                  </div>
                  <div class="field">
                    <label for="rules-extra-fanarts-interval">剧照下载间隔</label>
                    <input id="rules-extra-fanarts-interval" placeholder="例如 PT1.5S，留空则使用当前配置" />
                  </div>
                  <div class="field">
                    <label for="rules-fanart-basename">剧照文件名（fanart.basename_pattern）</label>
                    <input id="rules-fanart-basename" placeholder="fanart" />
                  </div>
                </div>
              </div>
            </div>

            <div class="rules-tab-panel" data-rules-panel="translator">
              <div class="rules-card">
                <div class="rules-card-title">翻译设置</div>
                <div class="grid-two">
                  <div class="field">
                    <label for="rules-translate-engine">翻译引擎</label>
                    <select id="rules-translate-engine">
                      <option value="disabled">禁用</option>
                      <option value="google">Google (免费)</option>
                      <option value="baidu">百度翻译</option>
                      <option value="bing">必应翻译</option>
                      <option value="claude">Claude</option>
                      <option value="openai">OpenAI / 兼容接口</option>
                    </select>
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-translate-title">是否翻译标题</label>
                    <input type="checkbox" id="rules-translate-title" />
                  </div>
                  <div class="field checkbox-inline">
                    <label for="rules-translate-plot">是否翻译剧情简介</label>
                    <input type="checkbox" id="rules-translate-plot" />
                  </div>
                </div>
                <div class="accordion" id="rules-translate-engine-panel">
                  <div class="accordion-item">
                    <button type="button" class="accordion-header" aria-expanded="false">
                      <span>引擎详细配置</span>
                      <span class="accordion-arrow">▶</span>
                    </button>
                    <div class="accordion-body" style="display:none;">
                      <div class="grid-two">
                        <div class="field translate-engine-field" data-engine="baidu">
                          <label for="rules-translate-baidu-appid">百度 App ID</label>
                          <input id="rules-translate-baidu-appid" />
                        </div>
                        <div class="field translate-engine-field" data-engine="baidu">
                          <label for="rules-translate-baidu-apikey">百度 API Key</label>
                          <input id="rules-translate-baidu-apikey" type="password" />
                        </div>
                        <div class="field translate-engine-field" data-engine="bing">
                          <label for="rules-translate-bing-apikey">Bing API Key</label>
                          <input id="rules-translate-bing-apikey" type="password" />
                        </div>
                        <div class="field translate-engine-field" data-engine="claude">
                          <label for="rules-translate-claude-apikey">Claude API Key</label>
                          <input id="rules-translate-claude-apikey" type="password" />
                        </div>
                        <div class="field translate-engine-field" data-engine="openai">
                          <label for="rules-translate-openai-url">OpenAI API URL</label>
                          <input id="rules-translate-openai-url" placeholder="https://api.groq.com/openai/v1/chat/completions" />
                        </div>
                        <div class="field translate-engine-field" data-engine="openai">
                          <label for="rules-translate-openai-apikey">OpenAI API Key</label>
                          <input id="rules-translate-openai-apikey" type="password" />
                        </div>
                        <div class="field translate-engine-field" data-engine="openai">
                          <label for="rules-translate-openai-model">OpenAI 模型</label>
                          <input id="rules-translate-openai-model" placeholder="llama-3.1-70b-versatile" />
                        </div>
                      </div>
                      <p class="placeholder" style="margin-top:6px;">注意：请不要在公共环境暴露 API Key。</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="rules-tab-panel" data-rules-panel="other">
              <div class="rules-card">
                <div class="rules-card-title">其他</div>
                <p class="placeholder">其余高级全局设置（如更新检查、CLI 交互等）请在容器挂载的 <code>config.yml</code> 中直接修改。</p>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top: 8px; display:flex; align-items:center; gap:8px;">
          <button class="primary-btn" id="rules-save">保存全局规则</button>
          <span id="rules-status" class="placeholder"></span>
        </div>
      </section>

      <section id="view-history" class="panel" style="display:none;">
        <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>刮削历史</span>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="ghost-btn" id="history-view-toggle" style="font-size:11px;">封面墙</button>
            <input type="checkbox" id="history-select-all" style="width:18px;height:18px;cursor:pointer;" />
            <label for="history-select-all" style="font-size:12px;color:#9ca3af;cursor:pointer;margin-right:8px;">全选</label>
            <div style="position:relative;display:inline-block;">
              <button class="ghost-btn" id="history-delete-btn" style="font-size:11px;" disabled>删除选中 ▼</button>
              <div id="history-delete-menu" style="display:none;position:absolute;top:100%;left:0;margin-top:4px;background:#111827;border:1px solid #1f2937;border-radius:6px;padding:4px;z-index:100;min-width:180px;">
                <button class="ghost-btn" style="width:100%;text-align:left;font-size:11px;padding:6px 8px;margin-bottom:2px;" onclick="deleteHistoryItems('record')">仅删除刮削记录</button>
                <button class="ghost-btn" style="width:100%;text-align:left;font-size:11px;padding:6px 8px;margin-bottom:2px;" onclick="deleteHistoryItems('files')">删除媒体库文件</button>
                <button class="ghost-btn" style="width:100%;text-align:left;font-size:11px;padding:6px 8px;" onclick="deleteHistoryItems('both')">删除刮削记录与媒体库文件</button>
              </div>
            </div>
            <button class="ghost-btn" id="history-redownload-fanart-btn" style="font-size:11px;" disabled>重新下载封面/剧照</button>
          </div>
        </div>
        <div class="panel-desc">按整理完成的影片文件展示历史记录。</div>
        <!-- 筛选和分页控件 -->
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;">
          <div style="display:flex;gap:6px;align-items:center;">
            <label style="font-size:12px;color:#9ca3af;">状态:</label>
            <select id="history-filter-status" style="padding:4px 8px;border-radius:6px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:12px;">
              <option value="">全部</option>
              <option value="success">成功</option>
              <option value="failed">失败</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <label style="font-size:12px;color:#9ca3af;">路径:</label>
            <input type="text" id="history-filter-path" placeholder="包含路径" style="padding:4px 8px;border-radius:6px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:12px;min-width:200px;" />
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <label style="font-size:12px;color:#9ca3af;">规则:</label>
            <input type="text" id="history-filter-profile" placeholder="使用规则" style="padding:4px 8px;border-radius:6px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:12px;min-width:150px;" />
          </div>
          <button class="ghost-btn" id="history-filter-apply" style="font-size:11px;">应用筛选</button>
          <button class="ghost-btn" id="history-filter-clear" style="font-size:11px;">清除</button>
        </div>
        <div id="history-container" style="display:flex;flex-direction:column;gap:12px;">
          <div class="placeholder" id="history-placeholder">暂无记录</div>
        </div>
        <div id="history-gallery" style="display:none;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-top:16px;">
        </div>
        <!-- 分页控件 -->
        <div id="history-pagination" style="display:flex;justify-content:center;align-items:center;gap:8px;margin-top:16px;flex-wrap:wrap;">
          <button class="ghost-btn" id="history-prev-page" style="font-size:11px;" disabled>上一页</button>
          <span id="history-page-info" style="font-size:12px;color:#9ca3af;">第 1 页，共 1 页</span>
          <button class="ghost-btn" id="history-next-page" style="font-size:11px;" disabled>下一页</button>
        </div>
      </section>
      
      <section id="view-cookiecloud" class="panel" style="display:none;">
        <div class="panel-title">CookieCloud 配置</div>
        <div class="panel-desc">配置 CookieCloud 以支持需要登录的站点（如 JavDB、JavLib 等）。</div>
        <div class="grid-two">
          <div class="field checkbox-inline">
            <label for="rules-cookiecloud-enabled">启用 CookieCloud</label>
            <input type="checkbox" id="rules-cookiecloud-enabled" />
          </div>
          <div class="field">
            <label for="rules-cookiecloud-server-url">CookieCloud 服务器地址</label>
            <input id="rules-cookiecloud-server-url" placeholder="例如 http://localhost:8088" />
          </div>
          <div class="field">
            <label for="rules-cookiecloud-uuid">UUID</label>
            <input id="rules-cookiecloud-uuid" placeholder="CookieCloud 的 UUID" />
          </div>
          <div class="field">
            <label for="rules-cookiecloud-password">密码</label>
            <input id="rules-cookiecloud-password" type="password" placeholder="CookieCloud 的密码" />
          </div>
        </div>
        <div style="margin-top: 10px; display:flex; align-items:center; gap:8px;">
          <button class="primary-btn" id="cookiecloud-save">保存 CookieCloud 配置</button>
          <span id="cookiecloud-status" class="placeholder"></span>
        </div>
      </section>
      
      <!-- 手动刮削规则设置浮动窗口 -->
      <div id="manual-rules-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:50;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
        <div style="max-width:95%;max-height:95%;width:1200px;background:#111827;border-radius:12px;border:1px solid #1f2937;padding:20px;box-shadow:0 20px 40px rgba(0,0,0,0.6);display:flex;flex-direction:column;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-shrink:0;">
            <div class="panel-title" style="margin:0;">添加自定义规则</div>
            <button onclick="document.getElementById('manual-rules-modal').style.display='none'" style="border:none;background:transparent;color:#9ca3af;font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;">&times;</button>
          </div>
          <div style="flex:1;overflow-y:auto;padding-right:8px;margin-bottom:16px;">
            <div style="font-size:12px;color:#9ca3af;margin-bottom:16px;padding:12px;background:#020617;border-radius:8px;border:1px solid #1f2937;">
              创建自定义规则预设，保存后可在"任务规则预设"中选择使用。规则名称必填。
            </div>
            <div style="margin-bottom:16px;">
              <div class="field">
                <label for="manual-rule-name" style="color:#ef4444;">规则名称 <span style="color:#ef4444;">*</span></label>
                <input id="manual-rule-name" placeholder="请输入规则名称，例如：高清封面规则" style="width:100%;" />
              </div>
            </div>
            <div id="manual-rules-content">
              <!-- 规则内容将通过JavaScript动态加载，复用全局规则的UI结构 -->
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:16px;border-top:1px solid #1f2937;flex-shrink:0;">
            <button class="ghost-btn" onclick="document.getElementById('manual-rules-modal').style.display='none'" style="font-size:12px;">取消</button>
            <button class="primary-btn" id="manual-rules-save" style="font-size:12px;">保存规则</button>
          </div>
        </div>
      </div>
      
      <!-- 剧照悬浮框 -->
      <div id="fanart-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:50;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
        <div style="max-width:90%;max-height:90%;background:#020617;border-radius:12px;border:1px solid #1f2937;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="panel-title" style="margin:0;">剧照</div>
            <button onclick="document.getElementById('fanart-modal').style.display='none';document.getElementById('fanart-preview-modal').style.display='none';" style="border:none;background:transparent;color:#9ca3af;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;">×</button>
          </div>
          <div id="fanart-images" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;max-height:70vh;overflow-y:auto;"></div>
        </div>
      </div>
      
      <!-- 剧照预览悬浮框（全屏预览，支持左右翻页） -->
      <div id="fanart-preview-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:60;align-items:center;justify-content:center;overflow:hidden;">
        <button id="fanart-preview-close" onclick="closeFanartPreview()" style="position:absolute;top:20px;right:20px;border:none;background:rgba(17,24,39,0.9);color:#e5e7eb;font-size:24px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;z-index:70;">×</button>
        <button id="fanart-preview-prev" onclick="prevFanartImage()" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);border:none;background:rgba(17,24,39,0.9);color:#e5e7eb;font-size:24px;cursor:pointer;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:8px;z-index:70;">‹</button>
        <button id="fanart-preview-next" onclick="nextFanartImage()" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);border:none;background:rgba(17,24,39,0.9);color:#e5e7eb;font-size:24px;cursor:pointer;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:8px;z-index:70;">›</button>
        <div id="fanart-preview-info" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,24,39,0.9);color:#e5e7eb;padding:8px 16px;border-radius:8px;font-size:14px;z-index:70;"></div>
        <img id="fanart-preview-image" src="" style="max-width:90vw;max-height:90vh;object-fit:contain;cursor:pointer;" onclick="nextFanartImage()" />
      </div>
      
      <!-- 重新下载日志悬浮窗 -->
      <div id="redownload-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:50;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
        <div style="max-width:80%;max-height:90%;background:#020617;border-radius:12px;border:1px solid #1f2937;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="panel-title" style="margin:0;">重新下载封面/剧照</div>
            <button onclick="document.getElementById('redownload-modal').style.display='none'" style="border:none;background:transparent;color:#9ca3af;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;">×</button>
          </div>
          <div id="redownload-logs" style="font-size:11px;color:#e5e7eb;font-family:ui-monospace,monospace;max-height:70vh;overflow-y:auto;padding:12px;background:#111827;border-radius:8px;line-height:1.6;white-space:pre-wrap;"></div>
        </div>
      </div>

      <section id="view-account" class="panel" style="display:none;">
        <div class="panel-title">账号与安全</div>
        <div class="panel-desc">修改 Web 登录用的用户名和密码。</div>
        <div class="grid-two">
          <div class="field">
            <label for="old-password">当前密码</label>
            <input id="old-password" type="password" />
          </div>
          <div class="field">
            <label for="new-username">新用户名（可选）</label>
            <input id="new-username" placeholder="留空则不修改用户名" />
          </div>
          <div class="field">
            <label for="new-password">新密码</label>
            <input id="new-password" type="password" />
          </div>
        </div>
        <div style="margin-top: 10px; display:flex; align-items:center; gap:8px;">
          <button class="primary-btn" id="account-save">保存修改</button>
          <span id="account-error" class="error"></span>
        </div>
      </section>
      <div id="proxyfree-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.8);z-index:40;align-items:center;justify-content:center;">
        <div style="margin:0 auto;max-width:520px;width:100%;background:#020617;border-radius:12px;border:1px solid #1f2937;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
          <div class="panel-title" style="margin-bottom:4px;">各站点免代理地址</div>
          <div class="panel-desc" style="margin-bottom:10px;">仅在需要直连站点且不走代理时设置，对应 network.proxy_free。</div>
          <div class="grid-two">
            <div class="field">
              <label for="rules-proxyfree-javbus" style="font-size:11px;">javbus</label>
              <input id="rules-proxyfree-javbus" placeholder="https://..." />
            </div>
            <div class="field">
              <label for="rules-proxyfree-javdb" style="font-size:11px;">javdb</label>
              <input id="rules-proxyfree-javdb" placeholder="https://..." />
            </div>
          </div>
          <div class="grid-two" style="margin-top:6px;">
            <div class="field">
              <label for="rules-proxyfree-javlib" style="font-size:11px;">javlib</label>
              <input id="rules-proxyfree-javlib" placeholder="https://..." />
            </div>
            <div class="field">
              <label for="rules-proxyfree-avsox" style="font-size:11px;">avsox</label>
              <input id="rules-proxyfree-avsox" placeholder="https://..." />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
            <button class="primary-btn" id="proxyfree-cancel" type="button" style="background:#111827;">取消</button>
            <button class="primary-btn" id="proxyfree-save" type="button">关闭</button>
          </div>
        </div>
      </div>
      <div id="scanner-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.8);z-index:40;align-items:center;justify-content:center;">
        <div style="margin:0 auto;max-width:640px;width:100%;background:#020617;border-radius:12px;border:1px solid #1f2937;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
          <div class="panel-title" style="margin-bottom:4px;">扫描设置 - 多行配置</div>
          <div class="panel-desc" style="margin-bottom:10px;">每行一条正则或扩展名，保存全局规则时一并写入配置。</div>
          <div class="grid-two">
            <div class="field">
              <label for="rules-scanner-ignored-id" style="font-size:11px;">要忽略的正则表达式</label>
              <textarea id="rules-scanner-ignored-id" rows="4" placeholder="每行一个正则"></textarea>
            </div>
            <div class="field">
              <label for="rules-scanner-ignored-folders" style="font-size:11px;">忽略的文件夹名称正则</label>
              <textarea id="rules-scanner-ignored-folders" rows="4" placeholder="每行一个正则"></textarea>
            </div>
          </div>
          <div class="grid-two" style="margin-top:6px;">
            <div class="field">
              <label for="rules-scanner-extensions" style="font-size:11px;">影片后缀列表</label>
              <textarea id="rules-scanner-extensions" rows="3" placeholder="每行一个扩展名，例如 .mp4"></textarea>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
            <button class="primary-btn" id="scanner-modal-cancel" type="button" style="background:#111827;">取消</button>
            <button class="primary-btn" id="scanner-modal-save" type="button">关闭</button>
          </div>
        </div>
      </div>
      <div id="nfo-modal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.8);z-index:40;align-items:center;justify-content:center;">
        <div style="margin:0 auto;max-width:640px;width:100%;background:#020617;border-radius:12px;border:1px solid #1f2937;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
          <div class="panel-title" style="margin-bottom:4px;">NFO 自定义字段</div>
          <div class="panel-desc" style="margin-bottom:10px;">每行一个字段，例如 {genre}。</div>
          <div class="grid-two">
            <div class="field">
              <label for="rules-nfo-genres" style="font-size:11px;">自定义分类字段</label>
              <textarea id="rules-nfo-genres" rows="3" placeholder="每行一个字段，例如 {genre}"></textarea>
            </div>
            <div class="field">
              <label for="rules-nfo-tags" style="font-size:11px;">自定义标签字段</label>
              <textarea id="rules-nfo-tags" rows="3" placeholder="每行一个字段，例如 {genre}"></textarea>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
            <button class="primary-btn" id="nfo-modal-cancel" type="button" style="background:#111827;">取消</button>
            <button class="primary-btn" id="nfo-modal-save" type="button">关闭</button>
          </div>
        </div>
      </div>
    </main>
  </div>

    <script src="/static/xterm.js"></script>
  <script>
    (function () {
      // 浮动窗口工具函数
      window.showModal = function(title, content, buttons = []) {
        return new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.style.cssText = 'display:flex;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:100;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
            <div style="background:#111827;border:1px solid #1f2937;border-radius:12px;padding:20px;max-width:500px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,0.6);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <div style="font-size:16px;font-weight:600;color:#e5e7eb;">${title}</div>
                <button class="modal-close-btn" style="border:none;background:transparent;color:#9ca3af;font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;">&times;</button>
              </div>
              <div style="color:#9ca3af;font-size:14px;margin-bottom:20px;line-height:1.5;">${content}</div>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                ${buttons.map((btn, idx) => `<button class="modal-btn-${idx}" style="padding:8px 16px;border-radius:6px;border:1px solid #374151;background:${btn.primary ? '#3b82f6' : 'transparent'};color:${btn.primary ? '#f9fafb' : '#9ca3af'};font-size:13px;cursor:pointer;">${btn.text}</button>`).join('')}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          const closeModal = (result) => {
            document.body.removeChild(modal);
            resolve(result);
          };
          
          modal.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(false));
          buttons.forEach((btn, idx) => {
            modal.querySelector(`.modal-btn-${idx}`).addEventListener('click', () => closeModal(btn.result !== undefined ? btn.result : true));
          });
          
          // 点击背景关闭
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(false);
          });
        });
      };
      
      window.showAlert = function(message, title = '提示') {
        return window.showModal(title, message, [{ text: '确定', primary: true }]);
      };
      
      window.showConfirm = function(message, title = '确认') {
        return window.showModal(title, message, [
          { text: '取消', primary: false, result: false },
          { text: '确定', primary: true, result: true }
        ]);
      };
      
      const views = ['manual','watch','schedule','rules','history','cookiecloud','account'];
      const navButtons = document.querySelectorAll('.nav-btn');
      const titleMap = {
        manual: ['手动刮削', '从 /video 选择具体影片文件，按顺序触发手动刮削任务。'],
        watch: ['监控刮削', '监控目录中新文件并自动触发刮削任务。'],
        schedule: ['定时刮削', '按计划定期触发刮削任务。'],
        rules: ['全局规则', '管理 JavSP 的全局配置规则。'],
        history: ['刮削历史', '查看历史任务与结果。'],
        cookiecloud: ['CookieCloud', '配置 CookieCloud 以同步站点登录状态。'],
        account: ['账号与安全', '修改 Web 登录凭据。']
      };

      const contentTitle = document.getElementById('content-title');
      const contentSubtitle = document.getElementById('content-subtitle');
      const userPill = document.getElementById('user-pill');
      const versionLabel = document.getElementById('version');
      const logoutBtn = document.getElementById('logout-btn');
      let manualLogContainer = document.getElementById('manual-log-container');
      const manualLogTermEl = null; // 不再使用xterm，改用可展开收起的结构
      const manualLogStatusEl = document.getElementById('manual-log-status');
      const manualLogCopyBtn = null; // 按钮已移除，保持兼容性防止未定义
      
      // 复制任务日志函数 - 复制原始未过滤的日志
      window.copyTaskLog = async function(taskId) {
        try {
          // 从后端获取原始日志流（offset=0 获取全部）
          const safeTaskId = encodeURIComponent(String(taskId));
          const response = await fetch(`/api/tasks/${safeTaskId}/logstream?offset=0`);
          if (!response.ok) {
            throw new Error('获取日志失败');
          }
          const data = await response.json();
          const logText = data.chunk || '';
          
          const textToCopy = (logText || '').trim();
          if (!textToCopy) {
            window.showAlert('当前没有可复制的日志');
            return;
          }
          
          const fallbackCopy = () => {
              const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
              textArea.style.position = 'fixed';
              textArea.style.opacity = '0';
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand('copy');
                window.showAlert('原始日志已复制到剪贴板');
              } catch (e) {
                window.showAlert('复制失败，请手动复制');
              }
              document.body.removeChild(textArea);
          };

          // 优先使用 Clipboard API，若不可用则回退
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(textToCopy).then(() => {
              window.showAlert('原始日志已复制到剪贴板');
            }).catch(err => {
              console.error('复制失败:', err);
              fallbackCopy();
            });
          } else {
            fallbackCopy();
          }
        } catch (err) {
          console.error('获取日志失败:', err);
          window.showAlert('获取日志失败，请稍后重试');
        }
      };
      
      // 删除任务日志函数
      window.deleteTaskLog = async function(taskId) {
        // 解码任务路径用于显示
        const decodeTaskPath = (taskId) => {
          try {
            const parts = String(taskId).split('_');
            if (parts.length >= 2) {
              let pathEncoded = parts[0].replace(/_/g, '/').replace(/-/g, '+');
              while (pathEncoded.length % 4 !== 0) {
                pathEncoded += '=';
              }
              return atob(pathEncoded);
            }
          } catch (e) {
            console.warn('解码任务路径失败:', e);
          }
          return null;
        };
        const decodedPath = decodeTaskPath(taskId) || taskId;
        const confirmed = await window.showConfirm('确定要删除任务 ' + decodedPath + ' 的日志吗？此操作不可恢复。', '删除日志');
        if (!confirmed) {
          return;
        }
        try {
          const safeTaskId = encodeURIComponent(String(taskId));
          const response = await fetch(`/api/tasks/${safeTaskId}/logs`, {
            method: 'DELETE'
          });
          if (!response.ok) {
            throw new Error('删除日志失败');
          }
          const data = await response.json();
          if (data.success) {
            // 从内存中移除任务日志
            allTaskLogs.delete(taskId);
            // 从DOM中移除对应的log-task-group元素
            const taskGroup = document.querySelector(`.log-task-group[data-task-id="${String(taskId).replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"]`);
            if (taskGroup) {
              taskGroup.remove();
            }
            // 重新渲染日志列表（如果没有其他任务，显示占位符）
            if (allTaskLogs.size === 0) {
              if (manualLogContainer) {
                manualLogContainer.innerHTML = '<div class="placeholder">暂无日志</div>';
              }
            } else {
            renderCollapsibleLogs();
            }
            window.showAlert('日志已删除');
          } else {
            throw new Error(data.error || '删除失败');
          }
        } catch (err) {
          console.error('删除日志失败:', err);
          window.showAlert('删除日志失败：' + (err.message || '请稍后重试'));
        }
      };

      // 取消任务（排队或运行中）
      window.cancelTask = async function(taskId) {
        try {
          const safeTaskId = encodeURIComponent(String(taskId));
          const resp = await fetch(`/api/tasks/${safeTaskId}/cancel`, { method: 'POST' });
          if (!resp.ok) throw new Error('取消失败');
          const data = await resp.json();
          window.showAlert(data.status === 'cancelled' ? '已从队列移除' : '已发送取消信号');
          // 更新内存状态并重绘
          const taskData = allTaskLogs.get(taskId);
          if (taskData) {
            taskData.status = 'FAILED';
            allTaskLogs.set(taskId, taskData);
            renderCollapsibleLogs();
          }
        } catch (err) {
          console.error('取消任务失败:', err);
          window.showAlert('取消任务失败：' + (err.message || '请稍后重试'));
        }
      };
      
      const manualProgressBox = document.getElementById('manual-progress');
      const manualProgressMovieEl = document.getElementById('manual-progress-movie');
      const manualProgressStepEl = document.getElementById('manual-progress-step');
      const manualTaskTableBody = document.getElementById('manual-task-tbody');
      const manualHint = document.getElementById('manual-hint');
      const manualCancelBtn = document.getElementById('manual-cancel');

      const rulesStatus = document.getElementById('rules-status');

      // scanner
      const rulesScannerMinimumSize = document.getElementById('rules-scanner-minimum-size');
      const chipsScannerIgnoredIdList = document.getElementById('chips-scanner-ignored-id');
      const chipsScannerIgnoredIdInput = document.getElementById('chips-input-scanner-ignored-id');
      const chipsScannerIgnoredFoldersList = document.getElementById('chips-scanner-ignored-folders');
      const chipsScannerIgnoredFoldersInput = document.getElementById('chips-input-scanner-ignored-folders');
      const chipsScannerExtensionsList = document.getElementById('chips-scanner-extensions');
      const chipsScannerExtensionsInput = document.getElementById('chips-input-scanner-extensions');
      const rulesScannerSkipNfo = document.getElementById('rules-scanner-skip-nfo');

      // network & crawler
      const rulesNetworkProxy = document.getElementById('rules-network-proxy');
      const rulesNetworkRetry = document.getElementById('rules-network-retry');
      const rulesNetworkTimeout = document.getElementById('rules-network-timeout');
      const rulesCookieCloudEnabled = document.getElementById('rules-cookiecloud-enabled');
      const rulesCookieCloudServerUrl = document.getElementById('rules-cookiecloud-server-url');
      const rulesCookieCloudUuid = document.getElementById('rules-cookiecloud-uuid');
      const rulesCookieCloudPassword = document.getElementById('rules-cookiecloud-password');
      const cookiecloudSaveBtn = document.getElementById('cookiecloud-save');
      const cookiecloudStatus = document.getElementById('cookiecloud-status');
      const proxyfreeModal = document.getElementById('proxyfree-modal');
      const proxyfreeOpenBtn = document.getElementById('rules-proxyfree-open');
      const proxyfreeCancelBtn = document.getElementById('proxyfree-cancel');
      const proxyfreeSaveBtn = document.getElementById('proxyfree-save');
      const rulesProxyFreeJavbus = document.getElementById('rules-proxyfree-javbus');
      const rulesProxyFreeJavdb = document.getElementById('rules-proxyfree-javdb');
      const rulesProxyFreeJavlib = document.getElementById('rules-proxyfree-javlib');
      const rulesProxyFreeAvsox = document.getElementById('rules-proxyfree-avsox');
      const rulesCrawlerRequiredKeys = document.getElementById('rules-crawler-required-keys');
      const rulesCrawlerHardworking = document.getElementById('rules-crawler-hardworking');
      const rulesCrawlerRespectId = document.getElementById('rules-crawler-respect-id');
      const rulesCrawlerUseJavdbCover = document.getElementById('rules-crawler-use-javdb-cover');
      const rulesCrawlerNormalizeActress = document.getElementById('rules-crawler-normalize-actress');
      const rulesCrawlerFc2fanPath = document.getElementById('rules-crawler-fc2fan-path');
      const rulesCrawlerSleepAfter = document.getElementById('rules-crawler-sleep-after');
      const chipsCrawlerSelectionNormalList = document.getElementById('chips-crawler-selection-normal');
      const chipsCrawlerSelectionNormalInput = document.getElementById('chips-input-crawler-selection-normal');
      const chipsCrawlerSelectionFc2List = document.getElementById('chips-crawler-selection-fc2');
      const chipsCrawlerSelectionFc2Input = document.getElementById('chips-input-crawler-selection-fc2');
      const chipsCrawlerSelectionCidList = document.getElementById('chips-crawler-selection-cid');
      const chipsCrawlerSelectionCidInput = document.getElementById('chips-input-crawler-selection-cid');
      const chipsCrawlerSelectionGetchuList = document.getElementById('chips-crawler-selection-getchu');
      const chipsCrawlerSelectionGetchuInput = document.getElementById('chips-input-crawler-selection-getchu');
      const chipsCrawlerSelectionGyuttoList = document.getElementById('chips-crawler-selection-gyutto');
      const chipsCrawlerSelectionGyuttoInput = document.getElementById('chips-input-crawler-selection-gyutto');

      // summarizer.path & defaults & nfo & cover
      const rulesSummarizerMoveFiles = document.getElementById('rules-summarizer-move-files');
      const rulesPathOutput = document.getElementById('rules-path-output');
      const rulesPathBasename = document.getElementById('rules-path-basename');
      const rulesPathLengthMax = document.getElementById('rules-path-length-max');
      const rulesPathLengthByByte = document.getElementById('rules-path-length-by-byte');
      const rulesPathMaxActress = document.getElementById('rules-path-max-actress');
      const rulesPathHardLink = document.getElementById('rules-path-hard-link');

      const rulesTitleRemoveActor = document.getElementById('rules-title-remove-actor');
      const rulesDefaultTitle = document.getElementById('rules-default-title');
      const rulesDefaultActress = document.getElementById('rules-default-actress');
      const rulesDefaultSeries = document.getElementById('rules-default-series');
      const rulesDefaultDirector = document.getElementById('rules-default-director');
      const rulesDefaultProducer = document.getElementById('rules-default-producer');
      const rulesDefaultPublisher = document.getElementById('rules-default-publisher');

      const rulesNfoBasename = document.getElementById('rules-nfo-basename');
      const rulesNfoTitle = document.getElementById('rules-nfo-title');
      const rulesNfoGenres = document.getElementById('rules-nfo-genres');
      const rulesNfoTags = document.getElementById('rules-nfo-tags');
      const rulesCensorTexts = document.getElementById('rules-censor-texts');

      const rulesCoverBasename = document.getElementById('rules-cover-basename');
      const rulesCoverHighres = document.getElementById('rules-cover-highres');
      const rulesCoverAddLabel = document.getElementById('rules-cover-add-label');

      const rulesExtraFanartsEnabled = document.getElementById('rules-extra-fanarts-enabled');
      const rulesExtraFanartsInterval = document.getElementById('rules-extra-fanarts-interval');
      const rulesFanartBasename = document.getElementById('rules-fanart-basename');

      // translator
      const rulesTranslateEngine = document.getElementById('rules-translate-engine');
      const rulesTranslateTitle = document.getElementById('rules-translate-title');
      const rulesTranslatePlot = document.getElementById('rules-translate-plot');
      const rulesTranslateBaiduAppId = document.getElementById('rules-translate-baidu-appid');
      const rulesTranslateBaiduApiKey = document.getElementById('rules-translate-baidu-apikey');
      const rulesTranslateBingApiKey = document.getElementById('rules-translate-bing-apikey');
      const rulesTranslateClaudeApiKey = document.getElementById('rules-translate-claude-apikey');
      const rulesTranslateOpenAIUrl = document.getElementById('rules-translate-openai-url');
      const rulesTranslateOpenAIApiKey = document.getElementById('rules-translate-openai-apikey');
      const rulesTranslateOpenAIModel = document.getElementById('rules-translate-openai-model');

      // multiline modals
      const nfoModal = document.getElementById('nfo-modal');
      const nfoOpenBtn = document.getElementById('rules-nfo-open');
      const nfoModalCancelBtn = document.getElementById('nfo-modal-cancel');
      const nfoModalSaveBtn = document.getElementById('nfo-modal-save');


      // historyTbody 已移除，改用 history-container
      let proxyfreeSnapshot = null;
      let nfoSnapshot = null;
      let manualLogTaskId = null;
      let manualLogTimer = null;
    let manualLogTerm = null;
      let manualLogLastLinesKey = null;
      let manualLogRawText = '';
      let manualLogOffset = 0;
      // 跟踪已处理的日志行，避免重复添加
      const processedLogLines = new Set();
    let manualMovieProgress = null;
    let manualStepProgress = null;
      // key: movieKey, value: {id, index, total, stepIndex, stepTotal, stepDesc, status, lastLog}
      let manualMovieStates = {};
      let manualMovieIndexSeq = 0;
      let manualCurrentMovieKey = null;
      let rulesLoaded = false;

      function switchView(view) {
        views.forEach(v => {
          const section = document.getElementById('view-' + v);
          if (section) section.style.display = v === view ? 'block' : 'none';
        });
        navButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === view);
        });
        const t = titleMap[view];
        if (t) {
          contentTitle.textContent = t[0];
          contentSubtitle.textContent = t[1];
        }

        if ((view === 'rules' || view === 'cookiecloud') && !rulesLoaded) {
          loadGlobalRules();
        }
        if (view === 'history') {
          loadHistory();
        }
        if (view === 'manual') {
          // 切换到手动刮削视图时刷新文件列表
          loadVideode(videodeCurrentPath || '/video');
        }
      }

      // /videode：按文件刮削浏览与队列执行
      const videodePathEl = document.getElementById('videode-path');
      const videodeTbody = document.getElementById('videode-tbody');
      const videodeHint = document.getElementById('videode-hint');
      const videodeSelectAll = document.getElementById('videode-select-all');
      const videodeRunBtn = document.getElementById('videode-run');
      const videodeRunHint = document.getElementById('videode-run-hint');
      let videodeCurrentPath = '/video';
      let videodeEntries = [];
      let videodeSelected = new Set();

      function fmtSize(bytes) {
        if (bytes == null || bytes < 0) return '';
        const units = ['B','KiB','MiB','GiB','TiB'];
        let s = bytes;
        let i = 0;
        while (s >= 1024 && i < units.length - 1) {
          s /= 1024;
          i++;
        }
        return s.toFixed(2) + ' ' + units[i];
      }

      async function loadVideode(path) {
        videodeCurrentPath = path || '/video';
        if (videodePathEl) videodePathEl.textContent = videodeCurrentPath;
        if (videodeHint) {
          videodeHint.style.color = '#9ca3af';
          videodeHint.textContent = '正在加载目录...';
        }
        try {
          const items = await fetchJSON('/api/tasks/fs/browse?path=' + encodeURIComponent(videodeCurrentPath));
          videodeEntries = Array.isArray(items) ? items : [];
          videodeSelected.clear();
          if (videodeSelectAll) {
            videodeSelectAll.checked = false;
          }

          if (!videodeTbody) return;
          videodeTbody.innerHTML = '';
          videodeEntries.forEach(entry => {
            const tr = document.createElement('tr');

            const tdChk = document.createElement('td');
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.addEventListener('change', () => {
              if (chk.checked) {
                if (!entry.is_dir) {
                  videodeSelected.add(entry.path);
                }
              } else {
                videodeSelected.delete(entry.path);
              }
            });
            // 允许选择文件夹
            if (entry.is_dir) {
              chk.addEventListener('change', async () => {
                if (chk.checked) {
                  // 扫描文件夹下的所有符合条件的文件
                  try {
                    if (videodeHint) {
                      videodeHint.style.color = '#9ca3af';
                      videodeHint.textContent = `正在扫描文件夹 ${entry.name}...`;
                    }
                    const scanResult = await fetchJSON('/api/tasks/fs/scan?path=' + encodeURIComponent(entry.path));
                    const files = scanResult.files || [];
                    files.forEach(filePath => {
                      videodeSelected.add(filePath);
                    });
                    if (videodeHint) {
                      videodeHint.style.color = '#22c55e';
                      videodeHint.textContent = `文件夹 ${entry.name} 扫描完成，找到 ${files.length} 个符合条件的文件`;
                    }
                    // 更新复选框状态
                    const rows = videodeTbody.querySelectorAll('tr');
                    rows.forEach(tr => {
                      const nameBtn = tr.querySelector('button.ghost-btn');
                      if (nameBtn && nameBtn.textContent === entry.name) {
                        const chk = tr.querySelector('input[type="checkbox"]');
                        if (chk) chk.checked = true;
                      }
                    });
                  } catch (err) {
                    console.error('扫描文件夹失败:', err);
                    if (videodeHint) {
                      videodeHint.style.color = '#fca5a5';
                      videodeHint.textContent = `扫描文件夹 ${entry.name} 失败: ${err.message || '未知错误'}`;
                    }
                    chk.checked = false;
                  }
                } else {
                  // 取消选择文件夹时，移除该文件夹下的所有文件
                  const filesToRemove = Array.from(videodeSelected).filter(path => path.startsWith(entry.path + '/'));
                  filesToRemove.forEach(path => videodeSelected.delete(path));
                }
              });
            }
            tdChk.appendChild(chk);

            const tdName = document.createElement('td');
            const nameBtn = document.createElement('button');
            nameBtn.type = 'button';
            nameBtn.textContent = entry.name;
            nameBtn.className = 'ghost-btn';
            nameBtn.style.padding = '2px 6px';
            nameBtn.style.fontSize = '11px';
            nameBtn.addEventListener('click', () => {
              if (entry.is_dir) {
                loadVideode(entry.path);
              }
            });
            tdName.appendChild(nameBtn);

            const tdType = document.createElement('td');
            tdType.textContent = entry.is_dir ? '目录' : '文件';

            const tdSize = document.createElement('td');
            tdSize.textContent = entry.is_dir ? '' : fmtSize(entry.size);

            const tdOp = document.createElement('td');
            if (!entry.is_dir) {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'ghost-btn';
              btn.textContent = '仅刮此文件';
              btn.style.fontSize = '11px';
              btn.addEventListener('click', async () => {
                videodeSelected = new Set([entry.path]);
                if (videodeRunBtn) videodeRunBtn.click();
              });
              tdOp.appendChild(btn);
            }

            tr.appendChild(tdChk);
            tr.appendChild(tdName);
            tr.appendChild(tdType);
            tr.appendChild(tdSize);
            tr.appendChild(tdOp);
            videodeTbody.appendChild(tr);
          });

          if (videodeHint) {
            videodeHint.style.color = '#9ca3af';
            videodeHint.textContent = `共有 ${videodeEntries.length} 个条目，可勾选文件并按顺序刮削。`;
          }
        } catch (err) {
          if (videodeHint) {
            videodeHint.style.color = '#fca5a5';
            videodeHint.textContent = '加载目录失败，请检查 /video 是否已挂载。';
          }
        }
      }

      if (videodeSelectAll && videodeTbody) {
        videodeSelectAll.addEventListener('change', () => {
          const rows = videodeTbody.querySelectorAll('tr');
          videodeSelected.clear();
          rows.forEach(tr => {
            const chk = tr.querySelector('input[type="checkbox"]');
            if (chk && !chk.disabled) {
              chk.checked = videodeSelectAll.checked;
              const nameBtn = tr.querySelector('button.ghost-btn');
              if (chk.checked && nameBtn && nameBtn.textContent) {
                const entry = videodeEntries.find(e => e.name === nameBtn.textContent && !e.is_dir);
                if (entry) {
                  videodeSelected.add(entry.path);
                }
              }
            }
          });
        });
      }

      const videodeUpBtn = document.getElementById('videode-up');
      const videodeRefreshBtn = document.getElementById('videode-refresh');
      if (videodeUpBtn) {
        videodeUpBtn.addEventListener('click', () => {
          if (!videodeCurrentPath || videodeCurrentPath === '/video') return;
          const parent = videodeCurrentPath.replace(/\/+$/,'');
          const idx = parent.lastIndexOf('/');
          const next = idx > 0 ? parent.slice(0, idx) : '/video';
          loadVideode(next || '/video');
        });
      }
      if (videodeRefreshBtn) {
        videodeRefreshBtn.addEventListener('click', () => {
          loadVideode(videodeCurrentPath || '/video');
        });
      }

      async function waitTaskFinished(id) {
        for (;;) {
          try {
            const t = await fetchJSON('/api/tasks/' + id);
            const s = t.status || 'UNKNOWN';
            if (s === 'SUCCEEDED' || s === 'FAILED') {
              return s;
            }
          } catch (e) {
            console.warn(e);
            return 'FAILED';
          }
          await new Promise(r => setTimeout(r, 1000));
        }
      }

      if (videodeRunBtn) {
        videodeRunBtn.addEventListener('click', async () => {
          if (!videodeSelected || videodeSelected.size === 0) {
            if (videodeRunHint) {
              videodeRunHint.style.color = '#fca5a5';
              videodeRunHint.textContent = '请先勾选至少一个文件。';
            }
            return;
          }
          const files = Array.from(videodeSelected);
          files.sort();

          if (videodeRunHint) {
            videodeRunHint.style.color = '#9ca3af';
            videodeRunHint.textContent = `共 ${files.length} 个文件，逐个创建任务（允许排队执行）...`;
          }
          videodeRunBtn.disabled = true;

          const profileSelect = document.getElementById('manual-profile');
          const profile = profileSelect ? (profileSelect.value || 'default') : 'default';

          if (files.length === 0) {
            if (videodeRunHint) {
              videodeRunHint.style.color = '#fca5a5';
              videodeRunHint.textContent = '请先选择要刮削的文件';
            }
            videodeRunBtn.disabled = false;
            return;
          }
          
          let idx = 0;
          for (const filePath of files) {
            idx += 1;
            try {
              if (videodeRunHint) {
                videodeRunHint.style.color = '#9ca3af';
                videodeRunHint.textContent = `(${idx}/${files.length}) 正在创建任务：${filePath}`;
              }
              const task = await fetchJSON('/api/tasks/manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  input_directory: filePath,
                  profile: profile
                })
              });
              
              // 解码任务ID中的路径用于显示
              const decodeTaskPath = (taskId) => {
                try {
                  const parts = String(taskId).split('_');
                  if (parts.length >= 2) {
                    let pathEncoded = parts[0].replace(/_/g, '/').replace(/-/g, '+');
                    while (pathEncoded.length % 4 !== 0) {
                      pathEncoded += '=';
                    }
                    return atob(pathEncoded);
                  }
                } catch (e) {
                  console.warn('解码任务路径失败:', e);
                }
                return null;
              };
              
              // 提取时间戳用于显示
              const getTaskTime = (taskId) => {
                const parts = String(taskId).split('_');
                if (parts.length >= 3) {
                  return `${parts[1]} ${parts[2]}`; // YYYYMMDD HHMMSS
                }
                return String(taskId);
              };
              
              const decodedPath = decodeTaskPath(task.id) || filePath;
              const taskTime = getTaskTime(task.id);
              
              if (videodeRunHint) {
                videodeRunHint.style.color = '#9ca3af';
                videodeRunHint.textContent = `(${idx}/${files.length}) 任务 ${decodedPath} 已创建，已加入队列等待执行，可在下方日志查看/取消。`;
              }
              // 不清空之前的日志，保留所有任务的日志
              startManualLogStreaming(task.id, false);
            } catch (e) {
              console.warn(e);
              if (videodeRunHint) {
                videodeRunHint.style.color = '#fca5a5';
                videodeRunHint.textContent = `(${idx}/${files.length}) 创建任务时出错：${e.message || e}`;
              }
              break;
            }
          }
          
          videodeRunBtn.disabled = false;
        });
      }

      async function loadGlobalRules() {
        if (!rulesStatus) return;
        rulesStatus.style.color = '#9ca3af';
        rulesStatus.textContent = '正在加载当前配置...';
        try {
          const data = await fetchJSON('/api/rules/global');
          const other = data.other || {};
          const scanner = data.scanner || {};
          const network = data.network || {};
          const crawler = data.crawler || {};
          const summarizer = data.summarizer || {};
          const pathCfg = summarizer.path || {};
          const defaultCfg = summarizer.default || {};
          const titleCfg = summarizer.title || {};
          const nfoCfg = summarizer.nfo || {};
          const coverCfg = summarizer.cover || {};
          const extraFanarts = summarizer.extra_fanarts || {};
          const translator = data.translator || {};
          const translateFields = translator.fields || {};
          const translateEngine = translator.engine || null;

          if (rulesScannerMinimumSize && scanner.minimum_size != null) {
            const m = /^([0-9]+)MiB$/i.exec(String(scanner.minimum_size));
            rulesScannerMinimumSize.value = m ? m[1] : '';
          }

          // scanner chips: 初始化为数组
          function initChips(listEl, values) {
            if (!listEl) return;
            listEl.innerHTML = '';
            (values || []).forEach(v => {
              const span = document.createElement('span');
              span.className = 'chip';
              span.textContent = v;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'chip-remove';
              btn.textContent = '×';
              btn.addEventListener('click', () => {
                span.remove();
              });
              span.appendChild(btn);
              listEl.appendChild(span);
            });
          }

          initChips(chipsScannerIgnoredIdList, Array.isArray(scanner.ignored_id_pattern) ? scanner.ignored_id_pattern : []);
          initChips(chipsScannerIgnoredFoldersList, Array.isArray(scanner.ignored_folder_name_pattern) ? scanner.ignored_folder_name_pattern : []);
          initChips(chipsScannerExtensionsList, Array.isArray(scanner.filename_extensions) ? scanner.filename_extensions : []);

          if (rulesScannerSkipNfo && Object.prototype.hasOwnProperty.call(scanner, 'skip_nfo_dir')) {
            rulesScannerSkipNfo.checked = !!scanner.skip_nfo_dir;
          }

          if (rulesNetworkProxy) {
            rulesNetworkProxy.value = network.proxy_server || '';
          }
          if (rulesNetworkRetry && network.retry != null) {
            rulesNetworkRetry.value = String(network.retry);
          }
          if (rulesNetworkTimeout && network.timeout != null) {
            const m2 = /^PT([0-9]+)S$/i.exec(String(network.timeout));
            rulesNetworkTimeout.value = m2 ? m2[1] : '';
          }
          const proxyFree = network.proxy_free || {};
          if (rulesProxyFreeJavbus) rulesProxyFreeJavbus.value = proxyFree.javbus || '';
          if (rulesProxyFreeJavdb) rulesProxyFreeJavdb.value = proxyFree.javdb || '';
          if (rulesProxyFreeJavlib) rulesProxyFreeJavlib.value = proxyFree.javlib || '';
          if (rulesProxyFreeAvsox) rulesProxyFreeAvsox.value = proxyFree.avsox || '';
          // CookieCloud配置
          const cookiecloud = network.cookiecloud || {};
          if (rulesCookieCloudEnabled) rulesCookieCloudEnabled.checked = cookiecloud.enabled || false;
          if (rulesCookieCloudServerUrl) rulesCookieCloudServerUrl.value = cookiecloud.server_url || '';
          if (rulesCookieCloudUuid) rulesCookieCloudUuid.value = cookiecloud.uuid || '';
          if (rulesCookieCloudPassword) rulesCookieCloudPassword.value = cookiecloud.password || '';
          proxyfreeSnapshot = {
            javbus: rulesProxyFreeJavbus ? rulesProxyFreeJavbus.value : '',
            javdb: rulesProxyFreeJavdb ? rulesProxyFreeJavdb.value : '',
            javlib: rulesProxyFreeJavlib ? rulesProxyFreeJavlib.value : '',
            avsox: rulesProxyFreeAvsox ? rulesProxyFreeAvsox.value : ''
          };

          if (rulesCrawlerRequiredKeys && Array.isArray(crawler.required_keys)) {
            rulesCrawlerRequiredKeys.value = crawler.required_keys.join(',');
          }
          if (rulesCrawlerHardworking) {
            rulesCrawlerHardworking.checked = !!crawler.hardworking;
          }
          if (rulesCrawlerRespectId) {
            rulesCrawlerRespectId.checked = !!crawler.respect_site_avid;
          }
          if (rulesCrawlerUseJavdbCover && crawler.use_javdb_cover) {
            rulesCrawlerUseJavdbCover.value = String(crawler.use_javdb_cover);
          }
          if (rulesCrawlerNormalizeActress) {
            rulesCrawlerNormalizeActress.checked = !!crawler.normalize_actress_name;
          }

          if (rulesCrawlerFc2fanPath && Object.prototype.hasOwnProperty.call(crawler, 'fc2fan_local_path')) {
            rulesCrawlerFc2fanPath.value = crawler.fc2fan_local_path || '';
          }
          if (rulesCrawlerSleepAfter && crawler.sleep_after_scraping != null) {
            rulesCrawlerSleepAfter.value = String(crawler.sleep_after_scraping);
          }

          const selection = crawler.selection || {};
          initChips(chipsCrawlerSelectionNormalList, Array.isArray(selection.normal) ? selection.normal : []);
          initChips(chipsCrawlerSelectionFc2List, Array.isArray(selection.fc2) ? selection.fc2 : []);
          initChips(chipsCrawlerSelectionCidList, Array.isArray(selection.cid) ? selection.cid : []);
          initChips(chipsCrawlerSelectionGetchuList, Array.isArray(selection.getchu) ? selection.getchu : []);
          initChips(chipsCrawlerSelectionGyuttoList, Array.isArray(selection.gyutto) ? selection.gyutto : []);

          if (rulesSummarizerMoveFiles) {
            rulesSummarizerMoveFiles.checked = !!summarizer.move_files;
          }
          if (rulesPathOutput && pathCfg.output_folder_pattern != null) {
            rulesPathOutput.value = pathCfg.output_folder_pattern;
          }
          if (rulesPathBasename && pathCfg.basename_pattern != null) {
            rulesPathBasename.value = pathCfg.basename_pattern;
          }
          if (rulesPathLengthMax && pathCfg.length_maximum != null) {
            rulesPathLengthMax.value = String(pathCfg.length_maximum);
          }
          if (rulesPathLengthByByte) {
            rulesPathLengthByByte.checked = !!pathCfg.length_by_byte;
          }
          if (rulesPathMaxActress && pathCfg.max_actress_count != null) {
            rulesPathMaxActress.value = String(pathCfg.max_actress_count);
          }
          if (rulesPathHardLink) {
            rulesPathHardLink.checked = !!pathCfg.hard_link;
          }

          if (rulesTitleRemoveActor) {
            rulesTitleRemoveActor.checked = !!titleCfg.remove_trailing_actor_name;
          }
          if (rulesDefaultTitle && defaultCfg.title != null) rulesDefaultTitle.value = defaultCfg.title;
          if (rulesDefaultActress && defaultCfg.actress != null) rulesDefaultActress.value = defaultCfg.actress;
          if (rulesDefaultSeries && defaultCfg.series != null) rulesDefaultSeries.value = defaultCfg.series;
          if (rulesDefaultDirector && defaultCfg.director != null) rulesDefaultDirector.value = defaultCfg.director;
          if (rulesDefaultProducer && defaultCfg.producer != null) rulesDefaultProducer.value = defaultCfg.producer;
          if (rulesDefaultPublisher && defaultCfg.publisher != null) rulesDefaultPublisher.value = defaultCfg.publisher;

          if (rulesNfoBasename && nfoCfg.basename_pattern != null) rulesNfoBasename.value = nfoCfg.basename_pattern;
          if (rulesNfoTitle && nfoCfg.title_pattern != null) rulesNfoTitle.value = nfoCfg.title_pattern;
          if (rulesNfoGenres && Array.isArray(nfoCfg.custom_genres_fields)) {
            rulesNfoGenres.value = nfoCfg.custom_genres_fields.join('\n');
          }
          if (rulesNfoTags && Array.isArray(nfoCfg.custom_tags_fields)) {
            rulesNfoTags.value = nfoCfg.custom_tags_fields.join('\n');
          }
          if (rulesCensorTexts && Array.isArray(summarizer.censor_options_representation)) {
            rulesCensorTexts.value = summarizer.censor_options_representation.join(',');
          }

          if (rulesCoverBasename && coverCfg.basename_pattern != null) rulesCoverBasename.value = coverCfg.basename_pattern;
          if (rulesCoverHighres) rulesCoverHighres.checked = !!coverCfg.highres;
          if (rulesCoverAddLabel) rulesCoverAddLabel.checked = !!coverCfg.add_label;

          if (rulesExtraFanartsEnabled) {
            rulesExtraFanartsEnabled.checked = !!extraFanarts.enabled;
          }
          if (rulesExtraFanartsInterval && extraFanarts.scrap_interval != null) {
            rulesExtraFanartsInterval.value = extraFanarts.scrap_interval;
          }

          if (rulesFanartBasename && summarizer.fanart && summarizer.fanart.basename_pattern != null) {
            rulesFanartBasename.value = summarizer.fanart.basename_pattern;
          }

          if (rulesTranslateTitle) {
            rulesTranslateTitle.checked = !!translateFields.title;
          }
          if (rulesTranslatePlot) {
            rulesTranslatePlot.checked = !!translateFields.plot;
          }

          if (rulesTranslateEngine) {
            const engineName = translateEngine && translateEngine.name ? translateEngine.name : 'disabled';
            rulesTranslateEngine.value = engineName;

            if (engineName === 'baidu') {
              if (rulesTranslateBaiduAppId && translateEngine.app_id != null) {
                rulesTranslateBaiduAppId.value = translateEngine.app_id;
              }
              if (rulesTranslateBaiduApiKey && translateEngine.api_key != null) {
                rulesTranslateBaiduApiKey.value = translateEngine.api_key;
              }
            }

            if (engineName === 'bing') {
              if (rulesTranslateBingApiKey && translateEngine.api_key != null) {
                rulesTranslateBingApiKey.value = translateEngine.api_key;
              }
            }

            if (engineName === 'claude') {
              if (rulesTranslateClaudeApiKey && translateEngine.api_key != null) {
                rulesTranslateClaudeApiKey.value = translateEngine.api_key;
              }
            }

            if (engineName === 'openai') {
              if (rulesTranslateOpenAIUrl && translateEngine.url != null) {
                rulesTranslateOpenAIUrl.value = String(translateEngine.url);
              }
              if (rulesTranslateOpenAIApiKey && translateEngine.api_key != null) {
                rulesTranslateOpenAIApiKey.value = translateEngine.api_key;
              }
              if (rulesTranslateOpenAIModel && translateEngine.model != null) {
                rulesTranslateOpenAIModel.value = translateEngine.model;
              }
            }
          }

          rulesLoaded = true;
          // 初次加载后，根据当前引擎更新详细字段显隐
          updateTranslateEngineFields();
          rulesStatus.style.color = '#9ca3af';
          rulesStatus.textContent = '已加载当前配置。';
        } catch (res) {
          rulesStatus.style.color = '#fca5a5';
          if (res && res.status === 401) {
            window.location.href = '/login';
          } else {
            rulesStatus.textContent = '加载配置失败，请稍后重试。';
          }
        }
      }

      // 格式化任务ID显示
      function formatTaskId(taskId) {
        if (!taskId || taskId === '-') return taskId;
        const parts = String(taskId).split('_');
        if (parts.length >= 3) {
          return `${parts[1]} ${parts[2]}`; // YYYYMMDD HHMMSS
        }
        return String(taskId);
      }
      
      // 历史记录分页和筛选状态
      let historyPage = 1;
      let historyPageSize = 11;
      let historyAllItems = [];
      let historyFilteredItems = [];
      let historyFilters = {
        status: '',
        path: '',
        profile: ''
      };
      
      async function loadHistory() {
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        if (!historyContainer) return;
        if (historyPlaceholder) {
          historyPlaceholder.textContent = '正在加载...';
        }
        try {
          // 加载所有历史记录（不限制数量，用于前端筛选和分页）
          const items = await fetchJSON('/api/tasks/history?limit=10000');
          historyAllItems = items || [];
          applyHistoryFilters();
        } catch (err) {
          console.error('加载历史记录失败:', err);
          if (historyPlaceholder) {
            historyPlaceholder.textContent = '加载失败，请稍后重试';
            historyPlaceholder.style.display = 'block';
          }
          historyContainer.innerHTML = '';
          return;
        }
      }
      
      function applyHistoryFilters() {
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        if (!historyContainer) return;
        
        // 应用筛选
        historyFilteredItems = historyAllItems.filter(item => {
          // 状态筛选
          if (historyFilters.status) {
            if (historyFilters.status === 'success') {
              // 成功：有保存目录且不为空
              if (!item.save_dir || !item.save_dir.trim()) return false;
            } else if (historyFilters.status === 'failed') {
              // 失败：没有保存目录或为空
              if (item.save_dir && item.save_dir.trim()) return false;
            }
          }
          
          // 路径筛选
          if (historyFilters.path) {
            const pathLower = historyFilters.path.toLowerCase();
            const saveDir = (item.save_dir || '').toLowerCase();
            const sourceFiles = (item.source_files || []).join(' ').toLowerCase();
            if (!saveDir.includes(pathLower) && !sourceFiles.includes(pathLower)) {
              return false;
            }
          }
          
          // 规则筛选（从task_id中提取，或使用profile字段）
          if (historyFilters.profile) {
            const profileLower = historyFilters.profile.toLowerCase();
            // 目前历史记录中没有profile字段，可以从task_id或其他字段推断
            // 暂时跳过此筛选，或根据实际需求实现
          }
          
          return true;
        });
        
        // 排序
        historyFilteredItems.sort((a, b) => {
          const timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
          const timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
          return timeB - timeA;
        });
        
        // 重置到第一页
        historyPage = 1;
        renderHistoryPage();
      }
      
      async function renderHistoryPage() {
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        if (!historyContainer) return;
        
        if (!historyFilteredItems || historyFilteredItems.length === 0) {
          if (historyPlaceholder) {
            historyPlaceholder.textContent = '暂无记录';
            historyPlaceholder.style.display = 'block';
          }
          historyContainer.innerHTML = '';
          updateHistoryPagination();
          return;
        }
        
        if (historyPlaceholder) {
          historyPlaceholder.style.display = 'none';
        }
        
        // 计算分页
        const totalPages = Math.ceil(historyFilteredItems.length / historyPageSize);
        const startIndex = (historyPage - 1) * historyPageSize;
        const endIndex = startIndex + historyPageSize;
        const pageItems = historyFilteredItems.slice(startIndex, endIndex);
        
        // 渲染当前页
        const cards = await Promise.all(pageItems.map(async (item, index) => {
            const created = item.created_at ? new Date(item.created_at) : null;
            const timeText = created ? created.toLocaleString() : '-';
            // 格式化任务ID（新格式：pathhash_YYYYMMDD_HHMMSS）
            let taskId = item.task_id != null ? String(item.task_id) : '-';
            if (taskId !== '-') {
              const parts = taskId.split('_');
              if (parts.length >= 3) {
                taskId = `${parts[1]} ${parts[2]}`; // YYYYMMDD HHMMSS
              }
            }
            const name = item.display_name || item.dvdid || item.cid || '-';
            const saveDir = item.save_dir || '-';
            const safeSaveDir = String(saveDir).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // 解析NFO
            let nfoData = null;
            if (item.nfo_file) {
              try {
                const nfoPath = item.nfo_file.replace(/\\/g, '/');
                const nfoResponse = await fetch('/api/files?path=' + encodeURIComponent(nfoPath));
                if (!nfoResponse.ok) {
                  // 文件不存在或无法访问，跳过NFO解析
                  console.warn('无法加载NFO文件:', nfoPath, nfoResponse.status);
                } else {
                  const nfoText = await nfoResponse.text();
                  const parser = new DOMParser();
                  const xmlDoc = parser.parseFromString(nfoText, 'text/xml');
                  const titleEl = xmlDoc.querySelector('title');
                  const plotEl = xmlDoc.querySelector('plot');
                  const uniqueidEl = xmlDoc.querySelector('uniqueid[default="true"]');
                  const genreEls = xmlDoc.querySelectorAll('genre');
                  const tagEls = xmlDoc.querySelectorAll('tag');
                  const premieredEl = xmlDoc.querySelector('premiered');
                  const studioEl = xmlDoc.querySelector('studio');
                  const mpaaEl = xmlDoc.querySelector('mpaa');
                  
                  nfoData = {
                    title: titleEl ? titleEl.textContent : '',
                    plot: plotEl ? plotEl.textContent : '',
                    dvdid: uniqueidEl ? uniqueidEl.textContent : '',
                    genres: Array.from(genreEls).map(el => el.textContent).filter((v, i, a) => a.indexOf(v) === i),
                    tags: Array.from(tagEls).map(el => el.textContent).filter((v, i, a) => a.indexOf(v) === i),
                    premiered: premieredEl ? premieredEl.textContent : '',
                    studio: studioEl ? studioEl.textContent : '',
                    mpaa: mpaaEl ? mpaaEl.textContent : ''
                  };
                }
              } catch (e) {
                console.warn('解析NFO失败:', e);
              }
            }
            
            // 封面图片 - 优先使用poster_file，如果没有则从save_dir推断
            let posterImg = '';
            let posterPath = null;
            // 优先使用poster_file字段
            if (item.poster_file) {
              posterPath = item.poster_file.replace(/\\/g, '/');
            } else if (item.save_dir) {
              // 如果没有poster_file，从save_dir推断
              const saveDir = item.save_dir.replace(/\\/g, '/');
              // 常见的封面文件名，按优先级尝试
              const posterNames = ['poster.jpg', 'cover.jpg', 'folder.jpg', 'thumb.jpg'];
              // 先尝试poster.jpg（最常见）
              posterPath = saveDir + '/poster.jpg';
            }
            
            // 封面/剧照下载状态标识（色块）- 显示在保存路径下面
            // 封面：根据cover_download_success和cover_download_count显示
            let coverBlocks = '';
            if (item.cover_download_success === true) {
              // 封面成功显示绿色色块
              const count = item.cover_download_count || 1;
              coverBlocks = Array(count).fill('<div style="width:12px;height:12px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="封面下载成功"></div>').join('');
            } else if (item.cover_download_success === false) {
              // 封面失败显示灰色色块
              coverBlocks = '<div style="width:12px;height:12px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="封面下载失败"></div>';
            } else {
              // 封面未知显示深灰色色块
              coverBlocks = '<div style="width:12px;height:12px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="封面下载未知"></div>';
            }
            
            // 剧照：根据fanart_download_results显示每个剧照的状态
            let fanartBlocks = '';
            if (item.fanart_download_results && Array.isArray(item.fanart_download_results) && item.fanart_download_results.length > 0) {
              // 有详细的下载结果列表，为每个剧照显示一个色块
              fanartBlocks = item.fanart_download_results.map((success, idx) => {
                const color = success ? '#22c55e' : '#6b7280';
                const title = success ? `剧照${idx + 1}下载成功` : `剧照${idx + 1}下载失败`;
                return `<div style="width:12px;height:12px;background:${color};border-radius:2px;flex-shrink:0;" title="${title}"></div>`;
              }).join('');
            } else if (item.fanart_download_success === true) {
              // 没有详细结果但有总数，显示成功数量的绿色色块
              const count = item.fanart_download_count || 0;
              if (count > 0) {
                fanartBlocks = Array(count).fill('<div style="width:12px;height:12px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
              }
            } else if (item.fanart_download_success === false) {
              // 剧照下载失败
              const totalCount = (item.fanart_download_count || 0) + (item.fanart_download_failed_count || 0);
              if (totalCount > 0) {
                // 显示成功和失败的色块
                const successBlocks = Array(item.fanart_download_count || 0).fill('<div style="width:12px;height:12px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
                const failedBlocks = Array(item.fanart_download_failed_count || 0).fill('<div style="width:12px;height:12px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>').join('');
                fanartBlocks = successBlocks + failedBlocks;
              } else {
                fanartBlocks = '<div style="width:12px;height:12px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>';
              }
            } else {
              // 剧照未知显示深灰色色块
              fanartBlocks = '<div style="width:12px;height:12px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="剧照下载未知"></div>';
            }
            
            const downloadStatusBlocks = coverBlocks || fanartBlocks ? `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;align-items:center;font-size:11px;color:#9ca3af;">
              ${coverBlocks ? `<div style="display:flex;align-items:center;gap:4px;">封面：${coverBlocks}</div>` : ''}
              ${fanartBlocks ? `<div style="display:flex;align-items:center;gap:4px;">剧照：${fanartBlocks}</div>` : ''}
            </div>` : '';
            
            // 使用的爬虫
            let crawlersInfo = '';
            if (item.used_crawlers && item.used_crawlers.length > 0) {
              crawlersInfo = `<div style="font-size:11px;color:#9ca3af;margin-top:4px;">爬虫: ${item.used_crawlers.join(', ')}</div>`;
            }
            
            // 剧照按钮 - 从save_dir中提取extrafanart目录，显示在封面内部右下角
            let fanartBtn = '';
            let fanartDir = item.extrafanart_dir;
            if (!fanartDir && item.save_dir) {
              // 从save_dir中推断extrafanart目录（通常是save_dir/extrafanart）
              const saveDir = item.save_dir.replace(/\\/g, '/');
              fanartDir = saveDir + '/extrafanart';
            }
            if (fanartDir) {
              const fanartDirPath = fanartDir.replace(/\\/g, '/');
              fanartBtn = `<button class="ghost-btn history-fanart-btn" data-fanart-dir="${fanartDirPath.replace(/"/g, '&quot;')}" style="position:absolute;bottom:8px;right:8px;font-size:16.5px;padding:6px 12px;background:rgba(17,24,39,0.9);border:1px solid #374151;color:#e5e7eb;border-radius:6px;cursor:pointer;z-index:10;" onclick="event.stopPropagation();window.showFanartModal('${fanartDirPath.replace(/'/g, "\\'")}')">查看剧照</button>`;
            }
            
            if (posterPath) {
              const finalPath = posterPath.replace(/\\/g, '/');
              posterImg = `<div style="position:relative;width:200px;height:280px;flex-shrink:0;">
                <img src="/api/files?path=${encodeURIComponent(finalPath)}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                <div style="display:none;width:200px;height:280px;background:#111827;border-radius:8px;align-items:center;justify-content:center;color:#6b7280;font-size:12px;">无封面</div>
                ${fanartBtn}
              </div>`;
            } else {
              posterImg = `<div style="position:relative;width:200px;height:280px;flex-shrink:0;">
                <div style="width:200px;height:280px;background:#111827;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;">无封面</div>
                ${fanartBtn}
              </div>`;
            }
            
            // NFO信息显示（使用图标）
            let nfoInfoHtml = '';
            if (nfoData) {
              const infoItems = [];
              if (nfoData.title) {
                infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">标题:</span><span style="flex:1;">${nfoData.title}</span></div>`);
              }
              if (nfoData.dvdid) {
                infoItems.push(`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">番号:</span><span>${nfoData.dvdid}</span></div>`);
              }
              if (nfoData.premiered) {
                infoItems.push(`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">发布日期:</span><span>${nfoData.premiered}</span></div>`);
              }
              if (nfoData.studio) {
                infoItems.push(`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">制作商:</span><span>${nfoData.studio}</span></div>`);
              }
              if (nfoData.mpaa) {
                infoItems.push(`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">分级:</span><span>${nfoData.mpaa}</span></div>`);
              }
              if (nfoData.genres && nfoData.genres.length > 0) {
                infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-bottom:6px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">类型:</span><div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;">${nfoData.genres.map(g => `<span style="padding:2px 6px;background:#111827;border-radius:4px;font-size:10px;border:1px solid #374151;">${g}</span>`).join('')}</div></div>`);
              }
              if (nfoData.plot) {
                infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:11px;font-weight:600;">简介:</span><div style="flex:1;font-size:11px;color:#9ca3af;line-height:1.5;">${nfoData.plot}</div></div>`);
              }
              if (infoItems.length > 0) {
                nfoInfoHtml = `<div style="margin-top:12px;padding:12px;background:#111827;border-radius:8px;border:1px solid #1f2937;">${infoItems.join('')}</div>`;
              }
            }
            
            return `<div class="history-card" data-history-id="${item.id}" style="border:1px solid #1f2937;border-radius:12px;padding:16px;background:rgba(15,23,42,0.95);position:relative;">
              <input type="checkbox" class="history-item-checkbox" data-history-id="${item.id}" style="position:absolute;top:16px;right:16px;width:18px;height:18px;cursor:pointer;z-index:10;" onchange="updateHistoryButtons()" />
              <div style="display:flex;gap:16px;flex-wrap:wrap;">
                <div style="flex-shrink:0;">
                  ${posterImg}
                </div>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
                    <div style="flex:1;">
                      <div style="font-size:14px;font-weight:600;color:#e5e7eb;margin-bottom:4px;">${name}</div>
                      <div style="font-size:11px;color:#9ca3af;">任务 ${formatTaskId(taskId)} · ${timeText}</div>
                      ${crawlersInfo}
                    </div>
                  </div>
                  <div style="font-size:11px;color:#9ca3af;margin-top:8px;word-break:break-all;">保存路径: ${safeSaveDir}</div>
                  ${downloadStatusBlocks}
                  ${nfoInfoHtml}
                </div>
              </div>
            </div>`;
          }));
          
          // 根据视图模式显示
          const historyGallery = document.getElementById('history-gallery');
          if (historyViewMode === 'gallery' && historyGallery) {
            // 封面墙模式
            historyContainer.style.display = 'none';
            historyGallery.style.display = 'grid';
            const galleryItems = pageItems.map((item) => {
              // 封面图片路径
              let posterPath = null;
              if (item.poster_file) {
                posterPath = item.poster_file.replace(/\\/g, '/');
              } else if (item.save_dir) {
                const saveDir = item.save_dir.replace(/\\/g, '/');
                posterPath = saveDir + '/poster.jpg';
              }
              
              const name = item.display_name || item.dvdid || item.cid || `记录 #${item.id}`;
              const timeText = new Date(item.created_at).toLocaleString('zh-CN');
              const safeItemId = item.id;
              
              // 封面/剧照下载状态标识（色块）
              let coverBlocks = '';
              if (item.cover_download_success === true) {
                const count = item.cover_download_count || 1;
                coverBlocks = Array(count).fill('<div style="width:8px;height:8px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="封面下载成功"></div>').join('');
              } else if (item.cover_download_success === false) {
                coverBlocks = '<div style="width:8px;height:8px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="封面下载失败"></div>';
              } else {
                coverBlocks = '<div style="width:8px;height:8px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="封面下载未知"></div>';
              }
              
              let fanartBlocks = '';
              if (item.fanart_download_results && Array.isArray(item.fanart_download_results) && item.fanart_download_results.length > 0) {
                fanartBlocks = item.fanart_download_results.map((success, idx) => {
                  const color = success ? '#22c55e' : '#6b7280';
                  const title = success ? `剧照${idx + 1}下载成功` : `剧照${idx + 1}下载失败`;
                  return `<div style="width:8px;height:8px;background:${color};border-radius:2px;flex-shrink:0;" title="${title}"></div>`;
                }).join('');
              } else if (item.fanart_download_success === true) {
                const count = item.fanart_download_count || 0;
                if (count > 0) {
                  fanartBlocks = Array(count).fill('<div style="width:8px;height:8px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
                }
              } else if (item.fanart_download_success === false) {
                const totalCount = (item.fanart_download_count || 0) + (item.fanart_download_failed_count || 0);
                if (totalCount > 0) {
                  const successBlocks = Array(item.fanart_download_count || 0).fill('<div style="width:8px;height:8px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
                  const failedBlocks = Array(item.fanart_download_failed_count || 0).fill('<div style="width:8px;height:8px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>').join('');
                  fanartBlocks = successBlocks + failedBlocks;
                } else {
                  fanartBlocks = '<div style="width:8px;height:8px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>';
                }
              } else {
                fanartBlocks = '<div style="width:8px;height:8px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="剧照下载未知"></div>';
              }
              
              const downloadStatusBlocks = (coverBlocks || fanartBlocks) ? `<div style="position:absolute;bottom:8px;left:8px;display:flex;flex-wrap:wrap;gap:4px;align-items:center;font-size:10px;background:rgba(17,24,39,0.9);padding:4px 6px;border-radius:4px;z-index:10;">
                ${coverBlocks ? `<div style="display:flex;align-items:center;gap:2px;">封面：${coverBlocks}</div>` : ''}
                ${fanartBlocks ? `<div style="display:flex;align-items:center;gap:2px;">剧照：${fanartBlocks}</div>` : ''}
              </div>` : '';
              
              // 查看剧照按钮
              let fanartBtn = '';
              let fanartDir = item.extrafanart_dir;
              if (!fanartDir && item.save_dir) {
                const saveDir = item.save_dir.replace(/\\/g, '/');
                fanartDir = saveDir + '/extrafanart';
              }
              if (fanartDir) {
                const fanartDirPath = fanartDir.replace(/\\/g, '/');
                fanartBtn = `<button class="ghost-btn history-fanart-btn" data-fanart-dir="${fanartDirPath.replace(/"/g, '&quot;')}" style="position:absolute;bottom:8px;right:8px;font-size:11px;padding:4px 8px;background:rgba(17,24,39,0.9);border:1px solid #374151;color:#e5e7eb;border-radius:4px;cursor:pointer;z-index:10;" onclick="event.stopPropagation();window.showFanartModal('${fanartDirPath.replace(/'/g, "\\'")}')">查看剧照</button>`;
              }
              
              // 勾选框
              const checkbox = `<input type="checkbox" class="history-item-checkbox" data-history-id="${safeItemId}" style="position:absolute;top:8px;left:8px;width:18px;height:18px;cursor:pointer;z-index:10;background:rgba(17,24,39,0.9);border:1px solid #374151;border-radius:4px;" onchange="updateHistoryButtons()" onclick="event.stopPropagation();" />`;
              
              let posterImg = '';
              if (posterPath) {
                const finalPath = posterPath.replace(/\\/g, '/');
                posterImg = `<div style="position:relative;width:100%;aspect-ratio:2/3;border-radius:8px;overflow:hidden;">
                  <img src="/api/files?path=${encodeURIComponent(finalPath)}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" onclick="showHistoryDetail(${safeItemId})" />
                  <div style="display:none;width:100%;height:100%;background:#111827;align-items:center;justify-content:center;color:#6b7280;font-size:11px;cursor:pointer;" onclick="showHistoryDetail(${safeItemId})">无封面</div>
                  ${checkbox}
                  ${downloadStatusBlocks}
                  ${fanartBtn}
                </div>`;
              } else {
                posterImg = `<div style="position:relative;width:100%;aspect-ratio:2/3;background:#111827;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:11px;cursor:pointer;" onclick="showHistoryDetail(${safeItemId})">
                  ${checkbox}
                  ${downloadStatusBlocks}
                  ${fanartBtn}
                  无封面
                </div>`;
              }
              
              return `<div class="history-gallery-item" data-history-id="${safeItemId}" style="cursor:pointer;" onclick="showHistoryDetail(${safeItemId})">
                ${posterImg}
                <div style="margin-top:8px;font-size:12px;color:#e5e7eb;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${name.replace(/"/g, '&quot;')}">${name}</div>
                <div style="font-size:10px;color:#9ca3af;margin-top:2px;">${timeText}</div>
              </div>`;
            });
            historyGallery.innerHTML = galleryItems.join('');
          } else {
            // 列表模式
            if (historyGallery) historyGallery.style.display = 'none';
            historyContainer.style.display = 'flex';
            historyContainer.innerHTML = cards.join('');
          }
          
          // 更新分页控件
          updateHistoryPagination();
        } catch (res) {
          if (res && res.status === 401) {
            window.location.href = '/login';
            return;
          }
          if (historyPlaceholder) {
            historyPlaceholder.textContent = '加载历史失败，请稍后重试。';
            historyPlaceholder.style.display = 'block';
          }
          historyContainer.innerHTML = '';
          const historyGallery = document.getElementById('history-gallery');
          if (historyGallery) historyGallery.innerHTML = '';
        }
      }
      
      function updateHistoryPagination() {
        const totalPages = Math.ceil(historyFilteredItems.length / historyPageSize);
        const pageInfo = document.getElementById('history-page-info');
        const prevBtn = document.getElementById('history-prev-page');
        const nextBtn = document.getElementById('history-next-page');
        
        if (pageInfo) {
          pageInfo.textContent = `第 ${historyPage} 页，共 ${totalPages || 1} 页（共 ${historyFilteredItems.length} 条）`;
        }
        if (prevBtn) {
          prevBtn.disabled = historyPage <= 1;
        }
        if (nextBtn) {
          nextBtn.disabled = historyPage >= totalPages || totalPages === 0;
        }
      }
      
      // 分页按钮事件
      const historyPrevBtn = document.getElementById('history-prev-page');
      const historyNextBtn = document.getElementById('history-next-page');
      if (historyPrevBtn) {
        historyPrevBtn.addEventListener('click', () => {
          if (historyPage > 1) {
            historyPage--;
            renderHistoryPage();
          }
        });
      }
      if (historyNextBtn) {
        historyNextBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(historyFilteredItems.length / historyPageSize);
          if (historyPage < totalPages) {
            historyPage++;
            renderHistoryPage();
          }
        });
      }
      
      // 筛选功能
      const historyFilterStatus = document.getElementById('history-filter-status');
      const historyFilterPath = document.getElementById('history-filter-path');
      const historyFilterProfile = document.getElementById('history-filter-profile');
      const historyFilterApply = document.getElementById('history-filter-apply');
      const historyFilterClear = document.getElementById('history-filter-clear');
      
      if (historyFilterApply) {
        historyFilterApply.addEventListener('click', () => {
          historyFilters.status = historyFilterStatus ? historyFilterStatus.value : '';
          historyFilters.path = historyFilterPath ? historyFilterPath.value.trim() : '';
          historyFilters.profile = historyFilterProfile ? historyFilterProfile.value.trim() : '';
          applyHistoryFilters();
        });
      }
      
      if (historyFilterClear) {
        historyFilterClear.addEventListener('click', () => {
          if (historyFilterStatus) historyFilterStatus.value = '';
          if (historyFilterPath) historyFilterPath.value = '';
          if (historyFilterProfile) historyFilterProfile.value = '';
          historyFilters = { status: '', path: '', profile: '' };
          applyHistoryFilters();
        });
      }
      
      // 支持回车键应用筛选
      if (historyFilterPath) {
        historyFilterPath.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && historyFilterApply) {
            historyFilterApply.click();
          }
        });
      }
      if (historyFilterProfile) {
        historyFilterProfile.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && historyFilterApply) {
            historyFilterApply.click();
          }
        });
      }
      
      // 显示历史详情浮动框
      let historyDetailCache = {};
      window.showHistoryDetail = async function(historyId) {
        // 创建或显示详情浮动框
        let detailModal = document.getElementById('history-detail-modal');
        if (!detailModal) {
          detailModal = document.createElement('div');
          detailModal.id = 'history-detail-modal';
          detailModal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:50;align-items:center;justify-content:center;overflow-y:auto;padding:20px;';
          detailModal.innerHTML = `
            <div style="background:#111827;border:1px solid #1f2937;border-radius:12px;padding:20px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;position:relative;">
              <button onclick="closeHistoryDetail()" style="position:absolute;top:20px;right:20px;background:transparent;border:none;color:#9ca3af;font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;">&times;</button>
              <div id="history-detail-content"></div>
            </div>
          `;
          document.body.appendChild(detailModal);
        }
        
        detailModal.style.display = 'flex';
        const content = document.getElementById('history-detail-content');
        content.innerHTML = '<div style="color:#9ca3af;font-size:12px;">正在加载...</div>';
        
        try {
          // 从缓存或重新加载
          let item = historyDetailCache[historyId];
          if (!item) {
            const items = await fetchJSON('/api/tasks/history?limit=100');
            item = items.find(i => i.id === historyId);
            if (item) historyDetailCache[historyId] = item;
          }
          
          if (!item) {
            content.innerHTML = '<div style="color:#fca5a5;font-size:12px;">未找到记录</div>';
            return;
          }
          
          // 解析NFO
          let nfoData = null;
          if (item.nfo_file) {
            try {
              const nfoPath = item.nfo_file.replace(/\\/g, '/');
              const nfoResponse = await fetch('/api/files?path=' + encodeURIComponent(nfoPath));
              if (nfoResponse.ok) {
                const nfoText = await nfoResponse.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(nfoText, 'text/xml');
                const titleEl = xmlDoc.querySelector('title');
                const plotEl = xmlDoc.querySelector('plot');
                const uniqueidEl = xmlDoc.querySelector('uniqueid[default="true"]');
                const genreEls = xmlDoc.querySelectorAll('genre');
                const tagEls = xmlDoc.querySelectorAll('tag');
                const premieredEl = xmlDoc.querySelector('premiered');
                const studioEl = xmlDoc.querySelector('studio');
                const mpaaEl = xmlDoc.querySelector('mpaa');
                
                nfoData = {
                  title: titleEl ? titleEl.textContent : '',
                  plot: plotEl ? plotEl.textContent : '',
                  dvdid: uniqueidEl ? uniqueidEl.textContent : '',
                  genres: Array.from(genreEls).map(el => el.textContent).filter((v, i, a) => a.indexOf(v) === i),
                  tags: Array.from(tagEls).map(el => el.textContent).filter((v, i, a) => a.indexOf(v) === i),
                  premiered: premieredEl ? premieredEl.textContent : '',
                  studio: studioEl ? studioEl.textContent : '',
                  mpaa: mpaaEl ? mpaaEl.textContent : ''
                };
              }
            } catch (e) {
              console.warn('解析NFO失败:', e);
            }
          }
          
          // 渲染详情
          const name = item.display_name || item.dvdid || item.cid || `记录 #${item.id}`;
          const timeText = new Date(item.created_at).toLocaleString('zh-CN');
          const saveDir = item.save_dir || '-';
          const safeSaveDir = String(saveDir).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          
          // 封面图片
          let posterPath = null;
          if (item.poster_file) {
            posterPath = item.poster_file.replace(/\\/g, '/');
          } else if (item.save_dir) {
            const saveDirPath = item.save_dir.replace(/\\/g, '/');
            posterPath = saveDirPath + '/poster.jpg';
          }
          
          // 封面/剧照下载状态标识（色块）
          let coverBlocks = '';
          if (item.cover_download_success === true) {
            const count = item.cover_download_count || 1;
            coverBlocks = Array(count).fill('<div style="width:10px;height:10px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="封面下载成功"></div>').join('');
          } else if (item.cover_download_success === false) {
            coverBlocks = '<div style="width:10px;height:10px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="封面下载失败"></div>';
          } else {
            coverBlocks = '<div style="width:10px;height:10px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="封面下载未知"></div>';
          }
          
          let fanartBlocks = '';
          if (item.fanart_download_results && Array.isArray(item.fanart_download_results) && item.fanart_download_results.length > 0) {
            fanartBlocks = item.fanart_download_results.map((success, idx) => {
              const color = success ? '#22c55e' : '#6b7280';
              const title = success ? `剧照${idx + 1}下载成功` : `剧照${idx + 1}下载失败`;
              return `<div style="width:10px;height:10px;background:${color};border-radius:2px;flex-shrink:0;" title="${title}"></div>`;
            }).join('');
          } else if (item.fanart_download_success === true) {
            const count = item.fanart_download_count || 0;
            if (count > 0) {
              fanartBlocks = Array(count).fill('<div style="width:10px;height:10px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
            }
          } else if (item.fanart_download_success === false) {
            const totalCount = (item.fanart_download_count || 0) + (item.fanart_download_failed_count || 0);
            if (totalCount > 0) {
              const successBlocks = Array(item.fanart_download_count || 0).fill('<div style="width:10px;height:10px;background:#22c55e;border-radius:2px;flex-shrink:0;" title="剧照下载成功"></div>').join('');
              const failedBlocks = Array(item.fanart_download_failed_count || 0).fill('<div style="width:10px;height:10px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>').join('');
              fanartBlocks = successBlocks + failedBlocks;
            } else {
              fanartBlocks = '<div style="width:10px;height:10px;background:#6b7280;border-radius:2px;flex-shrink:0;" title="剧照下载失败"></div>';
            }
          } else {
            fanartBlocks = '<div style="width:10px;height:10px;background:#4b5563;border-radius:2px;flex-shrink:0;" title="剧照下载未知"></div>';
          }
          
          const downloadStatusBlocks = (coverBlocks || fanartBlocks) ? `<div style="position:absolute;bottom:8px;left:8px;display:flex;flex-wrap:wrap;gap:4px;align-items:center;font-size:10px;background:rgba(17,24,39,0.9);padding:4px 6px;border-radius:4px;z-index:10;">
            ${coverBlocks ? `<div style="display:flex;align-items:center;gap:2px;">封面：${coverBlocks}</div>` : ''}
            ${fanartBlocks ? `<div style="display:flex;align-items:center;gap:2px;">剧照：${fanartBlocks}</div>` : ''}
          </div>` : '';
          
          // 剧照按钮
          let fanartBtn = '';
          let fanartDir = item.extrafanart_dir;
          if (!fanartDir && item.save_dir) {
            const saveDirPath = item.save_dir.replace(/\\/g, '/');
            fanartDir = saveDirPath + '/extrafanart';
          }
          if (fanartDir) {
            const fanartDirPath = fanartDir.replace(/\\/g, '/');
            fanartBtn = `<button class="ghost-btn" onclick="closeHistoryDetail();showFanartModal('${fanartDirPath.replace(/'/g, "\\'")}')" style="position:absolute;bottom:8px;right:8px;font-size:11px;padding:4px 8px;background:rgba(17,24,39,0.9);border:1px solid #374151;color:#e5e7eb;border-radius:4px;cursor:pointer;z-index:10;">查看剧照</button>`;
          }
          
          let posterImg = '';
          if (posterPath) {
            const finalPath = posterPath.replace(/\\/g, '/');
            posterImg = `<div style="position:relative;width:200px;height:280px;flex-shrink:0;margin-bottom:16px;">
              <img src="/api/files?path=${encodeURIComponent(finalPath)}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
              <div style="display:none;width:100%;height:100%;background:#111827;border-radius:8px;align-items:center;justify-content:center;color:#6b7280;font-size:12px;">无封面</div>
              ${downloadStatusBlocks}
              ${fanartBtn}
            </div>`;
          } else {
            posterImg = `<div style="position:relative;width:200px;height:280px;flex-shrink:0;background:#111827;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;margin-bottom:16px;">
              ${downloadStatusBlocks}
              ${fanartBtn}
              无封面
            </div>`;
          }
          
          // NFO信息
          let nfoInfoHtml = '';
          if (nfoData) {
            const infoItems = [];
            if (nfoData.title) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">标题:</span><div style="flex:1;font-size:12px;color:#e5e7eb;">${nfoData.title}</div></div>`);
            }
            if (nfoData.genres && nfoData.genres.length > 0) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">类型:</span><div style="flex:1;font-size:12px;color:#9ca3af;">${nfoData.genres.join(', ')}</div></div>`);
            }
            if (nfoData.tags && nfoData.tags.length > 0) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">标签:</span><div style="flex:1;font-size:12px;color:#9ca3af;">${nfoData.tags.join(', ')}</div></div>`);
            }
            if (nfoData.premiered) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">发布日期:</span><div style="flex:1;font-size:12px;color:#9ca3af;">${nfoData.premiered}</div></div>`);
            }
            if (nfoData.studio) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">制作商:</span><div style="flex:1;font-size:12px;color:#9ca3af;">${nfoData.studio}</div></div>`);
            }
            if (nfoData.plot) {
              infoItems.push(`<div style="display:flex;align-items:start;gap:6px;margin-top:8px;"><span style="color:#3b82f6;font-size:12px;font-weight:600;">简介:</span><div style="flex:1;font-size:12px;color:#9ca3af;line-height:1.5;">${nfoData.plot}</div></div>`);
            }
            if (infoItems.length > 0) {
              nfoInfoHtml = `<div style="margin-top:12px;padding:12px;background:#111827;border-radius:8px;border:1px solid #1f2937;">${infoItems.join('')}</div>`;
            }
          }
          
          content.innerHTML = `
            <div style="display:flex;gap:20px;flex-wrap:wrap;">
              <div style="flex-shrink:0;">
                ${posterImg}
                ${fanartBtn}
              </div>
              <div style="flex:1;min-width:0;">
                <div style="font-size:18px;font-weight:600;color:#e5e7eb;margin-bottom:8px;">${name}</div>
                <div style="font-size:12px;color:#9ca3af;margin-bottom:12px;">${timeText}</div>
                <div style="font-size:12px;color:#9ca3af;margin-top:12px;word-break:break-all;">保存路径: ${safeSaveDir}</div>
                ${item.dvdid ? `<div style="font-size:12px;color:#9ca3af;margin-top:8px;">番号: ${item.dvdid}</div>` : ''}
                ${item.cid ? `<div style="font-size:12px;color:#9ca3af;margin-top:8px;">CID: ${item.cid}</div>` : ''}
                ${item.used_crawlers && item.used_crawlers.length > 0 ? `<div style="font-size:12px;color:#9ca3af;margin-top:8px;">爬虫: ${item.used_crawlers.join(', ')}</div>` : ''}
                ${nfoInfoHtml}
              </div>
            </div>
          `;
        } catch (e) {
          content.innerHTML = `<div style="color:#fca5a5;font-size:12px;">加载失败: ${e.message}</div>`;
        }
      };
      
      window.closeHistoryDetail = function() {
        const detailModal = document.getElementById('history-detail-modal');
        if (detailModal) {
          detailModal.style.display = 'none';
        }
      };
      
      // 切换历史记录视图（列表/封面墙）
      let historyViewMode = 'list'; // 'list' or 'gallery'
      const historyViewToggle = document.getElementById('history-view-toggle');
      if (historyViewToggle) {
        historyViewToggle.addEventListener('click', function() {
          historyViewMode = historyViewMode === 'list' ? 'gallery' : 'list';
          historyViewToggle.textContent = historyViewMode === 'list' ? '封面墙' : '列表';
          renderHistoryPage();
        });
      }
      
      // 全局变量：存储当前预览的剧照列表和索引
      let currentFanartImages = [];
      let currentFanartIndex = 0;
      
      // 全局函数，确保可以在onclick中调用
      window.showFanartModal = async function(fanartDir) {
        const modal = document.getElementById('fanart-modal');
        const imagesContainer = document.getElementById('fanart-images');
        if (!modal || !imagesContainer) return;
        
        modal.style.display = 'flex';
        imagesContainer.innerHTML = '<div style="color:#9ca3af;font-size:12px;">正在加载剧照...</div>';
        
        try {
          // 获取剧照目录下的文件列表
          const files = await fetchJSON('/api/tasks/fs/browse?path=' + encodeURIComponent(fanartDir));
          const imageFiles = files.filter(f => !f.is_dir && /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)).sort((a, b) => a.name.localeCompare(b.name));
          
          if (imageFiles.length === 0) {
            imagesContainer.innerHTML = '<div style="color:#9ca3af;font-size:12px;">暂无剧照</div>';
            return;
          }
          
          // 保存图片列表供预览使用
          currentFanartImages = imageFiles.map(file => file.path.replace(/\\/g, '/'));
          
          const imageHtml = imageFiles.map((file, index) => {
            const imagePath = file.path.replace(/\\/g, '/');
            return `<img src="/api/files?path=${encodeURIComponent(imagePath)}" style="width:100%;height:auto;object-fit:cover;border-radius:8px;cursor:pointer;" onclick="showFanartPreview(${index})" />`;
          }).join('');
          
          imagesContainer.innerHTML = imageHtml;
        } catch (e) {
          imagesContainer.innerHTML = '<div style="color:#fca5a5;font-size:12px;">加载剧照失败</div>';
        }
      };
      
      // 显示剧照预览
      window.showFanartPreview = function(index) {
        if (currentFanartImages.length === 0) return;
        currentFanartIndex = index;
        const previewModal = document.getElementById('fanart-preview-modal');
        const previewImage = document.getElementById('fanart-preview-image');
        const previewInfo = document.getElementById('fanart-preview-info');
        const prevBtn = document.getElementById('fanart-preview-prev');
        const nextBtn = document.getElementById('fanart-preview-next');
        
        if (!previewModal || !previewImage) return;
        
        previewModal.style.display = 'flex';
        updateFanartPreview();
        
        // 键盘事件：左右箭头翻页，ESC关闭
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowLeft') {
            prevFanartImage();
          } else if (e.key === 'ArrowRight') {
            nextFanartImage();
          } else if (e.key === 'Escape') {
            closeFanartPreview();
          }
        };
        
        document.addEventListener('keydown', handleKeyDown);
        previewModal._keyHandler = handleKeyDown;
      };
      
      // 更新预览图片
      function updateFanartPreview() {
        if (currentFanartImages.length === 0) return;
        const previewImage = document.getElementById('fanart-preview-image');
        const previewInfo = document.getElementById('fanart-preview-info');
        const prevBtn = document.getElementById('fanart-preview-prev');
        const nextBtn = document.getElementById('fanart-preview-next');
        
        if (!previewImage) return;
        
        const imagePath = currentFanartImages[currentFanartIndex];
        previewImage.src = '/api/files?path=' + encodeURIComponent(imagePath);
        
        if (previewInfo) {
          previewInfo.textContent = `${currentFanartIndex + 1} / ${currentFanartImages.length}`;
        }
        
        if (prevBtn) {
          prevBtn.style.display = currentFanartImages.length > 1 ? 'flex' : 'none';
        }
        if (nextBtn) {
          nextBtn.style.display = currentFanartImages.length > 1 ? 'flex' : 'none';
        }
      }
      
      // 上一张
      window.prevFanartImage = function() {
        if (currentFanartImages.length === 0) return;
        currentFanartIndex = (currentFanartIndex - 1 + currentFanartImages.length) % currentFanartImages.length;
        updateFanartPreview();
      };
      
      // 下一张
      window.nextFanartImage = function() {
        if (currentFanartImages.length === 0) return;
        currentFanartIndex = (currentFanartIndex + 1) % currentFanartImages.length;
        updateFanartPreview();
      };
      
      // 关闭预览
      window.closeFanartPreview = function() {
        const previewModal = document.getElementById('fanart-preview-modal');
        if (previewModal && previewModal._keyHandler) {
          document.removeEventListener('keydown', previewModal._keyHandler);
          previewModal._keyHandler = null;
        }
        if (previewModal) {
          previewModal.style.display = 'none';
        }
      };
      
      // 全局函数，更新历史记录按钮状态
      window.updateHistoryButtons = function() {
        const checked = document.querySelectorAll('.history-item-checkbox:checked');
        const historyDeleteBtn = document.getElementById('history-delete-btn');
        const historyRedownloadFanartBtn = document.getElementById('history-redownload-fanart-btn');
        if (historyDeleteBtn) historyDeleteBtn.disabled = checked.length === 0;
        if (historyRedownloadFanartBtn) historyRedownloadFanartBtn.disabled = checked.length === 0;
      };
      
      // 历史记录多选功能初始化
      (function() {
        const historySelectAll = document.getElementById('history-select-all');
        const historyDeleteBtn = document.getElementById('history-delete-btn');
        const historyRedownloadFanartBtn = document.getElementById('history-redownload-fanart-btn');
        
        if (historySelectAll) {
          historySelectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.history-item-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            window.updateHistoryButtons();
          });
        }
        
        // 监听复选框变化（使用事件委托）
        document.addEventListener('change', function(e) {
          if (e.target.classList.contains('history-item-checkbox')) {
            window.updateHistoryButtons();
            // 更新全选状态
            if (historySelectAll) {
              const allCheckboxes = document.querySelectorAll('.history-item-checkbox');
              const checkedCount = document.querySelectorAll('.history-item-checkbox:checked').length;
              historySelectAll.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCount;
            }
          }
        });
        
        // 删除按钮下拉菜单
        const historyDeleteMenu = document.getElementById('history-delete-menu');
        if (historyDeleteBtn && historyDeleteMenu) {
          historyDeleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            historyDeleteMenu.style.display = historyDeleteMenu.style.display === 'none' ? 'block' : 'none';
          });
          // 点击外部关闭菜单
          document.addEventListener('click', function(e) {
            if (!historyDeleteBtn.contains(e.target) && !historyDeleteMenu.contains(e.target)) {
              historyDeleteMenu.style.display = 'none';
            }
          });
        }
        
        // 删除历史记录
        window.deleteHistoryItems = async function(mode) {
          const checked = document.querySelectorAll('.history-item-checkbox:checked');
          if (checked.length === 0) return;
          
          const ids = Array.from(checked).map(cb => parseInt(cb.dataset.historyId));
          let confirmMsg = '';
          if (mode === 'record') {
            confirmMsg = `确定要删除选中的 ${checked.length} 条刮削记录吗？`;
          } else if (mode === 'files') {
            confirmMsg = `确定要删除选中的 ${checked.length} 条记录的媒体库文件吗？此操作不可恢复！`;
          } else if (mode === 'both') {
            confirmMsg = `确定要删除选中的 ${checked.length} 条记录的刮削记录和媒体库文件吗？此操作不可恢复！`;
          }
          
          const confirmed = await window.showConfirm(confirmMsg, '确认删除');
          if (!confirmed) return;
          
          try {
            const response = await fetchJSON('/api/tasks/history/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ids, mode })
            });
            if (response.success) {
              await loadHistory();
              window.showAlert('删除成功');
            } else {
              window.showAlert('删除失败：' + (response.error || '未知错误'));
            }
          } catch (e) {
            console.error('删除失败:', e);
            window.showAlert('删除失败，请稍后重试');
          }
          if (historyDeleteMenu) historyDeleteMenu.style.display = 'none';
        };
        
        // 重新下载封面/剧照
        if (historyRedownloadFanartBtn) {
          historyRedownloadFanartBtn.addEventListener('click', async function() {
            const checked = document.querySelectorAll('.history-item-checkbox:checked');
            if (checked.length === 0) return;
            
            const ids = Array.from(checked).map(cb => parseInt(cb.dataset.historyId));
            // 获取选中记录的信息
            const historyItems = [];
            checked.forEach(cb => {
              const card = cb.closest('.history-card');
              if (card) {
                const historyId = parseInt(cb.dataset.historyId);
                // 从历史数据中获取下载链接
                // 这里需要从loadHistory中保存的数据获取
                historyItems.push({ id: historyId });
              }
            });
            
            // 显示下载日志悬浮窗
            window.showRedownloadModal(ids);
          });
        }
        
        // 显示重新下载日志悬浮窗
        window.showRedownloadModal = async function(ids) {
          const modal = document.getElementById('redownload-modal');
          const logsContainer = document.getElementById('redownload-logs');
          if (!modal || !logsContainer) {
            window.showAlert('无法打开重新下载窗口，请刷新页面重试');
            return;
          }
          
          modal.style.display = 'flex';
          logsContainer.textContent = '正在启动重新下载任务...\n';
          
          try {
            const response = await fetchJSON('/api/tasks/history/redownload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ids })
            });
            
            if (response.task_id) {
              // 开始轮询日志
              let offset = 0;
              const pollInterval = setInterval(async () => {
                try {
                  const logResp = await fetchJSON(`/api/tasks/${response.task_id}/logs?limit=100`);
                  const newLines = logResp.lines || [];
                  if (newLines.length > 0) {
                    const newText = newLines.slice(offset).join('\n');
                    if (newText) {
                      logsContainer.textContent += newText + '\n';
                      logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                    offset = newLines.length;
                  }
                  
                  if (logResp.status === 'SUCCEEDED' || logResp.status === 'FAILED') {
                    clearInterval(pollInterval);
                    logsContainer.textContent += `\n任务${logResp.status === 'SUCCEEDED' ? '完成' : '失败'}。`;
                  }
                } catch (e) {
                  console.error('获取日志失败:', e);
                }
              }, 1000);
            } else {
              logsContainer.textContent += '启动失败：' + (response.error || '未知错误');
            }
          } catch (e) {
            logsContainer.textContent += '启动失败：' + (e.message || String(e) || '未知错误');
            console.error('重新下载失败:', e);
          }
        };
        
        // 剧照按钮点击事件（使用事件委托）
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('history-fanart-btn')) {
            const fanartDir = e.target.dataset.fanartDir;
            if (fanartDir) {
              window.showFanartModal(fanartDir);
            }
          }
        });
      })();

      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          switchView(btn.dataset.view);
        });
      });

      // 全局规则左侧 tab 切换
      const rulesTabButtons = document.querySelectorAll('.rules-tab-btn');
      const rulesTabPanels = document.querySelectorAll('.rules-tab-panel');
      if (rulesTabButtons.length && rulesTabPanels.length) {
        rulesTabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-rules-tab');
            if (!target) return;

            rulesTabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            rulesTabPanels.forEach(panel => {
              if (panel.getAttribute('data-rules-panel') === target) {
                panel.classList.add('active');
              } else {
                panel.classList.remove('active');
              }
            });
          });
        });
      }

      // 折叠面板：点击标题展开/收起
      const accordionHeaders = document.querySelectorAll('.accordion-header');
      accordionHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const expanded = header.getAttribute('aria-expanded') === 'true';
          const body = header.parentElement && header.parentElement.querySelector('.accordion-body');
          const nextExpanded = !expanded;
          header.setAttribute('aria-expanded', nextExpanded ? 'true' : 'false');
          if (body) {
            body.style.display = nextExpanded ? 'block' : 'none';
          }
        });
      });

      // 翻译引擎字段显隐控制：只显示当前选中引擎对应的配置字段
      function updateTranslateEngineFields() {
        const engine = rulesTranslateEngine ? rulesTranslateEngine.value : 'disabled';
        const allFields = document.querySelectorAll('.translate-engine-field');
        allFields.forEach(el => {
          const target = el.getAttribute('data-engine');
          if (!engine || engine === 'disabled') {
            el.style.display = 'none';
          } else {
            el.style.display = target === engine ? '' : 'none';
          }
        });
      }
      if (rulesTranslateEngine) {
        rulesTranslateEngine.addEventListener('change', updateTranslateEngineFields);
      }

      // 命名规则变量：点击变量名复制到剪贴板
      function bindCopyVarButtons() {
        const buttons = document.querySelectorAll('.copy-var');
        buttons.forEach(btn => {
          btn.addEventListener('click', async () => {
            const val = btn.getAttribute('data-var') || '';
            if (!val) return;
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(val);
              } else {
                const ta = document.createElement('textarea');
                ta.value = val;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
              }
              if (rulesStatus) {
                rulesStatus.style.color = '#9ca3af';
                rulesStatus.textContent = `已复制变量 ${val}`;
              }
            } catch {
              if (rulesStatus) {
                rulesStatus.style.color = '#fca5a5';
                rulesStatus.textContent = `复制变量 ${val} 失败，请手动复制。`;
              }
            }
          });
        });
      }
      bindCopyVarButtons();

      async function fetchJSON(url, options) {
        const res = await fetch(url, Object.assign({ credentials: 'include' }, options || {}));
        if (!res.ok) throw res;
        return res.json();
      }

      async function initUser() {
        try {
          const me = await fetchJSON('/api/auth/me');
          userPill.textContent = me.username;
          userPill.title = '当前登录用户';
        } catch (e) {
          window.location.href = '/login';
        }
      }

      async function initVersion() {
        try {
          const v = await fetchJSON('/api/version');
          versionLabel.textContent = 'JavSP-web v' + (v.version || '未知');
        } catch (e) {
          versionLabel.textContent = '版本信息获取失败';
        }
      }

      logoutBtn.addEventListener('click', async function () {
        try {
          await fetchJSON('/api/auth/logout', { method: 'POST' });
        } catch (e) {
          console.warn(e);
        } finally {
          window.location.href = '/login';
        }
      });

      if (manualLogCopyBtn && manualLogStatusEl) {
        manualLogCopyBtn.addEventListener('click', async function () {
          const text = manualLogRawText || '';
          if (!text.trim()) {
            manualLogStatusEl.textContent = '当前没有可复制的日志';
            return;
          }
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
            } else {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.position = 'fixed';
              ta.style.opacity = '0';
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
            }
            manualLogStatusEl.textContent = '日志已复制到剪贴板';
          } catch (e) {
            console.warn(e);
            manualLogStatusEl.textContent = '复制失败，请手动选择日志复制';
          }
        });
      }

      if (proxyfreeOpenBtn && proxyfreeModal) {
        proxyfreeOpenBtn.addEventListener('click', function () {
          if (!proxyfreeSnapshot) {
            proxyfreeSnapshot = {
              javbus: rulesProxyFreeJavbus ? rulesProxyFreeJavbus.value : '',
              javdb: rulesProxyFreeJavdb ? rulesProxyFreeJavdb.value : '',
              javlib: rulesProxyFreeJavlib ? rulesProxyFreeJavlib.value : '',
              avsox: rulesProxyFreeAvsox ? rulesProxyFreeAvsox.value : ''
            };
          }
          proxyfreeModal.style.display = 'flex';
        });
      }

      if (proxyfreeCancelBtn && proxyfreeModal) {
        proxyfreeCancelBtn.addEventListener('click', function () {
          if (proxyfreeSnapshot) {
            if (rulesProxyFreeJavbus) rulesProxyFreeJavbus.value = proxyfreeSnapshot.javbus || '';
            if (rulesProxyFreeJavdb) rulesProxyFreeJavdb.value = proxyfreeSnapshot.javdb || '';
            if (rulesProxyFreeJavlib) rulesProxyFreeJavlib.value = proxyfreeSnapshot.javlib || '';
            if (rulesProxyFreeAvsox) rulesProxyFreeAvsox.value = proxyfreeSnapshot.avsox || '';
          }
          proxyfreeModal.style.display = 'none';
        });
      }

      // chips 组件：回车添加 & 删除
      function bindChipsInput(listEl, inputEl) {
        if (!listEl || !inputEl) return;
        inputEl.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const v = inputEl.value.trim();
            if (!v) return;
            // 避免完全重复
            const exists = Array.from(listEl.querySelectorAll('.chip')).some(span => span.firstChild && span.firstChild.nodeType === Node.TEXT_NODE && span.firstChild.textContent === v);
            if (exists) {
              inputEl.value = '';
              return;
            }
            const span = document.createElement('span');
            span.className = 'chip';
            span.textContent = v;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'chip-remove';
            btn.textContent = '×';
            btn.addEventListener('click', () => span.remove());
            span.appendChild(btn);
            listEl.appendChild(span);
            inputEl.value = '';
          }
        });
      }

      bindChipsInput(chipsScannerIgnoredIdList, chipsScannerIgnoredIdInput);
      bindChipsInput(chipsScannerIgnoredFoldersList, chipsScannerIgnoredFoldersInput);
      bindChipsInput(chipsScannerExtensionsList, chipsScannerExtensionsInput);
      bindChipsInput(chipsCrawlerSelectionNormalList, chipsCrawlerSelectionNormalInput);
      bindChipsInput(chipsCrawlerSelectionFc2List, chipsCrawlerSelectionFc2Input);
      bindChipsInput(chipsCrawlerSelectionCidList, chipsCrawlerSelectionCidInput);
      bindChipsInput(chipsCrawlerSelectionGetchuList, chipsCrawlerSelectionGetchuInput);
      bindChipsInput(chipsCrawlerSelectionGyuttoList, chipsCrawlerSelectionGyuttoInput);

      // nfo modal
      if (nfoOpenBtn && nfoModal) {
        nfoOpenBtn.addEventListener('click', function () {
          if (!nfoSnapshot) {
            nfoSnapshot = {
              genres: rulesNfoGenres ? rulesNfoGenres.value : '',
              tags: rulesNfoTags ? rulesNfoTags.value : ''
            };
          }
          nfoModal.style.display = 'flex';
        });
      }

      if (nfoModalCancelBtn && nfoModal) {
        nfoModalCancelBtn.addEventListener('click', function () {
          if (nfoSnapshot) {
            if (rulesNfoGenres) rulesNfoGenres.value = nfoSnapshot.genres || '';
            if (rulesNfoTags) rulesNfoTags.value = nfoSnapshot.tags || '';
          }
          nfoModal.style.display = 'none';
        });
      }

      if (nfoModalSaveBtn && nfoModal) {
        nfoModalSaveBtn.addEventListener('click', function () {
          nfoSnapshot = {
            genres: rulesNfoGenres ? rulesNfoGenres.value : '',
            tags: rulesNfoTags ? rulesNfoTags.value : ''
          };
          nfoModal.style.display = 'none';
        });
      }


      if (proxyfreeSaveBtn && proxyfreeModal) {
        proxyfreeSaveBtn.addEventListener('click', function () {
          proxyfreeSnapshot = {
            javbus: rulesProxyFreeJavbus ? rulesProxyFreeJavbus.value : '',
            javdb: rulesProxyFreeJavdb ? rulesProxyFreeJavdb.value : '',
            javlib: rulesProxyFreeJavlib ? rulesProxyFreeJavlib.value : '',
            avsox: rulesProxyFreeAvsox ? rulesProxyFreeAvsox.value : ''
          };
          proxyfreeModal.style.display = 'none';
        });
      }

      const rulesSaveBtn = document.getElementById('rules-save');
      if (rulesSaveBtn) {
        rulesSaveBtn.addEventListener('click', async function () {
          if (!rulesStatus) return;

          const payload = {};

          // scanner
          if (rulesScannerMinimumSize) {
            const size = rulesScannerMinimumSize.value.trim();
            if (size !== '' && !Number.isNaN(Number(size))) {
              payload.scanner = payload.scanner || {};
              payload.scanner.minimum_size = `${size}MiB`;
            }
          }

          function collectChips(listEl) {
            if (!listEl) return [];
            const arr = [];
            listEl.querySelectorAll('.chip').forEach(span => {
              if (span.firstChild && span.firstChild.nodeType === Node.TEXT_NODE) {
                const v = span.firstChild.textContent || '';
                const t = v.trim();
                if (t) arr.push(t);
              }
            });
            return arr;
          }

          const ignoredIds = collectChips(chipsScannerIgnoredIdList);
          const ignoredFolders = collectChips(chipsScannerIgnoredFoldersList);
          const extList = collectChips(chipsScannerExtensionsList);
          if (ignoredIds.length > 0) {
            payload.scanner = payload.scanner || {};
            payload.scanner.ignored_id_pattern = ignoredIds;
          }
          if (ignoredFolders.length > 0) {
            payload.scanner = payload.scanner || {};
            payload.scanner.ignored_folder_name_pattern = ignoredFolders;
          }
          if (extList.length > 0) {
            payload.scanner = payload.scanner || {};
            payload.scanner.filename_extensions = extList;
          }

          if (rulesScannerSkipNfo) {
            payload.scanner = payload.scanner || {};
            payload.scanner.skip_nfo_dir = !!rulesScannerSkipNfo.checked;
          }

          // network
          if (rulesNetworkProxy) {
            const proxy = rulesNetworkProxy.value.trim();
            if (proxy !== '') {
              payload.network = payload.network || {};
              payload.network.proxy_server = proxy;
            }
          }
          if (rulesNetworkRetry) {
            const r = rulesNetworkRetry.value.trim();
            if (r !== '' && !Number.isNaN(Number(r))) {
              payload.network = payload.network || {};
              payload.network.retry = Number(r);
            }
          }
          if (rulesNetworkTimeout) {
            const t = rulesNetworkTimeout.value.trim();
            if (t !== '' && !Number.isNaN(Number(t))) {
              payload.network = payload.network || {};
              payload.network.timeout = `PT${t}S`;
            }
          }

          const proxyFree = {};
          if (rulesProxyFreeJavbus && rulesProxyFreeJavbus.value.trim() !== '') proxyFree.javbus = rulesProxyFreeJavbus.value.trim();
          if (rulesProxyFreeJavdb && rulesProxyFreeJavdb.value.trim() !== '') proxyFree.javdb = rulesProxyFreeJavdb.value.trim();
          if (rulesProxyFreeJavlib && rulesProxyFreeJavlib.value.trim() !== '') proxyFree.javlib = rulesProxyFreeJavlib.value.trim();
          if (rulesProxyFreeAvsox && rulesProxyFreeAvsox.value.trim() !== '') proxyFree.avsox = rulesProxyFreeAvsox.value.trim();
          if (Object.keys(proxyFree).length > 0) {
            payload.network = payload.network || {};
            payload.network.proxy_free = proxyFree;
          }
          // CookieCloud配置
          if (rulesCookieCloudEnabled) {
            payload.network = payload.network || {};
            payload.network.cookiecloud = {
              enabled: rulesCookieCloudEnabled.checked,
              server_url: rulesCookieCloudServerUrl ? rulesCookieCloudServerUrl.value.trim() || null : null,
              uuid: rulesCookieCloudUuid ? rulesCookieCloudUuid.value.trim() || null : null,
              password: rulesCookieCloudPassword ? rulesCookieCloudPassword.value.trim() || null : null
            };
          }

          // crawler
          if (rulesCrawlerRequiredKeys) {
            const v = rulesCrawlerRequiredKeys.value.trim();
            if (v !== '') {
              const keys = v.split(',').map(s => s.trim()).filter(Boolean);
              if (keys.length > 0) {
                payload.crawler = payload.crawler || {};
                payload.crawler.required_keys = keys;
              }
            }
          }
          if (rulesCrawlerHardworking) {
            payload.crawler = payload.crawler || {};
            payload.crawler.hardworking = !!rulesCrawlerHardworking.checked;
          }
          if (rulesCrawlerRespectId) {
            payload.crawler = payload.crawler || {};
            payload.crawler.respect_site_avid = !!rulesCrawlerRespectId.checked;
          }
          if (rulesCrawlerUseJavdbCover) {
            const v = rulesCrawlerUseJavdbCover.value.trim();
            if (v) {
              payload.crawler = payload.crawler || {};
              payload.crawler.use_javdb_cover = v;
            }
          }
          if (rulesCrawlerNormalizeActress) {
            payload.crawler = payload.crawler || {};
            payload.crawler.normalize_actress_name = !!rulesCrawlerNormalizeActress.checked;
          }

          if (rulesCrawlerFc2fanPath) {
            const p = rulesCrawlerFc2fanPath.value.trim();
            if (p !== '') {
              payload.crawler = payload.crawler || {};
              payload.crawler.fc2fan_local_path = p;
            }
          }
          if (rulesCrawlerSleepAfter) {
            const slp = rulesCrawlerSleepAfter.value.trim();
            if (slp !== '') {
              payload.crawler = payload.crawler || {};
              payload.crawler.sleep_after_scraping = slp;
            }
          }

          const selNormal = collectChips(chipsCrawlerSelectionNormalList);
          const selFc2 = collectChips(chipsCrawlerSelectionFc2List);
          const selCid = collectChips(chipsCrawlerSelectionCidList);
          const selGetchu = collectChips(chipsCrawlerSelectionGetchuList);
          const selGyutto = collectChips(chipsCrawlerSelectionGyuttoList);
          if (selNormal.length || selFc2.length || selCid.length || selGetchu.length || selGyutto.length) {
            payload.crawler = payload.crawler || {};
            payload.crawler.selection = {};
            if (selNormal.length) payload.crawler.selection.normal = selNormal;
            if (selFc2.length) payload.crawler.selection.fc2 = selFc2;
            if (selCid.length) payload.crawler.selection.cid = selCid;
            if (selGetchu.length) payload.crawler.selection.getchu = selGetchu;
            if (selGyutto.length) payload.crawler.selection.gyutto = selGyutto;
          }

          // summarizer.move_files & path
          if (rulesSummarizerMoveFiles) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.move_files = !!rulesSummarizerMoveFiles.checked;
          }
          if (rulesPathOutput) {
            const v = rulesPathOutput.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.path = payload.summarizer.path || {};
              payload.summarizer.path.output_folder_pattern = v;
            }
          }
          if (rulesPathBasename) {
            const v = rulesPathBasename.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.path = payload.summarizer.path || {};
              payload.summarizer.path.basename_pattern = v;
            }
          }
          if (rulesPathLengthMax) {
            const v = rulesPathLengthMax.value.trim();
            if (v !== '' && !Number.isNaN(Number(v))) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.path = payload.summarizer.path || {};
              payload.summarizer.path.length_maximum = Number(v);
            }
          }
          if (rulesPathLengthByByte) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.length_by_byte = !!rulesPathLengthByByte.checked;
          }
          if (rulesPathMaxActress) {
            const v = rulesPathMaxActress.value.trim();
            if (v !== '' && !Number.isNaN(Number(v))) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.path = payload.summarizer.path || {};
              payload.summarizer.path.max_actress_count = Number(v);
            }
          }
          if (rulesPathHardLink) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.hard_link = !!rulesPathHardLink.checked;
          }

          // 标题与默认值
          if (rulesTitleRemoveActor) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.title = payload.summarizer.title || {};
            payload.summarizer.title.remove_trailing_actor_name = !!rulesTitleRemoveActor.checked;
          }
          if (rulesDefaultTitle) {
            const v = rulesDefaultTitle.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.title = v;
            }
          }
          if (rulesDefaultActress) {
            const v = rulesDefaultActress.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.actress = v;
            }
          }
          if (rulesDefaultSeries) {
            const v = rulesDefaultSeries.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.series = v;
            }
          }
          if (rulesDefaultDirector) {
            const v = rulesDefaultDirector.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.director = v;
            }
          }
          if (rulesDefaultProducer) {
            const v = rulesDefaultProducer.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.producer = v;
            }
          }
          if (rulesDefaultPublisher) {
            const v = rulesDefaultPublisher.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.default = payload.summarizer.default || {};
              payload.summarizer.default.publisher = v;
            }
          }

          // NFO
          if (rulesNfoBasename) {
            const v = rulesNfoBasename.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.nfo = payload.summarizer.nfo || {};
              payload.summarizer.nfo.basename_pattern = v;
            }
          }
          if (rulesNfoTitle) {
            const v = rulesNfoTitle.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.nfo = payload.summarizer.nfo || {};
              payload.summarizer.nfo.title_pattern = v;
            }
          }
          if (rulesNfoGenres) {
            const lines = rulesNfoGenres.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
            if (lines.length > 0) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.nfo = payload.summarizer.nfo || {};
              payload.summarizer.nfo.custom_genres_fields = lines;
            }
          }
          if (rulesNfoTags) {
            const lines = rulesNfoTags.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
            if (lines.length > 0) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.nfo.custom_tags_fields = lines;
            }
          }
          if (rulesCensorTexts) {
            const v = rulesCensorTexts.value.split(',').map(s => s.trim()).filter(Boolean);
            if (v.length > 0) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.censor_options_representation = v;
            }
          }

          // cover & extra_fanarts
          if (rulesCoverBasename) {
            const v = rulesCoverBasename.value.trim();
            if (v !== '') {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.cover = payload.summarizer.cover || {};
              payload.summarizer.cover.basename_pattern = v;
            }
          }
          if (rulesCoverHighres) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.cover = payload.summarizer.cover || {};
            payload.summarizer.cover.highres = !!rulesCoverHighres.checked;
          }
          if (rulesCoverAddLabel) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.cover = payload.summarizer.cover || {};
            payload.summarizer.cover.add_label = !!rulesCoverAddLabel.checked;
          }
          // summarizer.extra_fanarts
          if (rulesExtraFanartsEnabled || rulesExtraFanartsInterval) {
            const extra = {};
            if (rulesExtraFanartsEnabled) {
              extra.enabled = !!rulesExtraFanartsEnabled.checked;
            }
            if (rulesExtraFanartsInterval) {
              const interval = rulesExtraFanartsInterval.value.trim();
              if (interval !== '') {
                extra.scrap_interval = interval;
              }
            }
            if (Object.keys(extra).length > 0) {
              payload.summarizer = payload.summarizer || {};
              payload.summarizer.extra_fanarts = extra;
            }
          }

          // translator.fields
          if (rulesTranslateTitle || rulesTranslatePlot) {
            const fields = {};
            if (rulesTranslateTitle) {
              fields.title = !!rulesTranslateTitle.checked;
            }
            if (rulesTranslatePlot) {
              fields.plot = !!rulesTranslatePlot.checked;
            }
            if (Object.keys(fields).length > 0) {
              payload.translator = payload.translator || {};
              payload.translator.fields = fields;
            }
          }

          rulesStatus.style.color = '#9ca3af';
          rulesStatus.textContent = '正在保存配置...';
          try {
            await fetchJSON('/api/rules/global', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            rulesStatus.style.color = '#bbf7d0';
            rulesStatus.textContent = '保存成功。';
          } catch (res) {
            rulesStatus.style.color = '#fca5a5';
            if (res && res.status === 400) {
              let message = '保存失败：配置内容不符合 schema，请检查后重试。';
              try {
                const data = await res.json();
                if (data && data.detail) {
                  message = '保存失败：' + String(data.detail);
                }
              } catch (e) {}
              rulesStatus.textContent = message;
            } else if (res && res.status === 401) {
              window.location.href = '/login';
            } else {
              rulesStatus.textContent = '保存失败，请稍后重试。';
            }
          }
        });
      }

      if (cookiecloudSaveBtn) {
        cookiecloudSaveBtn.addEventListener('click', async function () {
          if (!cookiecloudStatus) return;
          cookiecloudStatus.style.color = '#9ca3af';
          cookiecloudStatus.textContent = '正在保存配置...';
          const payload = {
            network: {
              cookiecloud: {
                enabled: !!(rulesCookieCloudEnabled && rulesCookieCloudEnabled.checked),
                server_url: rulesCookieCloudServerUrl ? rulesCookieCloudServerUrl.value.trim() || null : null,
                uuid: rulesCookieCloudUuid ? rulesCookieCloudUuid.value.trim() || null : null,
                password: rulesCookieCloudPassword ? rulesCookieCloudPassword.value.trim() || null : null
              }
            }
          };
          try {
            await fetchJSON('/api/rules/global', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            cookiecloudStatus.style.color = '#bbf7d0';
            cookiecloudStatus.textContent = '保存成功。';
          } catch (res) {
            cookiecloudStatus.style.color = '#fca5a5';
            if (res && res.status === 400) {
              let message = '保存失败：配置内容不符合 schema，请检查后重试。';
              try {
                const data = await res.json();
                if (data && data.detail) {
                  message = '保存失败：' + String(data.detail);
                }
              } catch (e) {}
              cookiecloudStatus.textContent = message;
            } else if (res && res.status === 401) {
              window.location.href = '/login';
            } else {
              cookiecloudStatus.textContent = '保存失败，请稍后重试。';
            }
          }
        });
      }

      function renderManualProgress() {
        if (!manualProgressBox || !manualProgressMovieEl || !manualProgressStepEl) return;
        const hasMovie = !!manualMovieProgress;
        const hasStep = !!manualStepProgress;
        if (!hasMovie && !hasStep) {
          manualProgressBox.style.display = 'none';
          manualProgressMovieEl.textContent = '';
          manualProgressStepEl.textContent = '';
          return;
        }
        manualProgressBox.style.display = 'block';
        if (hasMovie) {
          const m = manualMovieProgress;
          const name = m.dvdid || m.cid || '';
          manualProgressMovieEl.textContent = `当前影片：${m.index}/${m.total}${name ? ' ' + name : ''}`;
        } else {
          manualProgressMovieEl.textContent = '';
        }
        if (hasStep) {
          const s = manualStepProgress;
          manualProgressStepEl.textContent = `当前步骤：${s.index}/${s.total} ${s.desc || ''}`;
        } else {
          manualProgressStepEl.textContent = '';
        }
      }

      function renderManualTaskTable(taskStatus) {
        if (!manualTaskTableBody) return;
        const rows = [];
        const keys = Object.keys(manualMovieStates);
        keys.sort((a, b) => {
          const ma = manualMovieStates[a];
          const mb = manualMovieStates[b];
          return (ma.index || 0) - (mb.index || 0);
        });
        keys.forEach(key => {
          const s = manualMovieStates[key];
          const id = s.id || key;
          const stepText = s.stepIndex && s.stepTotal
            ? `${s.stepIndex}/${s.stepTotal} ${s.stepDesc || ''}`
            : (s.stepDesc || '');
          let status = s.status || 'RUNNING';
          if (taskStatus === 'SUCCEEDED') status = 'SUCCEEDED';
          if (taskStatus === 'FAILED' && status !== 'SUCCEEDED') status = 'FAILED';
          const statusText = status === 'SUCCEEDED' ? '完成' : status === 'FAILED' ? '失败' : '进行中';
          let lastLog = s.lastLog || '';
          // 若影片已完成，但 latestLog 仍是页面结构异常/反爬相关软错误，则在表格中显示为“整理完成”
          if (status === 'SUCCEEDED' && /(页面结构异常或访问被拦截|无法绕开JavLib的反爬机制)/.test(lastLog)) {
            lastLog = '整理完成';
          }
          if (status === 'SUCCEEDED' && /(页面结构异常或访问被拦截|无法绕开JavLib的反爬机制)/.test(lastLog)) {
            lastLog = '整理完成';
          }
          const tr = document.createElement('tr');
          const tdMovie = document.createElement('td');
          tdMovie.textContent = id;
          const tdStep = document.createElement('td');
          tdStep.textContent = stepText;
          const tdStatus = document.createElement('td');
          tdStatus.textContent = statusText;
          const tdLog = document.createElement('td');
          tdLog.textContent = lastLog;
          tr.appendChild(tdMovie);
          tr.appendChild(tdStep);
          tr.appendChild(tdStatus);
          tr.appendChild(tdLog);
          rows.push(tr);
        });
        manualTaskTableBody.innerHTML = '';
        rows.forEach(tr => manualTaskTableBody.appendChild(tr));
      }

      // 存储所有任务的日志，按任务ID和文件分组
      // taskId -> { 
      //   inputPath: string,  // 刮削路径
      //   movies: Map<movieKey, {
      //     steps: Map<stepIndex, {desc: string, logs: []}>,  // 每个步骤的日志
      //     errors: [],  // 失败日志
      //     saveDir: string  // 保存路径
      //   }>, 
      //   status: string 
      // }
      const allTaskLogs = new Map();
      // 保存展开状态
      const expandedTasks = new Set();
      const expandedMovies = new Set();
      const expandedSteps = new Map(); // taskId-movieKey-stepIndex -> true
      
      // 渲染可展开收起的日志结构
      function renderCollapsibleLogs() {
        if (!manualLogContainer) return;
        
        // 保存当前展开状态
        const currentExpandedTasks = new Set();
        const currentExpandedMovies = new Set();
        document.querySelectorAll('.log-task-body').forEach(el => {
          if (el.style.display !== 'none') {
            const taskId = el.id.replace('task-log-', '');
            currentExpandedTasks.add(taskId);
          }
        });
        document.querySelectorAll('.log-movie-body').forEach(el => {
          if (el.style.display !== 'none') {
            const match = el.id.match(/movie-log-(\d+)-(.+)/);
            if (match) {
              currentExpandedMovies.add(match[1] + '-' + match[2]);
            }
          }
        });
        // 合并到全局状态
        currentExpandedTasks.forEach(id => expandedTasks.add(id));
        currentExpandedMovies.forEach(id => expandedMovies.add(id));
        
        const html = [];
        // 按任务ID排序（最新的在前）- 任务ID现在是字符串格式：pathhash_YYYYMMDD_HHMMSS
        const sortedTasks = Array.from(allTaskLogs.entries()).sort((a, b) => {
          // 提取时间戳部分进行排序
          const getTimestamp = (taskId) => {
            const parts = String(taskId).split('_');
            if (parts.length >= 3) {
              return parts[1] + parts[2]; // YYYYMMDD_HHMMSS
            }
            return taskId;
          };
          return getTimestamp(b[0]).localeCompare(getTimestamp(a[0]));
        });
        
        // 解码base64路径的函数
        const decodeTaskPath = (taskId) => {
          try {
            const parts = String(taskId).split('_');
            if (parts.length >= 2) {
              // 恢复base64编码（还原被替换的字符）
              let pathEncoded = parts[0].replace(/_/g, '/').replace(/-/g, '+');
              // 添加填充
              while (pathEncoded.length % 4 !== 0) {
                pathEncoded += '=';
              }
              const decoded = atob(pathEncoded);
              return decoded;
            }
          } catch (e) {
            console.warn('解码任务路径失败:', e);
          }
          return null;
        };
        
        sortedTasks.forEach(([taskId, taskData]) => {
          // 解码任务路径用于显示
          const decodedPath = decodeTaskPath(taskId);
          const displayPath = decodedPath || taskData.inputPath || '';
          // 提取时间戳用于显示
          const parts = String(taskId).split('_');
          let taskTimeFormatted = '';
          if (parts.length >= 3) {
            const datePart = parts[1]; // YYYYMMDD
            const timePart = parts[2]; // HHMMSS
            taskTimeFormatted = `${datePart} ${timePart}`;
          }
          const status = taskData.status || 'RUNNING';
          const statusColor = status === 'SUCCEEDED' ? '#22c55e' : status === 'FAILED' ? '#ef4444' : status === 'PENDING' ? '#f59e0b' : '#3b82f6';
          const statusText = status === 'SUCCEEDED' ? '完成' : status === 'FAILED' ? '失败' : status === 'PENDING' ? '队列中' : '进行中';
          const isTaskExpanded = expandedTasks.has(String(taskId));
          const safeTaskId = String(taskId).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          
          // 生成步骤信息
          let stepsHtml = '';
          if (taskData.steps && taskData.steps.length > 0) {
            const stepsList = taskData.steps.map((step, idx) => {
              const stepNum = idx + 1;
              return `步骤${stepNum}: ${step.desc || ''}`;
            }).join(', ');
            stepsHtml = `<div style="font-size:10px;color:#9ca3af;margin-top:4px;">${stepsList}</div>`;
          }
          
          const showCancel = status !== 'SUCCEEDED' && status !== 'FAILED';
          html.push(`
            <div class="log-task-group" data-task-id="${safeTaskId}" style="border:1px solid #1f2937;border-radius:8px;margin-bottom:8px;overflow:hidden;background:#020617;">
              <div class="log-task-header" style="padding:10px 12px;background:#111827;display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;align-items:center;gap:8px;cursor:pointer;flex:1;" onclick="toggleTaskLog('${safeTaskId}')">
                  <span class="task-arrow-${safeTaskId.replace(/[^a-zA-Z0-9]/g, '_')}" style="color:#9ca3af;font-size:12px;font-family:ui-monospace;">${isTaskExpanded ? '[-]' : '[+]'}</span>
                  <span style="font-size:12px;font-weight:600;color:#e5e7eb;">任务 ${displayPath || taskId}</span>
                  <span style="font-size:11px;color:${statusColor};">[${statusText}]</span>
                  ${taskTimeFormatted ? `<span style="font-size:11px;color:#9ca3af;">时间：${taskTimeFormatted}</span>` : ''}
                </div>
                <div style="display:flex;gap:4px;">
                  ${showCancel ? `<button class="delete-task-log-btn" data-task-id="${safeTaskId}" style="border-radius:999px;border:1px solid #374151;padding:2px 8px;background:transparent;color:#f59e0b;font-size:10px;cursor:pointer;" onclick="event.stopPropagation();cancelTask('${safeTaskId}')">取消</button>` : ''}
                  <button class="copy-task-log-btn" data-task-id="${safeTaskId}" style="border-radius:999px;border:1px solid #374151;padding:2px 8px;background:transparent;color:#9ca3af;font-size:10px;cursor:pointer;" onclick="event.stopPropagation();copyTaskLog('${safeTaskId}')">复制日志</button>
                  <button class="delete-task-log-btn" data-task-id="${safeTaskId}" style="border-radius:999px;border:1px solid #374151;padding:2px 8px;background:transparent;color:#ef4444;font-size:10px;cursor:pointer;" onclick="event.stopPropagation();deleteTaskLog('${safeTaskId}')">删除日志</button>
                </div>
              </div>
              <div class="log-task-body" id="task-log-${safeTaskId.replace(/[^a-zA-Z0-9]/g, '_')}" style="display:${isTaskExpanded ? 'block' : 'none'};padding:8px 12px;">
                ${taskData.movies && taskData.movies.size > 0 ? Array.from(taskData.movies.entries()).map(([movieKey, movieData]) => {
                  const movieId = String(movieKey).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                  const safeKey = String(movieKey).replace(/[^a-zA-Z0-9]/g, '_');
                  const hasErrors = movieData.errors && movieData.errors.length > 0;
                  
                  const stepNames = ['启动并发任务', '汇总数据', '生成文件名', '下载封面图片', '下载剧照', '写入NFO', '移动影片文件'];
                  let stepsHtml = '';
                  stepNames.forEach((stepName, idx) => {
                    const stepIndex = idx + 1;
                    const stepKey = taskId + '-' + safeKey + '-' + stepIndex;
                    const isStepExpanded = expandedSteps.has(stepKey);
                    const stepData = movieData.steps && movieData.steps.get(stepIndex);
                    const stepLogs = stepData ? stepData.logs : [];
                    
                    stepsHtml += '<div style="margin-left:20px;margin-bottom:4px;">' +
                      '<div style="padding:6px 8px;background:#111827;cursor:pointer;display:flex;align-items:center;gap:6px;" onclick="toggleStepLog(\'' + stepKey + '\')">' +
                      '<span class="step-arrow-' + stepKey + '" style="color:#9ca3af;font-size:11px;font-family:ui-monospace;">' + (isStepExpanded ? '[-]' : '[+]') + '</span>' +
                      '<span style="font-size:11px;color:#e5e7eb;">[步骤 ' + stepIndex + '/7] ' + stepName + '</span>' +
                      '</div>' +
                      '<div class="step-body" id="step-log-' + stepKey + '" style="display:' + (isStepExpanded ? 'block' : 'none') + ';margin-left:20px;padding:6px 8px;background:#020617;">' +
                      '<div style="font-size:10px;color:#e5e7eb;font-family:ui-monospace,monospace;line-height:1.4;white-space:pre-wrap;word-break:break-all;overflow-wrap:break-word;">' +
                      (stepLogs.length > 0 ? stepLogs.map(log => String(log).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('\n') : '无日志') +
                      '</div>' +
                      '</div>' +
                      '</div>';
                  });
                  
                  let saveDirHtml = '';
                  if (movieData.saveDir) {
                    saveDirHtml = '<div style="margin-left:20px;margin-top:8px;padding:6px 8px;background:#111827;font-size:11px;color:#9ca3af;">整理完成，相关文件已保存到: ' + movieData.saveDir.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                  }
                  
                  let errorHtml = '';
                  if (hasErrors) {
                    errorHtml = '<div style="margin-left:20px;margin-top:8px;">' +
                      '<div style="padding:6px 8px;background:#111827;cursor:pointer;display:flex;align-items:center;gap:6px;" onclick="toggleErrorLog(\'' + taskId + '-' + safeKey + '\')">' +
                      '<span class="error-arrow-' + taskId + '-' + safeKey + '" style="color:#ef4444;font-size:11px;font-family:ui-monospace;">[+]</span>' +
                      '<span style="font-size:11px;color:#ef4444;font-weight:600;">失败日志</span>' +
                      '</div>' +
                      '<div class="error-body" id="error-log-' + taskId + '-' + safeKey + '" style="display:none;margin-left:20px;padding:6px 8px;background:#1f1f1f;">' +
                      '<div style="font-size:10px;color:#fca5a5;font-family:ui-monospace,monospace;line-height:1.4;white-space:pre-wrap;word-break:break-all;overflow-wrap:break-word;">' +
                      movieData.errors.map(err => String(err).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('\n') +
                      '</div>' +
                      '</div>' +
                      '</div>';
                  }
                  
                  return stepsHtml + saveDirHtml + errorHtml;
                }).join('') : '<div style="padding:8px;color:#9ca3af;font-size:11px;">日志加载中...</div>'}
              </div>
            </div>
          `);
        });
        
        manualLogContainer.innerHTML = html.join('');
        
        // 使用事件委托来处理步骤和错误日志的展开/收起
        // 只在第一次设置事件监听器
        if (!manualLogContainer._eventDelegateSet) {
          manualLogContainer.addEventListener('click', function(e) {
            const target = e.target;
            if (!target) return;
            
            // 检查是否是步骤展开按钮或其父元素
            let stepBtn = target.closest('[onclick*="toggleStepLog"]');
            if (!stepBtn && target.parentElement) {
              stepBtn = target.parentElement.closest('[onclick*="toggleStepLog"]');
            }
            if (stepBtn) {
              const onclick = stepBtn.getAttribute('onclick');
              const match = onclick.match(/toggleStepLog\(['"]([^'"]+)['"]\)/);
              if (match) {
                e.preventDefault();
                e.stopPropagation();
                window.toggleStepLog(match[1]);
                return;
              }
            }
            
            // 检查是否是错误日志展开按钮或其父元素
            let errorBtn = target.closest('[onclick*="toggleErrorLog"]');
            if (!errorBtn && target.parentElement) {
              errorBtn = target.parentElement.closest('[onclick*="toggleErrorLog"]');
            }
            if (errorBtn) {
              const onclick = errorBtn.getAttribute('onclick');
              const match = onclick.match(/toggleErrorLog\(['"]([^'"]+)['"]\)/);
              if (match) {
                e.preventDefault();
                e.stopPropagation();
                window.toggleErrorLog(match[1]);
                return;
              }
            }
          }, true);
          manualLogContainer._eventDelegateSet = true;
        }
      }
      
      // 切换任务日志展开/收起
      window.toggleTaskLog = function(taskId) {
        const safeTaskId = String(taskId).replace(/[^a-zA-Z0-9]/g, '_');
        const body = document.getElementById('task-log-' + safeTaskId);
        const header = document.querySelector(`.log-task-group[data-task-id="${String(taskId).replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"] .log-task-header`);
        if (body && header) {
          const isExpanded = body.style.display !== 'none';
          body.style.display = isExpanded ? 'none' : 'block';
          const arrow = header.querySelector(`.task-arrow-${safeTaskId}`);
          if (arrow) arrow.textContent = isExpanded ? '[+]' : '[-]';
          // 更新展开状态
          if (isExpanded) {
            expandedTasks.delete(String(taskId));
          } else {
            expandedTasks.add(String(taskId));
          }
        }
      };
      
      // 切换步骤日志展开/收起
      window.toggleStepLog = function(stepKey) {
        try {
          const body = document.getElementById('step-log-' + stepKey);
          const arrow = document.querySelector('.step-arrow-' + stepKey);
          if (body && arrow) {
            const isExpanded = body.style.display !== 'none';
            body.style.display = isExpanded ? 'none' : 'block';
            arrow.textContent = isExpanded ? '[+]' : '[-]';
            // 更新展开状态
            if (isExpanded) {
              expandedSteps.delete(stepKey);
            } else {
              expandedSteps.set(stepKey, true);
            }
          }
        } catch (e) {
          console.warn('toggleStepLog error:', e, stepKey);
        }
      };
      
      // 切换失败日志展开/收起
      window.toggleErrorLog = function(key) {
        try {
          const body = document.getElementById('error-log-' + key);
          const arrow = document.querySelector('.error-arrow-' + key);
          if (body && arrow) {
            const isExpanded = body.style.display !== 'none';
            body.style.display = isExpanded ? 'none' : 'block';
            arrow.textContent = isExpanded ? '[+]' : '[-]';
          }
        } catch (e) {
          console.warn('toggleErrorLog error:', e, key);
        }
      };
      
      // singleShot: 仅抓取一次日志用于已完成任务的还原，避免开启定时器
      function startManualLogStreaming(taskId, preserveContent = false, singleShot = false) {
        if (!manualLogStatusEl || !manualLogContainer) return;
        const hasOtherTask = manualLogTaskId !== null && manualLogTaskId !== taskId;
        if (manualLogTimer && !singleShot && !hasOtherTask) {
          clearInterval(manualLogTimer);
          manualLogTimer = null;
        }
        const switchingTask = manualLogTaskId !== null && manualLogTaskId !== taskId;
        if (switchingTask && manualLogTimer && singleShot) {
          clearInterval(manualLogTimer);
          manualLogTimer = null;
        }
        const previousTaskId = manualLogTaskId;
        if (!singleShot) {
          manualLogTaskId = taskId;
        }
        // 初始化任务日志结构
        // 如果是新任务（之前不存在），或者切换任务，或者单次抓取，重新初始化
        const isNewTask = !allTaskLogs.has(taskId);
        if (isNewTask || switchingTask || singleShot) {
          allTaskLogs.set(taskId, {
            inputPath: '',
            movies: new Map(),
            status: 'RUNNING'
          });
        }
        // 仅在需要全量还原或切换任务时重置状态，避免跨任务污染
        // 如果是新任务或切换任务，必须重置状态
        if (singleShot || !preserveContent || switchingTask || isNewTask) {
          manualMovieProgress = null;
          manualStepProgress = null;
          manualMovieStates = {};
          manualCurrentMovieKey = null;
          manualLogLastLinesKey = null;
          manualLogOffset = 0;
          manualLogRawText = '';
          // 清除已处理的日志行，但只清除当前任务的
          const keysToDelete = [];
          processedLogLines.forEach(key => {
            if (key.startsWith(taskId + ':')) {
              keysToDelete.push(key);
            }
          });
          keysToDelete.forEach(key => processedLogLines.delete(key));
        }
        renderManualProgress();
        // 格式化任务ID显示（解码路径或显示时间戳）
        let taskIdFormatted = String(taskId);
        const parts = String(taskId).split('_');
        if (parts.length >= 3) {
          taskIdFormatted = `${parts[1]} ${parts[2]}`; // YYYYMMDD HHMMSS
        }
        manualLogStatusEl.textContent = '任务 ' + taskIdFormatted + ' 日志加载中...';
        // 如果是恢复任务，重新渲染日志
        if (preserveContent) {
          renderCollapsibleLogs();
        }
        const fetchAndProcessLogs = async function () {
          try {
            // 刷新或单次还原时需要更多上下文行来正确分类影片
            const logFetchLimit = (preserveContent || singleShot) ? 2000 : 500;
            const resp = await fetchJSON('/api/tasks/' + taskId + '/logs?limit=' + logFetchLimit);
            const lines = resp.lines || [];
            const status = resp.status || 'UNKNOWN';
            // 不再需要检查滚动位置，因为使用可展开收起结构

            // 先遍历全部行更新进度信息和表格状态
            lines.forEach((line, lineIndex) => {
              if (!line) return;
              
              // 创建唯一标识符来跟踪已处理的日志行（避免重复）
              // 使用任务ID和行索引来确保同一任务的不同执行不会互相干扰
              const lineKey = taskId + ':' + lineIndex + ':' + line.substring(0, 200);
              if (processedLogLines.has(lineKey)) {
                return; // 跳过已处理的日志行
              }
              processedLogLines.add(lineKey);

              if (line.indexOf('正在整理:') !== -1) {
                const idx = line.indexOf('正在整理:');
                const rest = line.slice(idx + '正在整理:'.length).trim();
                const firstPart = rest.split(',')[0].trim();
                const filename = firstPart.split(/[\\/]/).pop() || firstPart;
                const dotIndex = filename.lastIndexOf('.');
                const movieId = dotIndex > 0 ? filename.slice(0, dotIndex) : filename;
                if (movieId) {
                  const key = movieId;
                  // 如果之前用临时 key（如 "#1"）记录过当前影片的进度，这里合并到正式的 movieId 上，
                  // 并在切换影片时将上一部影片标记为已完成（若其未处于 FAILED 状态）。
                  let base = manualMovieStates[key] || {};
                  if (manualCurrentMovieKey && manualCurrentMovieKey !== key) {
                    const prevKey = manualCurrentMovieKey;
                    const prevState = manualMovieStates[prevKey] || {};
                    if (prevState.status !== 'FAILED') {
                      manualMovieStates[prevKey] = Object.assign({}, prevState, { status: 'SUCCEEDED' });
                    }
                    const old = manualMovieStates[prevKey] || {};
                    base = Object.assign({}, old, base);
                    delete manualMovieStates[prevKey];
                  }
                  manualCurrentMovieKey = key;
                  if (!base.index) {
                    manualMovieIndexSeq += 1;
                  }
                  manualMovieStates[key] = Object.assign({}, base, {
                    id: movieId,
                    index: base.index || manualMovieIndexSeq
                  });
                  
                  // 初始化影片日志结构
                  const taskData = allTaskLogs.get(taskId);
                  if (taskData) {
                    if (!taskData.movies.has(key)) {
                      taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
                    }
                  }
                }
              }
              if (line.startsWith('JAVSP_EVENT ')) {
                const raw = line.slice('JAVSP_EVENT '.length);
                try {
                  const evt = JSON.parse(raw);
                  if (evt && evt.type === 'progress') {
                    if (evt.kind === 'task') {
                      const key = '__TASK__';
                      const prev = manualMovieStates[key] || {};
                      manualMovieStates[key] = Object.assign({}, prev, {
                        id: `任务 ${String(taskId).length >= 13 ? String(taskId).substring(0, 8) + ' ' + String(taskId).substring(8) : taskId}`,
                        stepDesc: evt.desc || prev.stepDesc || '',
                        status: (evt.status || prev.status || 'RUNNING').toUpperCase()
                      });
                    } else if (evt.kind === 'movie') {
                      manualMovieProgress = {
                        index: evt.index || 0,
                        total: evt.total || 0,
                        dvdid: evt.dvdid || null,
                        cid: evt.cid || null
                      };
                      const key = (evt.dvdid || evt.cid || '') || `#${evt.index || 0}`;
                      manualCurrentMovieKey = key;
                      const prev = manualMovieStates[key] || {};
                      manualMovieStates[key] = Object.assign({}, prev, {
                        id: evt.dvdid || evt.cid || key,
                        index: evt.index || prev.index || 0,
                        total: evt.total || prev.total || 0
                      });
                      
                      // 初始化影片日志结构
                      const taskData = allTaskLogs.get(taskId);
                      if (taskData) {
                        if (!taskData.movies.has(key)) {
                          taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
                        }
                      }
                    } else if (evt.type === 'summary' && evt.kind === 'movie') {
                      // 处理summary事件，触发历史记录刷新
                      setTimeout(() => {
                        loadHistory();
                      }, 1500);
                    } else if (evt.kind === 'step') {
                      manualStepProgress = {
                        index: evt.index || 0,
                        total: evt.total || 0,
                        desc: evt.desc || ''
                      };
                      // 更新当前影片的步骤信息
                      let key = manualCurrentMovieKey;
                      // 如果没有当前影片key，使用默认key
                      if (!key) {
                        key = '__DEFAULT__';
                        manualCurrentMovieKey = key;
                      }
                      
                      const prev = manualMovieStates[key] || {};
                      manualMovieStates[key] = Object.assign({}, prev, {
                        stepIndex: evt.index || prev.stepIndex || 0,
                        stepTotal: evt.total || prev.stepTotal || 0,
                        stepDesc: evt.desc || prev.stepDesc || '',
                        status: 'RUNNING'
                      });
                      
                      // 初始化步骤日志结构
                      const taskData = allTaskLogs.get(taskId);
                      if (taskData) {
                        if (!taskData.movies.has(key)) {
                          taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
                        }
                        const movieData = taskData.movies.get(key);
                        const stepIndex = evt.index || 0;
                        if (stepIndex > 0 && !movieData.steps.has(stepIndex)) {
                          movieData.steps.set(stepIndex, { desc: evt.desc || '', logs: [] });
                        }
                      }
                    }
                  }
                } catch (e) {
                  // 解析失败，作为普通日志继续处理
                }
                // JAVSP_EVENT 行不显示在日志中，直接跳过
                return;
              }

              // 提取任务输入路径
              const taskData = allTaskLogs.get(taskId);
              if (taskData && !taskData.inputPath) {
                // 从任务信息中提取输入路径
                if (line.indexOf('任务') !== -1 && (line.indexOf('已启动') !== -1 || line.indexOf('已创建') !== -1)) {
                  const match = line.match(/目录[：:]\s*(.+)/);
                  if (match) {
                    taskData.inputPath = match[1].trim();
                  } else {
                    // 尝试从其他格式提取
                    const match2 = line.match(/：\s*(.+\.mp4|.+\.mkv|\/video\/.+)/);
                    if (match2) {
                      taskData.inputPath = match2[1].trim();
                    }
                  }
                }
              }
              
              // 提取保存路径
              if (manualCurrentMovieKey && (line.indexOf('整理完成，相关文件已保存到:') !== -1 || line.indexOf('刮削完成，相关文件已保存到:') !== -1)) {
                const key = manualCurrentMovieKey;
                const prev = manualMovieStates[key] || {};
                manualMovieStates[key] = Object.assign({}, prev, {
                  lastLog: line,
                  status: 'SUCCEEDED'
                });
                
                // 提取保存路径
                const match = line.match(/已保存到[：:]\s*(.+)/);
                if (match && taskData) {
                  const saveDir = match[1].trim();
                  if (!taskData.movies.has(key)) {
                    taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
                  }
                  const movieData = taskData.movies.get(key);
                  movieData.saveDir = saveDir;
                }
              }

              // 分类日志：按步骤组织，错误日志单独存储
              let key = manualCurrentMovieKey;
              
              // 如果没有当前影片key，尝试从"正在整理:"行中提取
              if (!key && line.indexOf('正在整理:') !== -1) {
                const idx = line.indexOf('正在整理:');
                const rest = line.slice(idx + '正在整理:'.length).trim();
                const firstPart = rest.split(',')[0].trim();
                const filename = firstPart.split(/[\\/]/).pop() || firstPart;
                const dotIndex = filename.lastIndexOf('.');
                const movieId = dotIndex > 0 ? filename.slice(0, dotIndex) : filename;
                if (movieId) {
                  key = movieId;
                  manualCurrentMovieKey = key;
                  // 初始化影片状态
                  if (!manualMovieStates[key]) {
                    manualMovieStates[key] = {
                      id: movieId,
                      index: 1,
                      status: 'RUNNING'
                    };
                  }
                }
              }
              
              // 如果还是没有key，使用默认key，并确保默认影片存在
              if (!key) {
                key = '__DEFAULT__';
              }
              if (taskData && !taskData.movies.has(key)) {
                taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
              }
              
              const prev = manualMovieStates[key] || {};
              
              // 判断是否为错误日志
              // 排除INFO级别的启动日志
              const isInfoStartLog = /\[INFO\].*启动 JavSP 子进程执行手动刮削任务/.test(line);
              const isError = !isInfoStartLog && /(整理失败|下载封面图片失败|下载剧照失败|任务 .+ 已失败|任务 .+ 失败|为其配置的.*个抓取器均未获取到影片信息)/.test(line);
              const isCrawlerError = /javsp\.web\..*:.*(网络错误|页面结构异常|无法绕开|访问被拒|触发反爬|均未获取到影片信息)/.test(line);
              const isDownloadError = /(下载.*失败|下载.*错误|.*\.jpg.*失败|.*\.png.*失败)/.test(line);
              
              // 存储到 allTaskLogs
              if (taskData && key !== '__TASK__') {
                if (!taskData.movies.has(key)) {
                  taskData.movies.set(key, { steps: new Map(), errors: [], saveDir: '' });
                }
                const movieData = taskData.movies.get(key);
                
                // 判断当前步骤 - 优先从日志内容中提取步骤信息
                let currentStepIndex = null;
                
                // 尝试从日志内容中提取步骤信息（例如：[步骤 4/7]）
                const stepMatch = line.match(/\[步骤\s+(\d+)\/7\]/);
                if (stepMatch) {
                  const stepNum = parseInt(stepMatch[1], 10);
                  currentStepIndex = stepNum;
                  // 更新当前步骤信息
                  manualMovieStates[key] = Object.assign({}, prev, {
                    stepIndex: stepNum,
                    stepTotal: 7,
                    stepDesc: stepMatch[0] || prev.stepDesc || ''
                  });
                  // 更新 prev 以便后续使用
                  prev.stepIndex = stepNum;
                  prev.stepTotal = 7;
                  // 若当前影片未定位，尝试将该步骤日志同步到所有已存在的影片（用于页面刷新后的日志还原）
                  if (!manualCurrentMovieKey && taskData && taskData.movies.size > 0) {
                    taskData.movies.forEach((mv) => {
                      if (!mv.steps.has(stepNum)) mv.steps.set(stepNum, { desc: prev.stepDesc || '', logs: [] });
                      mv.steps.get(stepNum).logs.push(line);
                    });
                  }
                } else if (line.indexOf('[队列]') !== -1) {
                  // 排队相关日志强制归类到步骤1
                  currentStepIndex = 1;
                  manualMovieStates[key] = Object.assign({}, prev, {
                    stepIndex: 1,
                    stepTotal: 7,
                    stepDesc: '启动并发任务'
                  });
                } else if (/任务 #.*已启动/.test(line) || /启动 JavSP 子进程执行手动刮削任务/.test(line)) {
                  // 任务启动相关日志也归类到步骤1
                  currentStepIndex = 1;
                  manualMovieStates[key] = Object.assign({}, prev, {
                    stepIndex: 1,
                    stepTotal: 7,
                    stepDesc: '启动并发任务'
                  });
                } else if (prev.stepIndex && prev.stepTotal) {
                  // 如果没有从日志中提取到，使用之前记录的步骤信息
                  currentStepIndex = prev.stepIndex;
                }
                
                // 检查日志是否已存在于对应步骤中（去重）
                const isDuplicate = (stepIndex) => {
                  if (!movieData.steps.has(stepIndex)) return false;
                  const stepLogs = movieData.steps.get(stepIndex).logs;
                  return stepLogs.some(log => log === line || log.trim() === line.trim());
                };
                
                if (isError || isCrawlerError || isDownloadError) {
                  // 错误日志 - 检查是否重复
                  if (!movieData.errors.some(err => err === line || err.trim() === line.trim())) {
                    movieData.errors.push(line);
                  }
                } else if (currentStepIndex) {
                  // 普通日志按步骤存储
                  if (!movieData.steps.has(currentStepIndex)) {
                    movieData.steps.set(currentStepIndex, { desc: prev.stepDesc || '', logs: [] });
                  }
                  // 检查是否重复
                  if (!isDuplicate(currentStepIndex)) {
                    movieData.steps.get(currentStepIndex).logs.push(line);
                  }
                } else {
                  // 没有步骤信息时，也存储到当前步骤（如果有）
                  if (prev.stepIndex) {
                    const stepIndex = prev.stepIndex;
                    if (!movieData.steps.has(stepIndex)) {
                      movieData.steps.set(stepIndex, { desc: prev.stepDesc || '', logs: [] });
                    }
                    if (!isDuplicate(stepIndex)) {
                      movieData.steps.get(stepIndex).logs.push(line);
                    }
                  } else {
                    // 如果完全没有步骤信息，存储到步骤1（启动并发任务）
                    if (!movieData.steps.has(1)) {
                      movieData.steps.set(1, { desc: '启动并发任务', logs: [] });
                    }
                    if (!isDuplicate(1)) {
                      movieData.steps.get(1).logs.push(line);
                    }
                  }
                }
              }
              
              // 仅在明显的失败标记时才将该影片置为 FAILED
              const isHardError = /(整理失败|下载封面图片失败|下载剧照失败|任务 .+ 已失败|任务 .+ 失败)/.test(line);
              const isSoftWarn = /(页面结构异常或访问被拦截|无法绕开JavLib的反爬机制)/.test(line);

              let nextLastLog = prev.lastLog || '';
              let nextStatus = prev.status || 'RUNNING';
              if (isHardError) {
                nextLastLog = line;
                nextStatus = 'FAILED';
              } else if (!isSoftWarn) {
                // 普通日志可以作为最新日志展示，但保留已有状态
                nextLastLog = line;
              }

              manualMovieStates[key] = Object.assign({}, prev, {
                lastLog: nextLastLog,
                status: nextStatus
              });
            });
            
            // 更新任务状态
            const taskData = allTaskLogs.get(taskId);
            if (taskData) {
              taskData.status = status;
            }
            renderCollapsibleLogs();
            
            // 如果任务完成，刷新历史记录
            if (status === 'SUCCEEDED' || status === 'FAILED') {
              setTimeout(() => {
                loadHistory();
              }, 2000);
            }
            
            // 如果任务完成，刷新历史记录（延迟更长时间确保后端已保存）
            if (status === 'SUCCEEDED' || status === 'FAILED') {
              setTimeout(() => {
                loadHistory();
              }, 3000);
            }

            // 不再使用xterm，日志已通过 renderCollapsibleLogs 渲染
            renderManualProgress();
            renderManualTaskTable(status);
            // 渲染可展开收起的日志
            renderCollapsibleLogs();

            // 格式化任务ID显示
            let taskIdFormatted = String(taskId);
            const parts = String(taskId).split('_');
            if (parts.length >= 3) {
              taskIdFormatted = `${parts[1]} ${parts[2]}`; // YYYYMMDD HHMMSS
            }
            manualLogStatusEl.textContent = '任务 ' + taskIdFormatted + ' 状态：' + status;
            if (manualHint) {
              manualHint.style.color = '#9ca3af';
              manualHint.textContent = '任务 ' + taskIdFormatted + ' 状态：' + status + '。';
            }
            if (status === 'SUCCEEDED' || status === 'FAILED') {
              if (manualHint) {
                if (status === 'SUCCEEDED') {
                  manualHint.style.color = '#bbf7d0';
                  manualHint.textContent = '任务 ' + taskIdFormatted + ' 已完成。';
                } else {
                  manualHint.textContent = '任务 ' + taskIdFormatted + ' 已失败，请查看下方日志。';
                }
              }
              clearInterval(manualLogTimer);
              manualLogTimer = null;
            }
          } catch (e) {
            console.warn(e);
          }
        };

        if (singleShot) {
          // 单次加载历史任务日志
          return fetchAndProcessLogs();
        }

        manualLogTimer = setInterval(fetchAndProcessLogs, 1000);
      }

      // 手动刮削规则设置按钮
      const manualRulesBtn = document.getElementById('manual-rules-btn');
      const manualRulesModal = document.getElementById('manual-rules-modal');
      const manualRulesContent = document.getElementById('manual-rules-content');
      const manualRulesSaveBtn = document.getElementById('manual-rules-save');
      const manualProfileSelect = document.getElementById('manual-profile');
      
      // 加载自定义规则列表到选择框
      async function loadManualRulesToSelect() {
        if (!manualProfileSelect) return;
        try {
          const allRules = await fetchJSON('/api/tasks/manual/rules');
          // 保留"使用当前全局规则"选项
          const defaultOption = manualProfileSelect.querySelector('option[value="default"]');
          manualProfileSelect.innerHTML = '';
          if (defaultOption) {
            manualProfileSelect.appendChild(defaultOption);
          } else {
            const opt = document.createElement('option');
            opt.value = 'default';
            opt.textContent = '使用当前全局规则';
            manualProfileSelect.appendChild(opt);
          }
          // 添加所有自定义规则
          Object.keys(allRules).forEach(ruleName => {
            const opt = document.createElement('option');
            opt.value = ruleName;
            opt.textContent = ruleName;
            manualProfileSelect.appendChild(opt);
          });
        } catch (e) {
          console.error('加载规则列表失败:', e);
        }
      }
      
      // 初始化时加载规则列表
      const manualRulesEditBtn = document.getElementById('manual-rules-edit-btn');
      if (manualProfileSelect) {
        loadManualRulesToSelect();
        // 监听规则选择变化，显示/隐藏编辑按钮
        manualProfileSelect.addEventListener('change', function() {
          if (manualRulesEditBtn) {
            manualRulesEditBtn.style.display = this.value !== 'default' ? 'inline-block' : 'none';
          }
        });
      }
      
      // 编辑规则按钮点击事件
      if (manualRulesEditBtn) {
        manualRulesEditBtn.addEventListener('click', async function() {
          const selectedRule = manualProfileSelect.value;
          if (!selectedRule || selectedRule === 'default') return;
          
          try {
            // 加载选中的规则配置
            const ruleConfig = await fetchJSON(`/api/tasks/manual/rules/${encodeURIComponent(selectedRule)}`);
            const globalRules = await fetchJSON('/api/rules/global');
            
            // 克隆整个规则布局（包括侧边栏和主内容区）
            const rulesLayout = document.querySelector('.rules-layout');
            if (rulesLayout && manualRulesContent) {
              const clonedLayout = rulesLayout.cloneNode(true);
              clonedLayout.id = 'manual-rules-layout';
              clonedLayout.style.display = 'flex';
              
              // 更新所有ID，添加manual-前缀避免冲突
              const allElements = clonedLayout.querySelectorAll('[id]');
              allElements.forEach(el => {
                if (el.id && !el.id.startsWith('manual-')) {
                  el.id = 'manual-' + el.id;
                }
              });
              
              // 更新所有chips容器的data-chips属性
              const allChipsContainers = clonedLayout.querySelectorAll('[data-chips]');
              allChipsContainers.forEach(container => {
                const chipsAttr = container.getAttribute('data-chips');
                if (chipsAttr && !chipsAttr.startsWith('manual-')) {
                  container.setAttribute('data-chips', 'manual-' + chipsAttr);
                }
              });
              
              manualRulesContent.innerHTML = '';
              manualRulesContent.appendChild(clonedLayout);
              
              // 为自定义规则窗口实现标签页切换逻辑
              const manualRulesTabButtons = clonedLayout.querySelectorAll('.rules-tab-btn');
              const manualRulesTabPanels = clonedLayout.querySelectorAll('.rules-tab-panel');
              if (manualRulesTabButtons.length && manualRulesTabPanels.length) {
                manualRulesTabButtons.forEach(btn => {
                  btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-rules-tab');
                    if (!target) return;

                    manualRulesTabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    manualRulesTabPanels.forEach(panel => {
                      if (panel.getAttribute('data-rules-panel') === target) {
                        panel.classList.add('active');
                      } else {
                        panel.classList.remove('active');
                      }
                    });
                  });
                });
              }
              
              // 为chips输入框添加事件处理
              const manualChipsInputs = clonedLayout.querySelectorAll('.chips-input');
              manualChipsInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                  if (e.key === 'Enter' && this.value.trim()) {
                    e.preventDefault();
                    const container = this.closest('.chips-container');
                    const list = container ? container.querySelector('.chips-list') : null;
                    if (list) {
                      const span = document.createElement('span');
                      span.className = 'chip';
                      span.textContent = this.value.trim();
                      const btn = document.createElement('button');
                      btn.type = 'button';
                      btn.className = 'chip-remove';
                      btn.textContent = '×';
                      btn.addEventListener('click', () => {
                        span.remove();
                      });
                      span.appendChild(btn);
                      list.appendChild(span);
                      this.value = '';
                    }
                  }
                });
              });
              
              // 加载规则配置到表单（优先使用规则配置，如果没有则使用全局规则作为默认值）
              const clonedRulesMain = clonedLayout.querySelector('.rules-main');
              if (clonedRulesMain) {
                // 先加载全局规则作为基础
                await loadRulesToForm(clonedRulesMain, globalRules, 'manual-');
                // 再加载规则配置覆盖
                await loadRulesToForm(clonedRulesMain, ruleConfig, 'manual-');
              }
              
              // 设置规则名称输入框
              const ruleNameInput = document.getElementById('manual-rule-name');
              if (ruleNameInput) {
                ruleNameInput.value = selectedRule;
                ruleNameInput.readOnly = true;
                ruleNameInput.style.backgroundColor = '#111827';
                ruleNameInput.style.color = '#9ca3af';
              }
            }
            
            // 更新模态框标题
            const modalTitle = manualRulesModal.querySelector('.panel-title');
            if (modalTitle) {
              modalTitle.textContent = '编辑自定义规则';
            }
            
            manualRulesModal.style.display = 'flex';
          } catch (e) {
            console.error('加载规则失败:', e);
            window.showAlert('加载规则失败，请稍后重试');
          }
        });
      }
      
      if (manualRulesBtn && manualRulesModal) {
        manualRulesBtn.addEventListener('click', async function() {
          try {
            const globalRules = await fetchJSON('/api/rules/global');
            
            // 克隆整个规则布局（包括侧边栏和主内容区）
            const rulesLayout = document.querySelector('.rules-layout');
            if (rulesLayout && manualRulesContent) {
              const clonedLayout = rulesLayout.cloneNode(true);
              clonedLayout.id = 'manual-rules-layout';
              clonedLayout.style.display = 'flex';
              
              // 更新所有ID，添加manual-前缀避免冲突
              const allElements = clonedLayout.querySelectorAll('[id]');
              allElements.forEach(el => {
                if (el.id && !el.id.startsWith('manual-')) {
                  el.id = 'manual-' + el.id;
                }
              });
              
              // 更新所有label的for属性
              const allLabels = clonedLayout.querySelectorAll('label[for]');
              allLabels.forEach(label => {
                const forAttr = label.getAttribute('for');
                if (forAttr && !forAttr.startsWith('manual-')) {
                  label.setAttribute('for', 'manual-' + forAttr);
                }
              });
              
              // 更新所有chips容器的data-chips属性
              const allChipsContainers = clonedLayout.querySelectorAll('[data-chips]');
              allChipsContainers.forEach(container => {
                const chipsAttr = container.getAttribute('data-chips');
                if (chipsAttr && !chipsAttr.startsWith('manual-')) {
                  container.setAttribute('data-chips', 'manual-' + chipsAttr);
                }
              });
              
              manualRulesContent.innerHTML = '';
              manualRulesContent.appendChild(clonedLayout);
              
              // 为自定义规则窗口实现标签页切换逻辑
              const manualRulesTabButtons = clonedLayout.querySelectorAll('.rules-tab-btn');
              const manualRulesTabPanels = clonedLayout.querySelectorAll('.rules-tab-panel');
              if (manualRulesTabButtons.length && manualRulesTabPanels.length) {
                manualRulesTabButtons.forEach(btn => {
                  btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-rules-tab');
                    if (!target) return;

                    manualRulesTabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    manualRulesTabPanels.forEach(panel => {
                      if (panel.getAttribute('data-rules-panel') === target) {
                        panel.classList.add('active');
                      } else {
                        panel.classList.remove('active');
                      }
                    });
                  });
                });
              }
              
              // 为chips输入框添加事件处理
              const manualChipsInputs = clonedLayout.querySelectorAll('.chips-input');
              manualChipsInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                  if (e.key === 'Enter' && this.value.trim()) {
                    e.preventDefault();
                    const container = this.closest('.chips-container');
                    const list = container ? container.querySelector('.chips-list') : null;
                    if (list) {
                      const span = document.createElement('span');
                      span.className = 'chip';
                      span.textContent = this.value.trim();
                      const btn = document.createElement('button');
                      btn.type = 'button';
                      btn.className = 'chip-remove';
                      btn.textContent = '×';
                      btn.addEventListener('click', () => {
                        span.remove();
                      });
                      span.appendChild(btn);
                      list.appendChild(span);
                      this.value = '';
                    }
                  }
                });
              });
              
              // 加载全局规则值到表单（作为默认值）
              const clonedRulesMain = clonedLayout.querySelector('.rules-main');
              if (clonedRulesMain) {
                await loadRulesToForm(clonedRulesMain, globalRules, 'manual-');
              }
              
              // 清空规则名称输入框
              const ruleNameInput = document.getElementById('manual-rule-name');
              if (ruleNameInput) {
                ruleNameInput.value = '';
                ruleNameInput.readOnly = false;
                ruleNameInput.style.backgroundColor = '';
                ruleNameInput.style.color = '';
              }
              
              // 更新模态框标题
              const modalTitle = manualRulesModal.querySelector('.panel-title');
              if (modalTitle) {
                modalTitle.textContent = '添加自定义规则';
              }
            }
            
            manualRulesModal.style.display = 'flex';
          } catch (e) {
            console.error('加载规则失败:', e);
            window.showAlert('加载规则失败，请稍后重试');
          }
        });
      }
      
      // 辅助函数：加载规则到表单（复用全局规则的加载逻辑）
      async function loadRulesToForm(formElement, rulesData, prefix = '') {
        const scanner = rulesData.scanner || {};
        const network = rulesData.network || {};
        const crawler = rulesData.crawler || {};
        const summarizer = rulesData.summarizer || {};
        const pathCfg = summarizer.path || {};
        const defaultCfg = summarizer.default || {};
        const titleCfg = summarizer.title || {};
        const nfoCfg = summarizer.nfo || {};
        const coverCfg = summarizer.cover || {};
        const cropCfg = coverCfg.crop || {};
        const extraFanarts = summarizer.extra_fanarts || {};
        const translator = rulesData.translator || {};
        const translateFields = translator.fields || {};
        const translateEngine = translator.engine || null;
        
        // 扫描设置
        const scannerMinimumSize = formElement.querySelector('#' + prefix + 'rules-scanner-minimum-size');
        if (scannerMinimumSize && scanner.minimum_size != null) {
          const m = /^([0-9]+)MiB$/i.exec(String(scanner.minimum_size));
          scannerMinimumSize.value = m ? m[1] : '';
        }
        
        // chips初始化函数
        function initChips(listEl, values) {
          if (!listEl) return;
          listEl.innerHTML = '';
          (values || []).forEach(v => {
            const span = document.createElement('span');
            span.className = 'chip';
            span.textContent = v;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'chip-remove';
            btn.textContent = '×';
            btn.addEventListener('click', () => {
              span.remove();
            });
            span.appendChild(btn);
            listEl.appendChild(span);
          });
        }
        
        const chipsScannerIgnoredIdList = formElement.querySelector('#' + prefix + 'chips-scanner-ignored-id');
        const chipsScannerIgnoredFoldersList = formElement.querySelector('#' + prefix + 'chips-scanner-ignored-folders');
        const chipsScannerExtensionsList = formElement.querySelector('#' + prefix + 'chips-scanner-extensions');
        initChips(chipsScannerIgnoredIdList, Array.isArray(scanner.ignored_id_pattern) ? scanner.ignored_id_pattern : []);
        initChips(chipsScannerIgnoredFoldersList, Array.isArray(scanner.ignored_folder_name_pattern) ? scanner.ignored_folder_name_pattern : []);
        initChips(chipsScannerExtensionsList, Array.isArray(scanner.filename_extensions) ? scanner.filename_extensions : []);
        
        const scannerSkipNfo = formElement.querySelector('#' + prefix + 'rules-scanner-skip-nfo');
        if (scannerSkipNfo && Object.prototype.hasOwnProperty.call(scanner, 'skip_nfo_dir')) {
          scannerSkipNfo.checked = !!scanner.skip_nfo_dir;
        }
        
        // 网络设置
        const networkProxy = formElement.querySelector('#' + prefix + 'rules-network-proxy');
        if (networkProxy) networkProxy.value = network.proxy_server || '';
        const networkRetry = formElement.querySelector('#' + prefix + 'rules-network-retry');
        if (networkRetry && network.retry != null) networkRetry.value = String(network.retry);
        const networkTimeout = formElement.querySelector('#' + prefix + 'rules-network-timeout');
        if (networkTimeout && network.timeout != null) {
          const m2 = /^PT([0-9]+)S$/i.exec(String(network.timeout));
          networkTimeout.value = m2 ? m2[1] : '';
        }
        
        // 爬虫设置
        const crawlerRequiredKeys = formElement.querySelector('#' + prefix + 'rules-crawler-required-keys');
        if (crawlerRequiredKeys && Array.isArray(crawler.required_keys)) {
          crawlerRequiredKeys.value = crawler.required_keys.join(',');
        }
        const crawlerHardworking = formElement.querySelector('#' + prefix + 'rules-crawler-hardworking');
        if (crawlerHardworking) crawlerHardworking.checked = !!crawler.hardworking;
        const crawlerRespectId = formElement.querySelector('#' + prefix + 'rules-crawler-respect-id');
        if (crawlerRespectId) crawlerRespectId.checked = !!crawler.respect_site_avid;
        const crawlerUseJavdbCover = formElement.querySelector('#' + prefix + 'rules-crawler-use-javdb-cover');
        if (crawlerUseJavdbCover && crawler.use_javdb_cover) {
          crawlerUseJavdbCover.value = String(crawler.use_javdb_cover);
        }
        const crawlerNormalizeActress = formElement.querySelector('#' + prefix + 'rules-crawler-normalize-actress');
        if (crawlerNormalizeActress) crawlerNormalizeActress.checked = !!crawler.normalize_actress_name;
        const crawlerFc2fanPath = formElement.querySelector('#' + prefix + 'rules-crawler-fc2fan-path');
        if (crawlerFc2fanPath && Object.prototype.hasOwnProperty.call(crawler, 'fc2fan_local_path')) {
          crawlerFc2fanPath.value = crawler.fc2fan_local_path || '';
        }
        const crawlerSleepAfter = formElement.querySelector('#' + prefix + 'rules-crawler-sleep-after');
        if (crawlerSleepAfter && crawler.sleep_after_scraping != null) {
          crawlerSleepAfter.value = String(crawler.sleep_after_scraping);
        }
        
        const selection = crawler.selection || {};
        const chipsCrawlerSelectionNormalList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-normal');
        const chipsCrawlerSelectionFc2List = formElement.querySelector('#' + prefix + 'chips-crawler-selection-fc2');
        const chipsCrawlerSelectionCidList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-cid');
        const chipsCrawlerSelectionGetchuList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-getchu');
        const chipsCrawlerSelectionGyuttoList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-gyutto');
        initChips(chipsCrawlerSelectionNormalList, Array.isArray(selection.normal) ? selection.normal : []);
        initChips(chipsCrawlerSelectionFc2List, Array.isArray(selection.fc2) ? selection.fc2 : []);
        initChips(chipsCrawlerSelectionCidList, Array.isArray(selection.cid) ? selection.cid : []);
        initChips(chipsCrawlerSelectionGetchuList, Array.isArray(selection.getchu) ? selection.getchu : []);
        initChips(chipsCrawlerSelectionGyuttoList, Array.isArray(selection.gyutto) ? selection.gyutto : []);
        
        // 整理与路径
        const summarizerMoveFiles = formElement.querySelector('#' + prefix + 'rules-summarizer-move-files');
        if (summarizerMoveFiles) summarizerMoveFiles.checked = !!summarizer.move_files;
        const pathOutput = formElement.querySelector('#' + prefix + 'rules-path-output');
        if (pathOutput && pathCfg.output_folder_pattern != null) pathOutput.value = pathCfg.output_folder_pattern;
        const pathBasename = formElement.querySelector('#' + prefix + 'rules-path-basename');
        if (pathBasename && pathCfg.basename_pattern != null) pathBasename.value = pathCfg.basename_pattern;
        const pathLengthMax = formElement.querySelector('#' + prefix + 'rules-path-length-max');
        if (pathLengthMax && pathCfg.length_maximum != null) pathLengthMax.value = String(pathCfg.length_maximum);
        const pathLengthByByte = formElement.querySelector('#' + prefix + 'rules-path-length-by-byte');
        if (pathLengthByByte) pathLengthByByte.checked = !!pathCfg.length_by_byte;
        const pathMaxActress = formElement.querySelector('#' + prefix + 'rules-path-max-actress');
        if (pathMaxActress && pathCfg.max_actress_count != null) pathMaxActress.value = String(pathCfg.max_actress_count);
        const pathHardLink = formElement.querySelector('#' + prefix + 'rules-path-hard-link');
        if (pathHardLink) pathHardLink.checked = !!pathCfg.hard_link;
        
        // 标题与默认值
        const titleRemoveActor = formElement.querySelector('#' + prefix + 'rules-title-remove-actor');
        if (titleRemoveActor) titleRemoveActor.checked = !!titleCfg.remove_trailing_actor_name;
        const defaultTitle = formElement.querySelector('#' + prefix + 'rules-default-title');
        if (defaultTitle && defaultCfg.title != null) defaultTitle.value = defaultCfg.title;
        const defaultActress = formElement.querySelector('#' + prefix + 'rules-default-actress');
        if (defaultActress && defaultCfg.actress != null) defaultActress.value = defaultCfg.actress;
        const defaultSeries = formElement.querySelector('#' + prefix + 'rules-default-series');
        if (defaultSeries && defaultCfg.series != null) defaultSeries.value = defaultCfg.series;
        const defaultDirector = formElement.querySelector('#' + prefix + 'rules-default-director');
        if (defaultDirector && defaultCfg.director != null) defaultDirector.value = defaultCfg.director;
        const defaultProducer = formElement.querySelector('#' + prefix + 'rules-default-producer');
        if (defaultProducer && defaultCfg.producer != null) defaultProducer.value = defaultCfg.producer;
        const defaultPublisher = formElement.querySelector('#' + prefix + 'rules-default-publisher');
        if (defaultPublisher && defaultCfg.publisher != null) defaultPublisher.value = defaultCfg.publisher;
        
        // NFO
        const nfoBasename = formElement.querySelector('#' + prefix + 'rules-nfo-basename');
        if (nfoBasename && nfoCfg.basename_pattern != null) nfoBasename.value = nfoCfg.basename_pattern;
        const nfoTitle = formElement.querySelector('#' + prefix + 'rules-nfo-title');
        if (nfoTitle && nfoCfg.title_pattern != null) nfoTitle.value = nfoCfg.title_pattern;
        const nfoGenres = formElement.querySelector('#' + prefix + 'rules-nfo-genres');
        if (nfoGenres && Array.isArray(nfoCfg.custom_genres_fields)) {
          nfoGenres.value = nfoCfg.custom_genres_fields.join('\n');
        }
        const nfoTags = formElement.querySelector('#' + prefix + 'rules-nfo-tags');
        if (nfoTags && Array.isArray(nfoCfg.custom_tags_fields)) {
          nfoTags.value = nfoCfg.custom_tags_fields.join('\n');
        }
        const censorTexts = formElement.querySelector('#' + prefix + 'rules-censor-texts');
        if (censorTexts && Array.isArray(summarizer.censor_options_representation)) {
          censorTexts.value = summarizer.censor_options_representation.join(',');
        }
        
        // 封面与剧照
        const coverBasename = formElement.querySelector('#' + prefix + 'rules-cover-basename');
        if (coverBasename && coverCfg.basename_pattern != null) coverBasename.value = coverCfg.basename_pattern;
        const coverHighres = formElement.querySelector('#' + prefix + 'rules-cover-highres');
        if (coverHighres) coverHighres.checked = !!coverCfg.highres;
        const coverAddLabel = formElement.querySelector('#' + prefix + 'rules-cover-add-label');
        if (coverAddLabel) coverAddLabel.checked = !!coverCfg.add_label;
        const extraFanartsEnabled = formElement.querySelector('#' + prefix + 'rules-extra-fanarts-enabled');
        if (extraFanartsEnabled) extraFanartsEnabled.checked = !!extraFanarts.enabled;
        const extraFanartsInterval = formElement.querySelector('#' + prefix + 'rules-extra-fanarts-interval');
        if (extraFanartsInterval && extraFanarts.scrap_interval != null) {
          extraFanartsInterval.value = extraFanarts.scrap_interval;
        }
        const fanartBasename = formElement.querySelector('#' + prefix + 'rules-fanart-basename');
        if (fanartBasename && summarizer.fanart && summarizer.fanart.basename_pattern != null) {
          fanartBasename.value = summarizer.fanart.basename_pattern;
        }
        
        // 翻译设置
        const translateTitle = formElement.querySelector('#' + prefix + 'rules-translate-title');
        if (translateTitle) translateTitle.checked = !!translateFields.title;
        const translatePlot = formElement.querySelector('#' + prefix + 'rules-translate-plot');
        if (translatePlot) translatePlot.checked = !!translateFields.plot;
        const translateEngineEl = formElement.querySelector('#' + prefix + 'rules-translate-engine');
        if (translateEngineEl && translateEngine) {
          const engineName = translateEngine.name ? translateEngine.name : 'disabled';
          translateEngineEl.value = engineName;
          
          // 加载翻译引擎的详细配置
          if (engineName === 'baidu') {
            const baiduAppId = formElement.querySelector('#' + prefix + 'rules-translate-baidu-appid');
            const baiduApiKey = formElement.querySelector('#' + prefix + 'rules-translate-baidu-apikey');
            if (baiduAppId && translateEngine.app_id != null) baiduAppId.value = translateEngine.app_id;
            if (baiduApiKey && translateEngine.api_key != null) baiduApiKey.value = translateEngine.api_key;
          } else if (engineName === 'bing') {
            const bingApiKey = formElement.querySelector('#' + prefix + 'rules-translate-bing-apikey');
            if (bingApiKey && translateEngine.api_key != null) bingApiKey.value = translateEngine.api_key;
          } else if (engineName === 'claude') {
            const claudeApiKey = formElement.querySelector('#' + prefix + 'rules-translate-claude-apikey');
            if (claudeApiKey && translateEngine.api_key != null) claudeApiKey.value = translateEngine.api_key;
          } else if (engineName === 'openai') {
            const openaiUrl = formElement.querySelector('#' + prefix + 'rules-translate-openai-url');
            const openaiApiKey = formElement.querySelector('#' + prefix + 'rules-translate-openai-apikey');
            const openaiModel = formElement.querySelector('#' + prefix + 'rules-translate-openai-model');
            if (openaiUrl && translateEngine.url != null) openaiUrl.value = String(translateEngine.url);
            if (openaiApiKey && translateEngine.api_key != null) openaiApiKey.value = translateEngine.api_key;
            if (openaiModel && translateEngine.model != null) openaiModel.value = translateEngine.model;
          }
        }
      }
      
      // 保存手动规则
      if (manualRulesSaveBtn) {
        manualRulesSaveBtn.addEventListener('click', async function() {
          try {
            const ruleNameInput = document.getElementById('manual-rule-name');
            if (!ruleNameInput || !ruleNameInput.value.trim()) {
              window.showAlert('请输入规则名称', '提示');
              return;
            }
            
            const ruleName = ruleNameInput.value.trim();
            const manualRulesLayout = document.getElementById('manual-rules-layout');
            if (!manualRulesLayout) {
              window.showAlert('规则表单未加载，请刷新页面重试');
              return;
            }
            
            // 收集规则数据（复用全局规则的收集逻辑）
            const manualRulesMain = manualRulesLayout.querySelector('.rules-main');
            if (!manualRulesMain) {
              window.showAlert('规则表单未加载，请刷新页面重试');
              return;
            }
            const payload = collectRulesFromForm(manualRulesMain, 'manual-');
            
            // 保存规则（包含名称和配置）
            await fetchJSON('/api/tasks/manual/rules', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: ruleName,
                config: payload
              })
            });
            
            manualRulesModal.style.display = 'none';
            await loadManualRulesToSelect();
            // 如果编辑的是当前选中的规则，保持选中状态
            if (manualProfileSelect.value === ruleName) {
              manualProfileSelect.value = ruleName;
            }
            // 更新编辑按钮显示状态
            if (manualRulesEditBtn) {
              manualRulesEditBtn.style.display = manualProfileSelect.value !== 'default' ? 'inline-block' : 'none';
            }
            window.showAlert(`规则"${ruleName}"已保存，可在"任务规则预设"中选择使用`);
          } catch (e) {
            console.error('保存手动规则失败:', e);
            window.showAlert('保存失败：' + (e.message || '请稍后重试'));
          }
        });
      }
      
      // 辅助函数：从表单收集规则数据（复用全局规则的收集逻辑）
      function collectRulesFromForm(formElement, prefix = '') {
        const payload = {};
        
        // scanner
        const scannerMinimumSize = formElement.querySelector('#' + prefix + 'rules-scanner-minimum-size');
        if (scannerMinimumSize) {
          const size = scannerMinimumSize.value.trim();
          if (size !== '' && !Number.isNaN(Number(size))) {
            payload.scanner = payload.scanner || {};
            payload.scanner.minimum_size = `${size}MiB`;
          }
        }
        
        function collectChips(listEl) {
          if (!listEl) return [];
          const arr = [];
          listEl.querySelectorAll('.chip').forEach(span => {
            if (span.firstChild && span.firstChild.nodeType === Node.TEXT_NODE) {
              const v = span.firstChild.textContent || '';
              const t = v.trim();
              if (t) arr.push(t);
            }
          });
          return arr;
        }
        
        const chipsScannerIgnoredIdList = formElement.querySelector('#' + prefix + 'chips-scanner-ignored-id');
        const chipsScannerIgnoredFoldersList = formElement.querySelector('#' + prefix + 'chips-scanner-ignored-folders');
        const chipsScannerExtensionsList = formElement.querySelector('#' + prefix + 'chips-scanner-extensions');
        const ignoredIds = collectChips(chipsScannerIgnoredIdList);
        const ignoredFolders = collectChips(chipsScannerIgnoredFoldersList);
        const extList = collectChips(chipsScannerExtensionsList);
        if (ignoredIds.length > 0) {
          payload.scanner = payload.scanner || {};
          payload.scanner.ignored_id_pattern = ignoredIds;
        }
        if (ignoredFolders.length > 0) {
          payload.scanner = payload.scanner || {};
          payload.scanner.ignored_folder_name_pattern = ignoredFolders;
        }
        if (extList.length > 0) {
          payload.scanner = payload.scanner || {};
          payload.scanner.filename_extensions = extList;
        }
        
        const scannerSkipNfo = formElement.querySelector('#' + prefix + 'rules-scanner-skip-nfo');
        if (scannerSkipNfo) {
          payload.scanner = payload.scanner || {};
          payload.scanner.skip_nfo_dir = !!scannerSkipNfo.checked;
        }
        
        // network
        const networkProxy = formElement.querySelector('#' + prefix + 'rules-network-proxy');
        if (networkProxy) {
          const proxy = networkProxy.value.trim();
          if (proxy !== '') {
            payload.network = payload.network || {};
            payload.network.proxy_server = proxy;
          }
        }
        const networkRetry = formElement.querySelector('#' + prefix + 'rules-network-retry');
        if (networkRetry) {
          const r = networkRetry.value.trim();
          if (r !== '' && !Number.isNaN(Number(r))) {
            payload.network = payload.network || {};
            payload.network.retry = Number(r);
          }
        }
        const networkTimeout = formElement.querySelector('#' + prefix + 'rules-network-timeout');
        if (networkTimeout) {
          const t = networkTimeout.value.trim();
          if (t !== '' && !Number.isNaN(Number(t))) {
            payload.network = payload.network || {};
            payload.network.timeout = `PT${t}S`;
          }
        }
        
        // crawler
        const crawlerRequiredKeys = formElement.querySelector('#' + prefix + 'rules-crawler-required-keys');
        if (crawlerRequiredKeys) {
          const v = crawlerRequiredKeys.value.trim();
          if (v !== '') {
            const keys = v.split(',').map(s => s.trim()).filter(Boolean);
            if (keys.length > 0) {
              payload.crawler = payload.crawler || {};
              payload.crawler.required_keys = keys;
            }
          }
        }
        const crawlerHardworking = formElement.querySelector('#' + prefix + 'rules-crawler-hardworking');
        if (crawlerHardworking) {
          payload.crawler = payload.crawler || {};
          payload.crawler.hardworking = !!crawlerHardworking.checked;
        }
        const crawlerRespectId = formElement.querySelector('#' + prefix + 'rules-crawler-respect-id');
        if (crawlerRespectId) {
          payload.crawler = payload.crawler || {};
          payload.crawler.respect_site_avid = !!crawlerRespectId.checked;
        }
        const crawlerUseJavdbCover = formElement.querySelector('#' + prefix + 'rules-crawler-use-javdb-cover');
        if (crawlerUseJavdbCover) {
          const v = crawlerUseJavdbCover.value.trim();
          if (v) {
            payload.crawler = payload.crawler || {};
            payload.crawler.use_javdb_cover = v;
          }
        }
        const crawlerNormalizeActress = formElement.querySelector('#' + prefix + 'rules-crawler-normalize-actress');
        if (crawlerNormalizeActress) {
          payload.crawler = payload.crawler || {};
          payload.crawler.normalize_actress_name = !!crawlerNormalizeActress.checked;
        }
        const crawlerFc2fanPath = formElement.querySelector('#' + prefix + 'rules-crawler-fc2fan-path');
        if (crawlerFc2fanPath) {
          const p = crawlerFc2fanPath.value.trim();
          if (p !== '') {
            payload.crawler = payload.crawler || {};
            payload.crawler.fc2fan_local_path = p;
          }
        }
        const crawlerSleepAfter = formElement.querySelector('#' + prefix + 'rules-crawler-sleep-after');
        if (crawlerSleepAfter) {
          const slp = crawlerSleepAfter.value.trim();
          if (slp !== '') {
            payload.crawler = payload.crawler || {};
            payload.crawler.sleep_after_scraping = slp;
          }
        }
        
        const chipsCrawlerSelectionNormalList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-normal');
        const chipsCrawlerSelectionFc2List = formElement.querySelector('#' + prefix + 'chips-crawler-selection-fc2');
        const chipsCrawlerSelectionCidList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-cid');
        const chipsCrawlerSelectionGetchuList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-getchu');
        const chipsCrawlerSelectionGyuttoList = formElement.querySelector('#' + prefix + 'chips-crawler-selection-gyutto');
        const selNormal = collectChips(chipsCrawlerSelectionNormalList);
        const selFc2 = collectChips(chipsCrawlerSelectionFc2List);
        const selCid = collectChips(chipsCrawlerSelectionCidList);
        const selGetchu = collectChips(chipsCrawlerSelectionGetchuList);
        const selGyutto = collectChips(chipsCrawlerSelectionGyuttoList);
        if (selNormal.length || selFc2.length || selCid.length || selGetchu.length || selGyutto.length) {
          payload.crawler = payload.crawler || {};
          payload.crawler.selection = {};
          if (selNormal.length) payload.crawler.selection.normal = selNormal;
          if (selFc2.length) payload.crawler.selection.fc2 = selFc2;
          if (selCid.length) payload.crawler.selection.cid = selCid;
          if (selGetchu.length) payload.crawler.selection.getchu = selGetchu;
          if (selGyutto.length) payload.crawler.selection.gyutto = selGyutto;
        }
        
        // summarizer.move_files & path
        const summarizerMoveFiles = formElement.querySelector('#' + prefix + 'rules-summarizer-move-files');
        if (summarizerMoveFiles) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.move_files = !!summarizerMoveFiles.checked;
        }
        const pathOutput = formElement.querySelector('#' + prefix + 'rules-path-output');
        if (pathOutput) {
          const v = pathOutput.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.output_folder_pattern = v;
          }
        }
        const pathBasename = formElement.querySelector('#' + prefix + 'rules-path-basename');
        if (pathBasename) {
          const v = pathBasename.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.basename_pattern = v;
          }
        }
        const pathLengthMax = formElement.querySelector('#' + prefix + 'rules-path-length-max');
        if (pathLengthMax) {
          const v = pathLengthMax.value.trim();
          if (v !== '' && !Number.isNaN(Number(v))) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.length_maximum = Number(v);
          }
        }
        const pathLengthByByte = formElement.querySelector('#' + prefix + 'rules-path-length-by-byte');
        if (pathLengthByByte) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.path = payload.summarizer.path || {};
          payload.summarizer.path.length_by_byte = !!pathLengthByByte.checked;
        }
        const pathMaxActress = formElement.querySelector('#' + prefix + 'rules-path-max-actress');
        if (pathMaxActress) {
          const v = pathMaxActress.value.trim();
          if (v !== '' && !Number.isNaN(Number(v))) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.path = payload.summarizer.path || {};
            payload.summarizer.path.max_actress_count = Number(v);
          }
        }
        const pathHardLink = formElement.querySelector('#' + prefix + 'rules-path-hard-link');
        if (pathHardLink) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.path = payload.summarizer.path || {};
          payload.summarizer.path.hard_link = !!pathHardLink.checked;
        }
        
        // 标题与默认值
        const titleRemoveActor = formElement.querySelector('#' + prefix + 'rules-title-remove-actor');
        if (titleRemoveActor) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.title = payload.summarizer.title || {};
          payload.summarizer.title.remove_trailing_actor_name = !!titleRemoveActor.checked;
        }
        const defaultTitle = formElement.querySelector('#' + prefix + 'rules-default-title');
        if (defaultTitle) {
          const v = defaultTitle.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.title = v;
          }
        }
        const defaultActress = formElement.querySelector('#' + prefix + 'rules-default-actress');
        if (defaultActress) {
          const v = defaultActress.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.actress = v;
          }
        }
        const defaultSeries = formElement.querySelector('#' + prefix + 'rules-default-series');
        if (defaultSeries) {
          const v = defaultSeries.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.series = v;
          }
        }
        const defaultDirector = formElement.querySelector('#' + prefix + 'rules-default-director');
        if (defaultDirector) {
          const v = defaultDirector.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.director = v;
          }
        }
        const defaultProducer = formElement.querySelector('#' + prefix + 'rules-default-producer');
        if (defaultProducer) {
          const v = defaultProducer.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.producer = v;
          }
        }
        const defaultPublisher = formElement.querySelector('#' + prefix + 'rules-default-publisher');
        if (defaultPublisher) {
          const v = defaultPublisher.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.default = payload.summarizer.default || {};
            payload.summarizer.default.publisher = v;
          }
        }
        
        // NFO
        const nfoBasename = formElement.querySelector('#' + prefix + 'rules-nfo-basename');
        if (nfoBasename) {
          const v = nfoBasename.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.nfo = payload.summarizer.nfo || {};
            payload.summarizer.nfo.basename_pattern = v;
          }
        }
        const nfoTitle = formElement.querySelector('#' + prefix + 'rules-nfo-title');
        if (nfoTitle) {
          const v = nfoTitle.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.nfo = payload.summarizer.nfo || {};
            payload.summarizer.nfo.title_pattern = v;
          }
        }
        const nfoGenres = formElement.querySelector('#' + prefix + 'rules-nfo-genres');
        if (nfoGenres) {
          const lines = nfoGenres.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
          if (lines.length > 0) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.nfo = payload.summarizer.nfo || {};
            payload.summarizer.nfo.custom_genres_fields = lines;
          }
        }
        const nfoTags = formElement.querySelector('#' + prefix + 'rules-nfo-tags');
        if (nfoTags) {
          const lines = nfoTags.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
          if (lines.length > 0) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.nfo.custom_tags_fields = lines;
          }
        }
        const censorTexts = formElement.querySelector('#' + prefix + 'rules-censor-texts');
        if (censorTexts) {
          const v = censorTexts.value.split(',').map(s => s.trim()).filter(Boolean);
          if (v.length > 0) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.censor_options_representation = v;
          }
        }
        
        // cover & extra_fanarts
        const coverBasename = formElement.querySelector('#' + prefix + 'rules-cover-basename');
        if (coverBasename) {
          const v = coverBasename.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.cover = payload.summarizer.cover || {};
            payload.summarizer.cover.basename_pattern = v;
          }
        }
        const coverHighres = formElement.querySelector('#' + prefix + 'rules-cover-highres');
        if (coverHighres) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.cover = payload.summarizer.cover || {};
          payload.summarizer.cover.highres = !!coverHighres.checked;
        }
        const coverAddLabel = formElement.querySelector('#' + prefix + 'rules-cover-add-label');
        if (coverAddLabel) {
          payload.summarizer = payload.summarizer || {};
          payload.summarizer.cover = payload.summarizer.cover || {};
          payload.summarizer.cover.add_label = !!coverAddLabel.checked;
        }
        // summarizer.extra_fanarts
        const extraFanartsEnabled = formElement.querySelector('#' + prefix + 'rules-extra-fanarts-enabled');
        const extraFanartsInterval = formElement.querySelector('#' + prefix + 'rules-extra-fanarts-interval');
        if (extraFanartsEnabled || extraFanartsInterval) {
          const extra = {};
          if (extraFanartsEnabled) {
            extra.enabled = !!extraFanartsEnabled.checked;
          }
          if (extraFanartsInterval) {
            const interval = extraFanartsInterval.value.trim();
            if (interval !== '') {
              extra.scrap_interval = interval;
            }
          }
          if (Object.keys(extra).length > 0) {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.extra_fanarts = extra;
          }
        }
        
        const fanartBasename = formElement.querySelector('#' + prefix + 'rules-fanart-basename');
        if (fanartBasename) {
          const v = fanartBasename.value.trim();
          if (v !== '') {
            payload.summarizer = payload.summarizer || {};
            payload.summarizer.fanart = payload.summarizer.fanart || {};
            payload.summarizer.fanart.basename_pattern = v;
          }
        }
        
        // translator.fields
        const translateTitle = formElement.querySelector('#' + prefix + 'rules-translate-title');
        const translatePlot = formElement.querySelector('#' + prefix + 'rules-translate-plot');
        if (translateTitle || translatePlot) {
          const fields = {};
          if (translateTitle) {
            fields.title = !!translateTitle.checked;
          }
          if (translatePlot) {
            fields.plot = !!translatePlot.checked;
          }
          if (Object.keys(fields).length > 0) {
            payload.translator = payload.translator || {};
            payload.translator.fields = fields;
          }
        }
        
        // translator.engine
        const translateEngineEl = formElement.querySelector('#' + prefix + 'rules-translate-engine');
        if (translateEngineEl) {
          const engineName = translateEngineEl.value.trim();
          if (engineName && engineName !== 'disabled') {
            payload.translator = payload.translator || {};
            const engine = { name: engineName };
            
            if (engineName === 'baidu') {
              const baiduAppId = formElement.querySelector('#' + prefix + 'rules-translate-baidu-appid');
              const baiduApiKey = formElement.querySelector('#' + prefix + 'rules-translate-baidu-apikey');
              if (baiduAppId && baiduAppId.value.trim()) engine.app_id = baiduAppId.value.trim();
              if (baiduApiKey && baiduApiKey.value.trim()) engine.api_key = baiduApiKey.value.trim();
            } else if (engineName === 'bing') {
              const bingApiKey = formElement.querySelector('#' + prefix + 'rules-translate-bing-apikey');
              if (bingApiKey && bingApiKey.value.trim()) engine.api_key = bingApiKey.value.trim();
            } else if (engineName === 'claude') {
              const claudeApiKey = formElement.querySelector('#' + prefix + 'rules-translate-claude-apikey');
              if (claudeApiKey && claudeApiKey.value.trim()) engine.api_key = claudeApiKey.value.trim();
            } else if (engineName === 'openai') {
              const openaiUrl = formElement.querySelector('#' + prefix + 'rules-translate-openai-url');
              const openaiApiKey = formElement.querySelector('#' + prefix + 'rules-translate-openai-apikey');
              const openaiModel = formElement.querySelector('#' + prefix + 'rules-translate-openai-model');
              if (openaiUrl && openaiUrl.value.trim()) engine.url = openaiUrl.value.trim();
              if (openaiApiKey && openaiApiKey.value.trim()) engine.api_key = openaiApiKey.value.trim();
              if (openaiModel && openaiModel.value.trim()) engine.model = openaiModel.value.trim();
            }
            
            payload.translator.engine = engine;
          }
        }
        
        return payload;
      }
      
      document.getElementById('account-save').addEventListener('click', async function () {
        const oldPassword = document.getElementById('old-password').value;
        const newUsername = document.getElementById('new-username').value.trim() || null;
        const newPassword = document.getElementById('new-password').value;
        const errorBox = document.getElementById('account-error');
        errorBox.textContent = '';
        if (!oldPassword || !newPassword) {
          errorBox.textContent = '当前密码和新密码不能为空。';
          return;
        }
        try {
          await fetchJSON('/api/auth/password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              old_password: oldPassword,
              username: newUsername,
              password: newPassword
            })
          });
          errorBox.style.color = '#bbf7d0';
          errorBox.textContent = '修改成功，下次登录生效。';
        } catch (res) {
          errorBox.style.color = '#fca5a5';
          if (res && res.status === 400) {
            errorBox.textContent = '当前密码错误。';
          } else if (res && res.status === 401) {
            window.location.href = '/login';
          } else {
            errorBox.textContent = '修改失败，请稍后重试。';
          }
        }
      });

      // 不再使用xterm，改用可展开收起的日志结构

      switchView('manual');
      // 预加载 /video 目录，便于快速切换到"按文件刮削"视图
      if (videodeTbody) {
        loadVideode('/video');
      }
      // 检查是否有正在运行的任务，如果有则自动恢复日志流
      // 同时加载已完成任务的日志
      (async function() {
        try {
          const tasks = await fetchJSON('/api/tasks');
          if (tasks && Array.isArray(tasks)) {
            // 查找最近的一个运行中的任务
            // 加载运行中或队列中的任务
            const activeTasks = tasks.filter(t => (t.status === 'RUNNING' || t.status === 'PENDING') && t.id);
            for (const task of activeTasks) {
              if (task.id && !allTaskLogs.has(task.id)) {
                // 初始化任务日志结构
                allTaskLogs.set(task.id, {
                  inputPath: '',
                  movies: new Map(),
                  status: task.status || 'UNKNOWN'
                });
                // 自动恢复该任务的日志流，保留之前的内容
                startManualLogStreaming(task.id, true);
              }
            }
            
            // 加载已完成任务的日志（按任务ID倒序，最新的在前）
            const completedTasks = tasks
              .filter(t => (t.status === 'SUCCEEDED' || t.status === 'FAILED') && t.id)
              .sort((a, b) => (b.id || 0) - (a.id || 0))
              .slice(0, 10); // 只加载最近10个已完成的任务
            
            for (const task of completedTasks) {
              if (task.id && !allTaskLogs.has(task.id)) {
                // 初始化任务日志结构
                allTaskLogs.set(task.id, {
                  inputPath: '',
                  movies: new Map(),
                  status: task.status || 'UNKNOWN'
                });
                // 触发一次性日志加载以填充数据结构（使用更大日志窗口避免分类缺失）
                await startManualLogStreaming(task.id, true, true);
              }
            }
          }
        } catch (e) {
          console.warn('Failed to check running tasks:', e);
        }
      })();
      initUser();
      initVersion();
      
      // 移动端顶部抽屉切换
      function toggleMobileDrawer() {
        const drawer = document.getElementById('mobile-drawer');
        const overlay = document.getElementById('mobile-overlay');
        if (drawer && overlay) {
          drawer.classList.toggle('open');
          overlay.classList.toggle('show');
        }
      }
      window.toggleMobileDrawer = toggleMobileDrawer;
      
      // 移动端版本号同步
      const mobileVersion = document.getElementById('mobile-version');
      if (mobileVersion) {
        const versionEl = document.getElementById('version');
        if (versionEl) {
          mobileVersion.textContent = versionEl.textContent;
        }
      }
      
      // 移动端退出登录
      const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
      if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', () => {
          const logoutBtn = document.getElementById('logout-btn');
          if (logoutBtn) {
            logoutBtn.click();
          }
        });
      }
    })();
  </script>
</body>
</html>
